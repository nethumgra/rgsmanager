<!DOCTYPE html>
<html lang="si">
<head>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Schedule - RSG MANAGER</title>

    <link rel="icon" href="logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            min-height: 400px;
        }
        .day-column {
            min-height: 120px;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 font-sans">

    <div id="app-container" class="flex h-screen hidden">
        <aside class="w-64 bg-slate-800 p-6 flex-shrink-0 flex flex-col justify-between">
            <div>
               <div class="flex items-center gap-3 mb-10">

    <div>
        <img src="logo.png" alt="Logo" class="w-10 h-10 rounded-lg object-cover">
    </div>
    <h1 class="text-xl font-bold text-white">RSG MANAGER</h1>
</div>     <nav class="flex flex-col gap-2">
                   <a href="./index.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a>
                   <a href="./staff.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="users"></i><span>Staff Members</span></a>
                   <a href="./staff_schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition bg-slate-700 text-white"><i data-lucide="calendar"></i><span>Staff Schedule</span></a>
                   <a href="./customers.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="contact"></i><span>Customers</span></a>
                   <a href="./properties.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="home"></i><span>Properties</span></a>
                   <a href="./income_expenses.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="dollar-sign"></i><span>Income/Expenses</span></a>
                   <a href="./scheduled_finance.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="clock"></i><span>Scheduled Finance</span></a>
                   <a href="./materials.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="boxes"></i><span>Materials Stock</span></a>
                   <a href="./vehicles.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="car"></i><span>Vehicles</span></a>
                   <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>General Schedule</span></a>
                   <a href="./agreements.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-check-2"></i><span>Agreements</span></a>
                   <a href="./invoice.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-spreadsheet"></i><span>Invoices</span></a>
                   <a href="./app_access.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="key-round"></i><span>App Access</span></a>
                   <a href="./payslips.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="receipt"></i><span>Payslips</span></a>
                   <a href="./f24.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-text"></i><span>F24 Tax</span></a>
                   <a href="./agreement_generator.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-text"></i><span>Proposal Gen</span></a>
                </nav>
            </div>
            <div>
                 <button id="signOutBtn" class="w-full flex items-center justify-center gap-3 px-4 py-2 mb-4 rounded-lg transition bg-slate-700 hover:bg-red-600 text-white">
                    <i data-lucide="log-out"></i><span>Sign Out</span>
                </button>
                <div class="text-xs text-slate-500">
                     <p>&copy; 2025 RSG MANAGER ADMIN. All rights reserved.Developed By Mathizz</p>
                    <p class="mt-1">User ID: <span id="userId" class="font-mono">Loading...</span></p>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto flex flex-col">
            <section id="page-staff-schedule" class="page flex-1 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Staff Work Schedule</h2>
                </div>

                <div class="bg-slate-800 rounded-lg p-4 mb-6 flex items-end gap-4">
                     <div class="flex-1">
                        <label for="staffSearchInput" class="block mb-2 text-sm font-medium">Search Staff</label>
                        <input type="text" id="staffSearchInput" placeholder="Type name to search..." class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5 mb-2">

                        <label for="staffSelect" class="block mb-2 text-sm font-medium">Select Staff Member</label>
                        <select id="staffSelect" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                            <option value="">Loading staff...</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="prevWeekBtn" title="Previous Week" class="p-2.5 rounded-md bg-slate-700 hover:bg-slate-600"><i data-lucide="chevron-left"></i></button>
                        <button id="todayWeekBtn" title="Go to Current Week" class="px-4 py-2.5 rounded-md bg-slate-700 hover:bg-slate-600 text-sm">This Week</button>
                        <button id="nextWeekBtn" title="Next Week" class="p-2.5 rounded-md bg-slate-700 hover:bg-slate-600"><i data-lucide="chevron-right"></i></button>
                    </div>
                </div>

                <h3 id="weekRangeDisplay" class="text-xl font-semibold text-white mb-4 text-center"></h3>

                <div class="flex-1 flex flex-col bg-slate-800 rounded-lg overflow-hidden">
                    <div id="weekGridHeader" class="week-grid border-b border-slate-700" style="min-height: auto;">
                    </div>
                    <div id="weekGridBody" class="week-grid flex-1 overflow-y-auto">
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="workModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-lg transform transition-all scale-95 opacity-0" id="work-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="workModalTitle" class="text-2xl font-bold text-white">Add Work</h3>
                <button id="closeWorkModalBtn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="workForm">
                <input type="hidden" id="workDocId">

                <div class="mb-4">
                    <label for="taskTitle" class="block mb-2 text-sm font-medium">Work / Task Title</label>
                    <input type="text" id="taskTitle" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" placeholder="e.g., Clean Block A, Mow Lawn" required>
                </div>

                <div class="mb-4">
                    <label for="workCategory" class="block mb-2 text-sm font-medium">Work Category</label>
                    <select id="workCategory" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5">
                        <option value="">Select Category</option>
                        <option value="Condominium">Condominium</option>
                        <option value="Hotel B&B">Hotel B&B</option>
                        <option value="Gardners">Gardners</option>
                        <option value="Staff">Staff</option>
                        <option value="Agency">Agency</option>
                        <option value="Gym">Gym</option>
                        <option value="Laundry">Laundry</option>
                        <option value="Flat">Flat</option>
                        <option value="Pool">Pool</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div id="customerDropdownWrapper" class="mb-4 hidden">
                    <label for="customerSelect" class="block mb-2 text-sm font-medium">Select Customer</label>
                    <select id="customerSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <div id="customerItemDropdownWrapper" class="mb-4 hidden">
                    <label for="customerItemSelect" class="block mb-2 text-sm font-medium">Select Item/Location</label>
                    <select id="customerItemSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="taskDate" class="block mb-2 text-sm font-medium">Date</label>
                        <input type="date" id="taskDate" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                    </div>
                     <div>
                        <label for="taskTime" class="block mb-2 text-sm font-medium">Time</label>
                        <input type="time" id="taskTime" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="taskDescription" class="block mb-2 text-sm font-medium">Description / Notes</label>
                    <textarea id="taskDescription" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" rows="3" placeholder="Add any extra details..."></textarea>
                </div>

                <div class="flex justify-between items-center mt-8">
                     <div>
                        <button type="button" id="deleteWorkBtn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold hidden">Delete</button>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" id="cancelWorkModalBtn" class="px-6 py-2 rounded-lg bg-slate-600 hover:bg-slate-700">Cancel</button>
                        <button type="submit" id="submitWorkBtn" class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold flex items-center">
                            <span id="submitWorkBtnText">Save</span>
                            <div id="submitWorkSpinner" class="loader w-5 h-5 ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc, updateDoc, where, query, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Main App Config
        const firebaseConfig = {
             apiKey: "AIzaSyCkKqLZFM4sm5jdbR1NVhhVy9IhUeDXOWc",
            authDomain: "rsgweb-5f36d.firebaseapp.com",
            projectId: "rsgweb-5f36d",
            storageBucket: "rsgweb-5f36d.firebasestorage.app",
            messagingSenderId: "633023905515",
            appId: "1:633023905515:web:3b1ae3ebc44eefc59748ae",
        };

        // App Initialization
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let allStaff = [];
        let allStaffWork = [];
        let allCustomers = [];
        let loadedCustomerItems = [];
        let currentWeekStart = new Date();

        // DOM Elements
        const appContainer = document.getElementById('app-container');
        const signOutBtn = document.getElementById('signOutBtn');
        const userIdSpan = document.getElementById('userId');
        const toast = document.getElementById('toast');
        const staffSelect = document.getElementById('staffSelect');
        const staffSearchInput = document.getElementById('staffSearchInput');
        const weekGridHeader = document.getElementById('weekGridHeader');
        const weekGridBody = document.getElementById('weekGridBody');
        const weekRangeDisplay = document.getElementById('weekRangeDisplay');
        const prevWeekBtn = document.getElementById('prevWeekBtn');
        const nextWeekBtn = document.getElementById('nextWeekBtn');
        const todayWeekBtn = document.getElementById('todayWeekBtn');
        const workModal = document.getElementById('workModal');
        const workModalContent = document.getElementById('work-modal-content');
        const workModalTitle = document.getElementById('workModalTitle');
        const closeWorkModalBtn = document.getElementById('closeWorkModalBtn');
        const cancelWorkModalBtn = document.getElementById('cancelWorkModalBtn');
        const workForm = document.getElementById('workForm');
        const deleteWorkBtn = document.getElementById('deleteWorkBtn');
        const submitWorkBtn = document.getElementById('submitWorkBtn');
        const submitWorkBtnText = document.getElementById('submitWorkBtnText');
        const submitWorkSpinner = document.getElementById('submitWorkSpinner');
        const workCategorySelect = document.getElementById('workCategory');
        const customerDropdownWrapper = document.getElementById('customerDropdownWrapper');
        const customerSelect = document.getElementById('customerSelect');
        const customerItemDropdownWrapper = document.getElementById('customerItemDropdownWrapper');
        const customerItemSelect = document.getElementById('customerItemSelect');

        // Date Helper
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // Authentication
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdSpan.textContent = currentUserId.substring(0, 10) + '...';
                appContainer.classList.remove('hidden');
                currentWeekStart = getStartOfWeek(new Date());
                listenForStaff();
                listenForWorkSchedule();
                listenForCustomers();
            } else {
                window.location.href = './index.html';
            }
        });

        signOutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // Data Loading
        function listenForStaff() {
            if (!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/staff`), snapshot => {
                allStaff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allStaff.sort((a, b) => (a.name || 'Z').localeCompare(b.name || 'Z'));
                filterStaffDropdown(); // Initial population
                // Don't call renderWeekGrid here initially, let filterStaffDropdown handle it if needed
            }, error => {
                console.error("Error listening for staff:", error);
                showToast("Error loading staff list.", false);
            });
        }


        function listenForWorkSchedule() {
            if (!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/staff_work`), snapshot => {
                allStaffWork = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWeekGrid(); // Update grid when work changes
            }, error => {
                console.error("Error listening for work schedule:", error);
                showToast("Error loading work schedule.", false);
            });
        }

        function listenForCustomers() {
            if (!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/customers`), snapshot => {
                allCustomers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }, error => {
                console.error("Error listening for customers:", error);
                showToast("Error loading customer data.", false);
            });
        }

        // Load Customers for Selected Category
        function loadCustomersForCategory(category) {
            customerSelect.innerHTML = `<option value="">Loading Customers...</option>`;
            customerDropdownWrapper.classList.remove('hidden');
            customerItemDropdownWrapper.classList.add('hidden');
            customerItemSelect.innerHTML = '<option value="">Select Customer First</option>';

            if (!category) {
                customerSelect.innerHTML = `<option value="">Select Category First</option>`;
                customerDropdownWrapper.classList.add('hidden');
                return;
            }

            const categoryCustomers = allCustomers.filter(c => c.category === category);
            populateCustomerDropdown(category, categoryCustomers);
        }

        // Populate Customer Dropdown
        function populateCustomerDropdown(category, customers) {
            const currentVal = customerSelect.value;
            customerSelect.innerHTML = `<option value="">-- Select Customer for ${category} --</option>`;

            customers.sort((a, b) => (a.name || 'Z').localeCompare(b.name || 'Z'));

            if (customers.length === 0) {
                customerSelect.innerHTML = `<option value="">No customers found for ${category}</option>`;
                return;
            }

            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || 'Unnamed Customer';
                customerSelect.appendChild(option);
            });

            const previouslySelectedCustomerExists = customers.some(c => c.id === currentVal);
            if (previouslySelectedCustomerExists) {
                customerSelect.value = currentVal;
                loadCustomerItems(currentVal); // Auto-load items if restoring selection
            } else {
                 customerSelect.value = ""; // Clear selection if previous not found
                 customerItemDropdownWrapper.classList.add('hidden'); // Ensure item dropdown is hidden
            }
        }


        // Load Items for Selected Customer
        function loadCustomerItems(customerId) {
            customerItemSelect.innerHTML = `<option value="">Loading Items...</option>`;
            customerItemDropdownWrapper.classList.remove('hidden');
            loadedCustomerItems = [];

            if (!customerId) {
                customerItemSelect.innerHTML = `<option value="">Select Customer First</option>`;
                customerItemDropdownWrapper.classList.add('hidden');
                return;
            }

            const selectedCustomer = allCustomers.find(c => c.id === customerId);

            if (selectedCustomer && selectedCustomer.items && Array.isArray(selectedCustomer.items)) {
                loadedCustomerItems = selectedCustomer.items.map(item => ({
                    name: item.name || 'Unnamed Item'
                }));
            }

            populateCustomerItemsDropdown(loadedCustomerItems);
        }

        // Populate Dropdown with Customer Items
        function populateCustomerItemsDropdown(items) {
            const currentVal = customerItemSelect.value;
            customerItemSelect.innerHTML = `<option value="">-- Select Item/Location --</option>`;

            items.sort((a, b) => (a.name || 'Z').localeCompare(b.name || 'Z'));

            if (items.length === 0) {
                customerItemSelect.innerHTML = `<option value="">No items found for this customer</option>`;
                return;
            }

            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = item.name;
                customerItemSelect.appendChild(option);
            });

            const previouslySelectedItemExists = items.some(item => item.name === currentVal);
             if (previouslySelectedItemExists) {
                  customerItemSelect.value = currentVal;
             } else {
                  customerItemSelect.value = ""; // Clear selection if not found
             }
        }


        // Week Grid Rendering
        function renderWeekGrid() {
            const selectedStaffId = staffSelect.value;
            weekGridHeader.innerHTML = '';
            weekGridBody.innerHTML = '';

            const startDate = new Date(currentWeekStart);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            weekRangeDisplay.textContent = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;

            const weekWork = allStaffWork.filter(work => {
                if (work.staffId !== selectedStaffId) return false;
                if (!work.date || !work.date.toDate) return false;
                const workDate = work.date.toDate();
                workDate.setHours(0,0,0,0);
                return workDate >= startDate && workDate <= endDate;
            });

            for (let i = 0; i < 7; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                const dayString = day.toISOString().split('T')[0];

                const headerEl = document.createElement('div');
                headerEl.className = 'p-4 text-center';
                headerEl.innerHTML = `
                    <div class="font-bold text-white">${day.toLocaleString('en-US', { weekday: 'short' })}</div>
                    <div class="text-sm text-slate-400">${day.getDate()}</div>
                `;
                weekGridHeader.appendChild(headerEl);

                const bodyEl = document.createElement('div');
                bodyEl.className = 'day-column border-t border-l border-slate-700 p-2 overflow-y-auto relative';

                const tasksForDay = weekWork
                    .filter(work => work.date.toDate().toISOString().split('T')[0] === dayString)
                    .sort((a,b) => a.date.toDate() - b.date.toDate());

                tasksForDay.forEach(task => {
                    const taskTime = task.date.toDate().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: false });
                    const taskEl = document.createElement('div');
                    taskEl.className = 'bg-slate-700 p-2 rounded-md mb-2 cursor-pointer hover:bg-slate-600 transition-colors duration-150';
                    taskEl.dataset.id = task.id;
                    taskEl.addEventListener('click', () => openWorkModal(task.id));

                    const locationName = task.customerItemName;
                    const customerNameForDisplay = task.customerName ? `(${task.customerName})` : '';

                    taskEl.innerHTML = `
                        <div class="font-semibold text-sm text-white">${task.taskTitle || 'No Title'}</div>
                        <div class="text-xs text-slate-300">${task.workCategory || 'Uncategorized'}</div>
                        ${locationName ? `<div class="text-xs text-cyan-400 mt-1 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3 flex-shrink-0"></i><span>${locationName} ${customerNameForDisplay}</span></div>` : ''}
                        <div class="text-xs text-blue-400 mt-1 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3 flex-shrink-0"></i><span>${taskTime}</span></div>
                    `;
                    bodyEl.appendChild(taskEl);
                });

                if (selectedStaffId) {
                    const addTaskBtn = document.createElement('button');
                    // --- INCREASED PADDING & FONT SIZE ---
                    addTaskBtn.className = 'sticky bottom-1 left-1 right-1 w-auto mx-auto mt-2 text-center px-4 py-2 rounded-lg bg-blue-600/50 hover:bg-blue-600/80 text-blue-100 transition text-sm flex items-center justify-center gap-1 font-medium'; // Larger padding, slightly larger text, bold
                    addTaskBtn.innerHTML = `<i data-lucide="plus" class="w-4 h-4"></i> Add Work`; // Added "Work" text
                    addTaskBtn.dataset.date = dayString;
                    addTaskBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openWorkModal(null, dayString);
                    });
                    bodyEl.appendChild(addTaskBtn);
                }
                weekGridBody.appendChild(bodyEl);
            }
            lucide.createIcons();
        }

        // Week Navigation & Staff Filters
        prevWeekBtn.addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderWeekGrid();
        });
        nextWeekBtn.addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderWeekGrid();
        });
        todayWeekBtn.addEventListener('click', () => {
            currentWeekStart = getStartOfWeek(new Date());
            renderWeekGrid();
        });

        // --- MODIFIED: Trigger grid render on selection change ---
        staffSelect.addEventListener('change', renderWeekGrid);

        // --- MODIFIED: Auto-select and render grid on search filter ---
        function filterStaffDropdown() {
             const searchTerm = staffSearchInput.value.toLowerCase();
             const currentSelectedId = staffSelect.value; // Store current selection before clearing
             staffSelect.innerHTML = ''; // Clear options
             const defaultOption = document.createElement('option');
             defaultOption.value = "";
             defaultOption.textContent = "-- Select a Staff Member --";
             staffSelect.appendChild(defaultOption);

             const matchingStaff = []; // Keep track of staff that match

             allStaff.forEach(staff => {
                 if ((staff.name || '').toLowerCase().includes(searchTerm)) {
                     const option = document.createElement('option');
                     option.value = staff.id;
                     option.textContent = staff.name || 'Unnamed Staff';
                     staffSelect.appendChild(option);
                     matchingStaff.push(staff.id); // Add matching staff ID
                 }
             });

             let newSelectedId = ""; // ID to be selected after filtering

             // Check if the previously selected staff is still in the list
             if (matchingStaff.includes(currentSelectedId)) {
                 newSelectedId = currentSelectedId; // Keep the current selection
             }
             // If only one staff member matches the search, automatically select them
             else if (matchingStaff.length === 1) {
                 newSelectedId = matchingStaff[0];
             }
             // Otherwise (multiple matches or no matches), keep the default "-- Select --" (value="")

             staffSelect.value = newSelectedId; // Set the determined selection

             // IMPORTANT: Always call renderWeekGrid after filtering and potentially changing selection
             renderWeekGrid();
         }
        staffSearchInput.addEventListener('input', filterStaffDropdown);


        // Work Modal Logic
        const openWorkModal = async (docId = null, date = null) => {
            workForm.reset();
            document.getElementById('workDocId').value = docId || '';
            deleteWorkBtn.classList.add('hidden');
            customerDropdownWrapper.classList.add('hidden');
            customerItemDropdownWrapper.classList.add('hidden');

            const selectedStaffId = staffSelect.value;
            if (!selectedStaffId && !docId) {
                showToast("Please select a staff member first.", false); return;
            }

            if (docId) { // Editing
                workModalTitle.textContent = 'Edit Work';
                submitWorkBtnText.textContent = 'Update';
                try {
                    const docRef = doc(db, `users/${currentUserId}/staff_work`, docId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const work = docSnap.data();
                        document.getElementById('taskTitle').value = work.taskTitle || '';
                        document.getElementById('workCategory').value = work.workCategory || '';
                        document.getElementById('taskDate').value = work.date?.toDate()?.toISOString()?.split('T')[0] || '';
                        document.getElementById('taskTime').value = work.date?.toDate()?.toTimeString()?.split(' ')[0]?.substring(0, 5) || '';
                        document.getElementById('taskDescription').value = work.description || '';
                        deleteWorkBtn.classList.remove('hidden');

                        const category = work.workCategory;
                        const savedCustomerId = work.customerId;
                        const savedItemName = work.customerItemName;

                        if (category) {
                            loadCustomersForCategory(category); // Load customers first
                            setTimeout(() => {
                                if (savedCustomerId) {
                                    customerSelect.value = savedCustomerId;
                                    loadCustomerItems(savedCustomerId); // Load items
                                    setTimeout(() => {
                                         if (savedItemName) {
                                             customerItemSelect.value = savedItemName;
                                         }
                                    }, 150);
                                }
                            }, 150);
                        }
                    } else {
                         showToast("Work assignment not found.", false); return;
                    }
                } catch (err) {
                    showToast(`Error fetching work: ${err.message}`, false); console.error("Error fetching work:", err); return;
                }
            } else if (date) { // Adding
                workModalTitle.textContent = 'Add Work';
                submitWorkBtnText.textContent = 'Save';
                document.getElementById('taskDate').value = date;
            } else {
                 console.error("openWorkModal called incorrectly"); return;
            }

            workModal.classList.remove('hidden');
            setTimeout(() => workModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };

        const closeWorkModal = () => {
            workModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                workModal.classList.add('hidden');
                workForm.reset();
                customerDropdownWrapper.classList.add('hidden');
                customerItemDropdownWrapper.classList.add('hidden');
            }, 200);
        };

        closeWorkModalBtn.addEventListener('click', closeWorkModal);
        cancelWorkModalBtn.addEventListener('click', closeWorkModal);
        workModal.addEventListener('click', e => { if(e.target === workModal) closeWorkModal(); });

        // Category Selection Change -> Load Customers
        workCategorySelect.addEventListener('change', e => {
            const selectedCategory = e.target.value;
            customerDropdownWrapper.classList.add('hidden');
            customerItemDropdownWrapper.classList.add('hidden');
            customerSelect.value = '';
            customerItemSelect.value = '';
            if (selectedCategory) {
                loadCustomersForCategory(selectedCategory);
            }
        });

        // Customer Selection Change -> Load Items
        customerSelect.addEventListener('change', e => {
            const selectedCustomerId = e.target.value;
            customerItemDropdownWrapper.classList.add('hidden');
            customerItemSelect.value = '';
            if(selectedCustomerId) {
                loadCustomerItems(selectedCustomerId);
            }
        });


        // Form Submit
        workForm.addEventListener('submit', async e => {
            e.preventDefault();
            const docId = document.getElementById('workDocId').value;
            const selectedStaffId = staffSelect.value;
            const selectedStaffOption = staffSelect.options[staffSelect.selectedIndex];
            const selectedStaffName = selectedStaffOption ? selectedStaffOption.text : 'Unknown Staff';

            if (!selectedStaffId) { showToast("No staff member selected.", false); return; }

            const taskTitle = document.getElementById('taskTitle').value.trim();
            const dateStr = document.getElementById('taskDate').value;
            const timeStr = document.getElementById('taskTime').value;

            if (!taskTitle || !dateStr || !timeStr) { showToast("Please fill in Title, Date, and Time.", false); return; }

            submitWorkBtn.disabled = true;
            submitWorkBtnText.classList.add('hidden');
            submitWorkSpinner.classList.remove('hidden');

            try {
                const fullDate = Timestamp.fromDate(new Date(`${dateStr}T${timeStr}`));
                const selectedWorkCategory = document.getElementById('workCategory').value;
                const selectedCustomerId = customerSelect.value;
                const selectedCustomerOption = customerSelect.options[customerSelect.selectedIndex];
                const selectedCustomerName = selectedCustomerId ? selectedCustomerOption.text : null;
                const selectedCustomerItemName = customerItemSelect.value;

                const data = {
                    staffId: selectedStaffId,
                    staffName: selectedStaffName,
                    date: fullDate,
                    taskTitle: taskTitle,
                    workCategory: selectedWorkCategory,
                    description: document.getElementById('taskDescription').value.trim(),
                    customerId: selectedCustomerId || null,
                    customerName: selectedCustomerName,
                    customerItemName: selectedCustomerItemName || null,
                };

                if (docId) {
                    await updateDoc(doc(db, `users/${currentUserId}/staff_work`, docId), data);
                    showToast('Work assignment updated!');
                } else {
                    await addDoc(collection(db, `users/${currentUserId}/staff_work`), data);
                    showToast('Work assigned successfully!');
                }
                closeWorkModal();
            } catch (err) {
                showToast(`Error saving assignment: ${err.message}`, false);
                console.error("Error saving work:", err);
            } finally {
                submitWorkBtn.disabled = false;
                submitWorkBtnText.classList.remove('hidden');
                submitWorkSpinner.classList.add('hidden');
            }
        });

        // Delete Button
        deleteWorkBtn.addEventListener('click', async () => {
            const docId = document.getElementById('workDocId').value;
            if (docId && confirm('Are you sure you want to delete this work assignment?')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUserId}/staff_work`, docId));
                    showToast('Work assignment deleted.');
                    closeWorkModal();
                } catch (err) {
                    showToast(`Error deleting assignment: ${err.message}`, false);
                    console.error("Error deleting work:", err);
                }
            }
        });

        // Toast Function
        const showToast = (message, isSuccess = true) => {
            toast.textContent = message;
            toast.className = `fixed bottom-10 right-10 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        };

        lucide.createIcons();
    </script>
</body>
</html>