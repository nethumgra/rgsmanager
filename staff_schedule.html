<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Schedule - RSG MANAGER</title>

    <link rel="icon" href="logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Individual View Grid */
        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            min-height: 400px;
        }
        .day-column {
            min-height: 120px;
        }

        /* Team View Styles */
        .team-grid-header {
            display: grid;
            grid-template-columns: 200px repeat(7, minmax(140px, 1fr)); /* Staff Name + 7 Days */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .team-grid-row {
            display: grid;
            grid-template-columns: 200px repeat(7, minmax(140px, 1fr)); /* Staff Name + 7 Days */
            min-height: 100px; /* Each staff row height */
        }
        
        /* Team view eke Add button eka penne hover karama */
        .day-column .team-add-btn {
            opacity: 0; /* Default hidden */
            transition: opacity 0.2s;
        }
        .day-column:hover .team-add-btn {
            opacity: 0.7; /* Show on cell hover */
        }
        .day-column .team-add-btn:hover {
            opacity: 1; /* Full opacity on button hover */
        }

    </style>
</head>
<body class="bg-slate-900 text-slate-300 font-sans">

    <div id="app-container" class="flex h-screen hidden">
        <aside class="w-64 bg-slate-800 p-6 flex-shrink-0 flex flex-col justify-between overflow-y-auto">
            <div>
                <div class="flex items-center gap-3 mb-10">

    <div>
        <img src="logo.png" alt="Logo" class="w-10 h-10 rounded-lg object-cover">
    </div>
    <h1 class="text-xl font-bold text-white">RSG MANAGER</h1>
</div>              <nav class="flex flex-col gap-2">
                    <a href="./index.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a>
                    <a href="./staff.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="users"></i><span>Staff Members</span></a>
                    
                    <a href="./staff_schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition bg-slate-700 text-white"><i data-lucide="calendar"></i><span>Staff Schedule</span></a>
                    
                    <a href="./work_comparison.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="compare"></i><span>Work Comparison</span></a>
                    <a href="./customers.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="contact"></i><span>Customers</span></a>
                    <a href="./properties.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="home"></i><span>Properties</span></a>
                    <a href="./income_expenses.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="dollar-sign"></i><span>Income/Expenses</span></a>
                    <a href="./scheduled_finance.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="clock"></i><span>Scheduled Finance</span></a>
                    <a href="./materials.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="boxes"></i><span>Materials Stock</span></a>
                    <a href="./vehicles.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="car"></i><span>Vehicles</span></a>
                    <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>General Schedule</span></a>
                    <a href="./agreements.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-check-2"></i><span>Agreements</span></a>
                    <a href="./invoice.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-spreadsheet"></i><span>Invoices</span></a>
                    <a href="./app_access.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="key-round"></i><span>App Access</span></a>
                    <a href="./payslips.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="receipt"></i><span>Payslips</span></a>
                    <a href="./f24.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-text"></i><span>F24 Tax</span></a>
                    <a href="./agreement_generator.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-text"></i><span>Proposal Gen</span></a>
                </nav>
            </div>
            <div>
                 <button id="signOutBtn" class="w-full flex items-center justify-center gap-3 px-4 py-2 mb-4 rounded-lg transition bg-slate-700 hover:bg-red-600 text-white">
                    <i data-lucide="log-out"></i><span>Sign Out</span>
                </button>
                <div class="text-xs text-slate-500">
                     <p>&copy; 2025 RSG MANAGER ADMIN. All rights reserved.Developed By Mathizz</p>
                    <p class="mt-1">User ID: <span id="userId" class="font-mono">Loading...</span></p>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto flex flex-col">
            <section id="page-staff-schedule" class="page flex-1 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Staff Work Schedule</h2>
                </div>

                <div class="bg-slate-800 rounded-lg p-4 mb-4 flex items-end gap-4">
                     <div id="individualFilters" class="flex-1">
                         <label for="staffSearchInput" class="block mb-2 text-sm font-medium">Search Staff</label>
                         <input type="text" id="staffSearchInput" placeholder="Type name to search..." class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5 mb-2">

                         <label for="staffSelect" class="block mb-2 text-sm font-medium">Select Staff Member</label>
                         <select id="staffSelect" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                             <option value="">Loading staff...</option>
                         </select>
                     </div>
                    <div class="flex items-center gap-2">
                        <button id="prevWeekBtn" title="Previous Week" class="p-2.5 rounded-md bg-slate-700 hover:bg-slate-600"><i data-lucide="chevron-left"></i></button>
                        <button id="todayWeekBtn" title="Go to Current Week" class="px-4 py-2.5 rounded-md bg-slate-700 hover:bg-slate-600 text-sm">This Week</button>
                        <button id="nextWeekBtn" title="Next Week" class="p-2.5 rounded-md bg-slate-700 hover:bg-slate-600"><i data-lucide="chevron-right"></i></button>
                    </div>
                </div>

                <div id="viewTabs" class="flex items-center gap-2 mb-4">
                    <button id="individualTabBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold">Individual View</button>
                    <button id="teamTabBtn" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold">Team View</button>
                </div>

                <h3 id="weekRangeDisplay" class="text-xl font-semibold text-white mb-4 text-center"></h3>

                <div id="individualView" class="flex-1 flex flex-col bg-slate-800 rounded-lg overflow-hidden">
                    <div id="weekGridHeader" class="week-grid border-b border-slate-700" style="min-height: auto;">
                    </div>
                    <div id="weekGridBody" class="week-grid flex-1 overflow-y-auto">
                    </div>
                </div>
                
                <div id="teamView" class="flex-1 flex-col bg-slate-800 rounded-lg overflow-auto hidden">                    <div id="teamGridHeader" class="team-grid-header bg-slate-700 border-b-2 border-slate-600">
                        </div>
                    <div id="teamGridBody" class="min-h-[400px]">
                        </div>
                </div>

            </section>
        </main>
    </div>

    <div id="workModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-lg transform transition-all scale-95 opacity-0" id="work-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="workModalTitle" class="text-2xl font-bold text-white">Add Work</h3>
                <button id="closeWorkModalBtn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="workForm">
                <input type="hidden" id="workDocId">

                <div class="mb-4">
                    <label for="taskTitle" class="block mb-2 text-sm font-medium">Work / Task Title</label>
                    <input type="text" id="taskTitle" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" placeholder="e.g., Clean Block A, Mow Lawn" required>
                </div>

                <div class="mb-4">
                    <label for="workCategory" class="block mb-2 text-sm font-medium">Work Category</label>
                    <select id="workCategory" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5">
                        <option value="">Select Category</option>
                        <option value="Condominium">Condominium</option>
                        <option value="Hotel B&B">Hotel B&B</option>
                        <option value="Gardners">Gardners</option>
                        <option value="Staff">Staff</option>
                        <option value="Agency">Agency</option>
                        <option value="Gym">Gym</option>
                        <option value="Laundry">Laundry</option>
                        <option value="Flat">Flat</option>
                        <option value="Pool">Pool</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div id="customerDropdownWrapper" class="mb-4 hidden">
                    <label for="customerSelect" class="block mb-2 text-sm font-medium">Select Customer</label>
                    <select id="customerSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <div id="customerItemDropdownWrapper" class="mb-4 hidden">
                    <label for="customerItemSelect" class="block mb-2 text-sm font-medium">Select Item/Location</label>
                    <select id="customerItemSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="taskDate" class="block mb-2 text-sm font-medium">Date</label>
                        <input type="date" id="taskDate" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                    </div>
                     <div>
                        <label for="taskTime" class="block mb-2 text-sm font-medium">Time</label>
                        <input type="time" id="taskTime" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="flex items-center gap-2 text-sm font-medium cursor-pointer">
                        <input type="checkbox" id="taskFixed" class="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500">
                        <span>Fixed Weekly Task (Repeat every week)</span>
                    </label>
                </div>
                <div class="mb-4">
                    <label for="taskDescription" class="block mb-2 text-sm font-medium">Description / Notes</label>
                    <textarea id="taskDescription" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" rows="3" placeholder="Add any extra details..."></textarea>
                </div>

                <div class="flex justify-between items-center mt-8">
                     <div>
                        <button type="button" id="deleteWorkBtn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold hidden">Delete</button>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" id="cancelWorkModalBtn" class="px-6 py-2 rounded-lg bg-slate-600 hover:bg-slate-700">Cancel</button>
                        <button type="submit" id="submitWorkBtn" class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold flex items-center">
                            <span id="submitWorkBtnText">Save</span>
                            <div id="submitWorkSpinner" class="loader w-5 h-5 ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc, updateDoc, where, query, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Main App Config
        const firebaseConfig = {
             apiKey: "AIzaSyCkKqLZFM4sm5jdbR1NVhhVy9IhUeDXOWc",
             authDomain: "rsgweb-5f36d.firebaseapp.com",
             projectId: "rsgweb-5f36d",
             storageBucket: "rsgweb-5f36d.firebasestorage.app",
             messagingSenderId: "633023905515",
             appId: "1:633023905515:web:3b1ae3ebc44eefc59748ae",
        };

        // App Initialization
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global State
        let currentUserId = null;
        let allStaff = [];
        let allStaffWork = [];
        let allCustomers = [];
        let loadedCustomerItems = [];
        let currentWeekStart = new Date();
        let currentView = 'individual'; // 'individual' or 'team'
        let isStaffLoading = true;
        let isWorkLoading = true;

        // DOM Elements
        const appContainer = document.getElementById('app-container');
        const signOutBtn = document.getElementById('signOutBtn');
        const userIdSpan = document.getElementById('userId');
        const toast = document.getElementById('toast');

        // === ALUTH DOM ELEMENTS ===
        const individualFilters = document.getElementById('individualFilters');
        const individualTabBtn = document.getElementById('individualTabBtn');
        const teamTabBtn = document.getElementById('teamTabBtn');
        const individualView = document.getElementById('individualView');
        const teamView = document.getElementById('teamView');
        const teamGridHeader = document.getElementById('teamGridHeader');
        const teamGridBody = document.getElementById('teamGridBody');

        // Individual View Elements
        const staffSelect = document.getElementById('staffSelect');
        const staffSearchInput = document.getElementById('staffSearchInput');
        const weekGridHeader = document.getElementById('weekGridHeader');
        const weekGridBody = document.getElementById('weekGridBody');
        
        // Podu Elements
        const weekRangeDisplay = document.getElementById('weekRangeDisplay');
        const prevWeekBtn = document.getElementById('prevWeekBtn');
        const nextWeekBtn = document.getElementById('nextWeekBtn');
        const todayWeekBtn = document.getElementById('todayWeekBtn');
        
        // Modal Elements
        const workModal = document.getElementById('workModal');
        const workModalContent = document.getElementById('work-modal-content');
        const workModalTitle = document.getElementById('workModalTitle');
        const closeWorkModalBtn = document.getElementById('closeWorkModalBtn');
        const cancelWorkModalBtn = document.getElementById('cancelWorkModalBtn');
        const workForm = document.getElementById('workForm');
        const deleteWorkBtn = document.getElementById('deleteWorkBtn');
        const submitWorkBtn = document.getElementById('submitWorkBtn');
        const submitWorkBtnText = document.getElementById('submitWorkBtnText');
        const submitWorkSpinner = document.getElementById('submitWorkSpinner');
        const workCategorySelect = document.getElementById('workCategory');
        const customerDropdownWrapper = document.getElementById('customerDropdownWrapper');
        const customerSelect = document.getElementById('customerSelect');
        const customerItemDropdownWrapper = document.getElementById('customerItemDropdownWrapper');
        const customerItemSelect = document.getElementById('customerItemSelect');

        // === DATE HELPER FUNCTIONS (TimeZone Fix) ===
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }
        function getLocalDateString(date) {
            if (!date) return '';
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function getLocalTimeString(date) {
            if (!date) return '';
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        // --- End of Date Helpers ---

        // Authentication
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdSpan.textContent = currentUserId.substring(0, 10) + '...';
                appContainer.classList.remove('hidden');

                // === *** FIX එක මෙතන *** ===
                // App eka pennuwata passe icons render karanna
                lucide.createIcons(); 
                // ==========================

                currentWeekStart = getStartOfWeek(new Date());
                listenForStaff();
                listenForWorkSchedule();
                listenForCustomers();
            } else {
                window.location.href = './index.html';
            }
        });

        signOutBtn.addEventListener('click', () => {
            signOut(auth);
        });
        
        // Data Loading
        function checkInitialLoad() {
             if (!isStaffLoading && !isWorkLoading) {
                 // Default view eka render karanna
                 if (currentView === 'individual') {
                     filterStaffDropdown(); // Mekath renderWeekGrid() call karanawa
                 } else {
                     renderTeamGrid();
                 }
             }
        }

        function listenForStaff() {
            if (!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/staff`), snapshot => {
                isStaffLoading = false;
                allStaff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allStaff.sort((a, b) => (a.name || 'Z').localeCompare(b.name || 'Z'));
                
                filterStaffDropdown(); // Individual view eke dropdown eka update karanna
                
                if (currentView === 'team') {
                    renderTeamGrid(); // Team view eka active nam, staff list eka change unama ekath update karanna
                }
                checkInitialLoad();
            }, error => {
                console.error("Error listening for staff:", error);
                showToast("Error loading staff list.", false);
            });
        }

        function listenForWorkSchedule() {
            if (!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/staff_work`), snapshot => {
                isWorkLoading = false;
                allStaffWork = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Dan active eke thiyena view eka refresh karanna
                if (currentView === 'individual') {
                    renderWeekGrid();
                } else {
                    renderTeamGrid();
                }
                checkInitialLoad();
            }, error => {
                console.error("Error listening for work schedule:", error);
                showToast("Error loading work schedule.", false);
            });
        }

        function listenForCustomers() {
            if (!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/customers`), snapshot => {
                allCustomers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }, error => {
                console.error("Error listening for customers:", error);
                showToast("Error loading customer data.", false);
            });
        }

        // Customer/Item loading (Modal eka sadaha)
        function loadCustomersForCategory(category) {
            customerSelect.innerHTML = `<option value="">Loading Customers...</option>`;
            customerDropdownWrapper.classList.remove('hidden');
            customerItemDropdownWrapper.classList.add('hidden');
            customerItemSelect.innerHTML = '<option value="">Select Customer First</option>';
            if (!category) {
                customerSelect.innerHTML = `<option value="">Select Category First</option>`;
                customerDropdownWrapper.classList.add('hidden');
                return;
            }
            const categoryCustomers = allCustomers.filter(c => c.category === category);
            populateCustomerDropdown(category, categoryCustomers);
        }
        function populateCustomerDropdown(category, customers) {
            const currentVal = customerSelect.value;
            customerSelect.innerHTML = `<option value="">-- Select Customer for ${category} --</option>`;
            customers.sort((a, b) => (a.name || 'Z').localeCompare(b.name || 'Z'));
            if (customers.length === 0) {
                customerSelect.innerHTML = `<option value="">No customers found for ${category}</option>`;
                return;
            }
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name || 'Unnamed Customer';
                customerSelect.appendChild(option);
            });
            const previouslySelectedCustomerExists = customers.some(c => c.id === currentVal);
            if (previouslySelectedCustomerExists) {
                customerSelect.value = currentVal;
                loadCustomerItems(currentVal);
            } else {
                 customerSelect.value = "";
                 customerItemDropdownWrapper.classList.add('hidden');
            }
        }
        function loadCustomerItems(customerId) {
            customerItemSelect.innerHTML = `<option value="">Loading Items...</option>`;
            customerItemDropdownWrapper.classList.remove('hidden');
            loadedCustomerItems = [];
            if (!customerId) {
                customerItemSelect.innerHTML = `<option value="">Select Customer First</option>`;
                customerItemDropdownWrapper.classList.add('hidden');
                return;
            }
            const selectedCustomer = allCustomers.find(c => c.id === customerId);
            if (selectedCustomer && selectedCustomer.items && Array.isArray(selectedCustomer.items)) {
                loadedCustomerItems = selectedCustomer.items.map(item => ({
                    name: item.name || 'Unnamed Item'
                }));
            }
            populateCustomerItemsDropdown(loadedCustomerItems);
        }
        function populateCustomerItemsDropdown(items) {
            const currentVal = customerItemSelect.value;
            customerItemSelect.innerHTML = `<option value="">-- Select Item/Location --</option>`;
            items.sort((a, b) => (a.name || 'Z').localeCompare(b.name || 'Z'));
            if (items.length === 0) {
                customerItemSelect.innerHTML = `<option value="">No items found for this customer</option>`;
                return;
            }
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = item.name;
                customerItemSelect.appendChild(option);
            });
            const previouslySelectedItemExists = items.some(item => item.name === currentVal);
             if (previouslySelectedItemExists) {
                 customerItemSelect.value = currentVal;
             } else {
                 customerItemSelect.value = "";
             }
        }

        // === VIEW 1 RENDER: renderWeekGrid (Individual) - අලුත් එක ===
        function renderWeekGrid() {
            const selectedStaffId = staffSelect.value;
            weekGridHeader.innerHTML = '';
            weekGridBody.innerHTML = '';

            const startDate = new Date(currentWeekStart);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            weekRangeDisplay.textContent = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;

            // 1. මේ සතියට අදාළ Normal tasks ටික විතරක් ගන්න
            const normalTasksForWeek = allStaffWork.filter(w => {
                if (w.staffId !== selectedStaffId || w.isFixed) return false;
                if (!w.date || !w.date.toDate) return false;
                const workDate = w.date.toDate(); workDate.setHours(0, 0, 0, 0);
                return workDate >= startDate && workDate <= endDate;
            });

            // 2. මේ staff ගේ *සියලුම* Fixed tasks ටික ගන්න
            const allFixedTasksForStaff = allStaffWork.filter(w => w.staffId === selectedStaffId && w.isFixed === true);
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                const dayString = getLocalDateString(day);
                const dayOfWeek = day.getDay(); // 0=Sunday, 1=Monday ...

                // Header එක (වෙනසක් නෑ)
                const headerEl = document.createElement('div');
                headerEl.className = 'p-4 text-center';
                headerEl.innerHTML = `
                    <div class="font-bold text-white">${day.toLocaleString('en-US', { weekday: 'short' })}</div>
                    <div class="text-sm text-slate-400">${day.getDate()}</div>
                `;
                weekGridHeader.appendChild(headerEl);

                const bodyEl = document.createElement('div');
                bodyEl.className = 'day-column border-t border-l border-slate-700 p-2 overflow-y-auto relative';

                // 3. අද දවසට අදාළ Normal tasks ටික filter කරන්න
                const tasksForDay_Normal = normalTasksForWeek
                    .filter(work => getLocalDateString(work.date.toDate()) === dayString);

                // 4. අද දවසට අදාළ Fixed tasks ටික අරගෙන "Synthetic" (කෘතීම) task objects හදන්න
                const tasksForDay_Fixed = allFixedTasksForStaff.filter(task => {
                    const originalDate = task.date.toDate();
                    originalDate.setHours(0,0,0,0);
                    // දවසේ අංකය (day of week) එක සමානද? AND original task එකේ date එක අදට වඩා පරණද/සමානද?
                    return originalDate.getDay() === dayOfWeek && originalDate <= day;
                }).map(fixedTask => {
                    // Original task එක mutate කරන්නේ නැතුව අලුත් object එකක් හදනවා
                    const originalDateTime = fixedTask.date.toDate();
                    const syntheticDate = new Date(day); // අද දවසේ date එක
                    syntheticDate.setHours(originalDateTime.getHours(), originalDateTime.getMinutes()); // ඒත් original වෙලාව

                    return {
                        ...fixedTask, // title, category, etc.
                        id: fixedTask.id, // Edit කරන්න original ID එක
                        date: Timestamp.fromDate(syntheticDate), // දවස විතරක් වෙනස් කරපු date එක
                    };
                });

                // 5. Tasks සේරම එකතු කරලා වෙලාව අනුව sort කරන්න
                const allTasksForThisDay = [...tasksForDay_Normal, ...tasksForDay_Fixed];
                allTasksForThisDay.sort((a,b) => a.date.toDate() - b.date.toDate());


                allTasksForThisDay.forEach(task => {
                    const taskTime = getLocalTimeString(task.date.toDate());
                    const taskEl = document.createElement('div');
                    taskEl.className = 'bg-slate-700 p-2 rounded-md mb-2 cursor-pointer hover:bg-slate-600 transition-colors duration-150';
                    taskEl.dataset.id = task.id;
                    taskEl.addEventListener('click', () => openWorkModal(task.id));
                    
                    const locationName = task.customerItemName;
                    const customerNameForDisplay = task.customerName ? `(${task.customerName})` : '';
                    
                    // Fixed task එකක් නම් "Repeat" icon එකක් දාන්න
                    const isFixedIcon = task.isFixed ? `<i data-lucide="repeat" class="w-3 h-3 text-green-400" title="Fixed Weekly Task"></i>` : '';

                    taskEl.innerHTML = `
                        <div class="font-semibold text-sm text-white">${task.taskTitle || 'No Title'}</div>
                        <div class="text-xs text-slate-300">${task.workCategory || 'Uncategorized'}</div>
                        ${locationName ? `<div class="text-xs text-cyan-400 mt-1 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3 flex-shrink-0"></i><span>${locationName} ${customerNameForDisplay}</span></div>` : ''}
                        
                        <div class="text-xs text-blue-400 mt-1 flex items-center justify-between">
                            <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3 flex-shrink-0"></i><span>${taskTime}</span></span>
                            ${isFixedIcon}
                        </div>
                    `;
                    bodyEl.appendChild(taskEl);
                });

                if (selectedStaffId) {
                    const addTaskBtn = document.createElement('button');
                    addTaskBtn.className = 'sticky bottom-1 left-1 right-1 w-auto mx-auto mt-2 text-center px-4 py-2 rounded-lg bg-blue-600/50 hover:bg-blue-600/80 text-blue-100 transition text-sm flex items-center justify-center gap-1 font-medium';
                    addTaskBtn.innerHTML = `<i data-lucide="plus" class="w-4 h-4"></i> Add Work`;
                    addTaskBtn.dataset.date = dayString;
                    addTaskBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openWorkModal(null, e.currentTarget.dataset.date);
                    });
                    bodyEl.appendChild(addTaskBtn);
                }
                weekGridBody.appendChild(bodyEl);
            }
            lucide.createIcons();
        }

        // === VIEW 2 RENDER: renderTeamGrid (Aluth eka) - අලුත් එක ===
        function renderTeamGrid() {
            teamGridHeader.innerHTML = '';
            teamGridBody.innerHTML = '';

            if (isStaffLoading || isWorkLoading) {
                teamGridBody.innerHTML = '<div class="flex justify-center items-center h-64"><div class="loader"></div></div>';
                return;
            }
            if (allStaff.length === 0) {
                teamGridBody.innerHTML = '<p class="text-center p-10">No staff members found.</p>';
                return;
            }

            const startDate = new Date(currentWeekStart);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            weekRangeDisplay.textContent = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;

            // 1. මේ සතියට අදාළ Normal tasks (සැමෝගෙම)
            const normalTasksForWeek = allStaffWork.filter(w => {
                if (w.isFixed) return false;
                if (!w.date || !w.date.toDate) return false;
                const workDate = w.date.toDate(); workDate.setHours(0, 0, 0, 0);
                return workDate >= startDate && workDate <= endDate;
            });

            // 2. *සියලුම* Fixed tasks (සැමෝගෙම)
            const allFixedTasks = allStaffWork.filter(w => w.isFixed === true);


            // 1. Render Header Row (වෙනසක් නෑ)
            const staffHeaderCell = document.createElement('div');
            staffHeaderCell.className = 'p-4 font-bold text-white text-left sticky left-0 z-10 bg-slate-700 border-r border-slate-600';
            staffHeaderCell.textContent = 'Staff Member';
            teamGridHeader.appendChild(staffHeaderCell);

            for (let i = 0; i < 7; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                const headerEl = document.createElement('div');
                headerEl.className = 'p-4 text-center border-r border-slate-600';
                headerEl.innerHTML = `
                    <div class="font-bold text-white">${day.toLocaleString('en-US', { weekday: 'short' })}</div>
                    <div class="text-sm text-slate-400">${day.getDate()}</div>
                `;
                teamGridHeader.appendChild(headerEl);
            }

            // 2. Render Staff Rows
            allStaff.forEach(staff => {
                const staffRowEl = document.createElement('div');
                staffRowEl.className = 'team-grid-row border-t border-slate-700';

                const nameCell = document.createElement('div');
                nameCell.className = 'p-3 font-semibold text-white sticky left-0 bg-slate-800 border-r border-slate-600';
                nameCell.textContent = staff.name || 'Unnamed Staff';
                staffRowEl.appendChild(nameCell);

                for (let i = 0; i < 7; i++) {
                    const day = new Date(startDate);
                    day.setDate(startDate.getDate() + i);
                    const dayString = getLocalDateString(day);
                    const dayOfWeek = day.getDay();
                    
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-column border-r border-slate-700 p-2 overflow-y-auto flex flex-col gap-2 relative'; 

                    // 3. මේ staff ගේ අද දවසට අදාළ Normal tasks
                    const tasksForDay_Normal = normalTasksForWeek
                        .filter(work => work.staffId === staff.id && getLocalDateString(work.date.toDate()) === dayString);

                    // 4. මේ staff ගේ අද දවසට අදාළ Fixed tasks
                    const tasksForDay_Fixed = allFixedTasks.filter(task => {
                        if (task.staffId !== staff.id) return false;
                        const originalDate = task.date.toDate();
                        originalDate.setHours(0,0,0,0);
                        return originalDate.getDay() === dayOfWeek && originalDate <= day;
                    }).map(fixedTask => {
                        const originalDateTime = fixedTask.date.toDate();
                        const syntheticDate = new Date(day);
                        syntheticDate.setHours(originalDateTime.getHours(), originalDateTime.getMinutes());
                        return {
                            ...fixedTask,
                            id: fixedTask.id,
                            date: Timestamp.fromDate(syntheticDate),
                        };
                    });
                    
                    // 5. Tasks සේරම එකතු කරලා වෙලාව අනුව sort කරන්න
                    const allTasksForThisDay = [...tasksForDay_Normal, ...tasksForDay_Fixed];
                    allTasksForThisDay.sort((a,b) => a.date.toDate() - b.date.toDate());

                    
                    allTasksForThisDay.forEach(task => {
                        const taskTime = getLocalTimeString(task.date.toDate());
                        const taskEl = document.createElement('div');
                        taskEl.className = 'bg-slate-700 p-2 rounded-md cursor-pointer hover:bg-slate-600';
                        taskEl.title = task.description || 'No description';
                        
                        taskEl.addEventListener('click', () => {
                            staffSelect.value = task.staffId; 
                            individualTabBtn.click(); 
                            setTimeout(() => { 
                                openWorkModal(task.id);
                            }, 50);
                        });

                        const locationName = task.customerItemName;
                        // Fixed task එකක් නම් "Repeat" icon එකක් දාන්න
                        const isFixedIcon = task.isFixed ? `<i data-lucide="repeat" class="w-3 h-3 text-green-400" title="Fixed Weekly Task"></i>` : '';

                        taskEl.innerHTML = `
                            <div class="font-semibold text-sm text-white truncate">${task.taskTitle || 'No Title'}</div>
                            ${locationName ? `<div class="text-xs text-cyan-400 mt-1 flex items-center gap-1 truncate"><i data-lucide="map-pin" class="w-3 h-3 flex-shrink-0"></i><span>${locationName}</span></div>` : ''}
                            
                            <div class="text-xs text-blue-400 mt-1 flex items-center justify-between">
                                <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3 flex-shrink-0"></i><span>${taskTime}</span></span>
                                ${isFixedIcon}
                            </div>
                        `;
                        dayCell.appendChild(taskEl);
                    });
                    
                    // "Add Work" Button (වෙනසක් නෑ)
                    const addTaskBtn = document.createElement('button');
                    addTaskBtn.className = 'team-add-btn sticky bottom-1 w-full mt-auto text-center px-2 py-1 rounded-md bg-blue-600/70 hover:bg-blue-600 text-white transition text-xs flex items-center justify-center gap-1'; 
                    addTaskBtn.innerHTML = `<i data-lucide="plus" class="w-3 h-3"></i> Add`;
                    addTaskBtn.dataset.date = dayString;
                    addTaskBtn.dataset.staffId = staff.id;
                    
                    addTaskBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const staffId = e.currentTarget.dataset.staffId;
                        const date = e.currentTarget.dataset.date;
                        individualTabBtn.click(); 
                        staffSelect.value = staffId;
                        setTimeout(() => {
                            openWorkModal(null, date);
                        }, 50);
                    });
                    dayCell.appendChild(addTaskBtn);

                    staffRowEl.appendChild(dayCell);
                }
                teamGridBody.appendChild(staffRowEl);
            });
            lucide.createIcons();
        }

        // === ALUTH TAB SWITCHING LOGIC ===
        individualTabBtn.addEventListener('click', () => {
            currentView = 'individual';
            
            // Button styles
            individualTabBtn.classList.add('bg-blue-600', 'text-white');
            individualTabBtn.classList.remove('bg-slate-700', 'hover:bg-slate-600', 'text-slate-300');
            teamTabBtn.classList.add('bg-slate-700', 'hover:bg-slate-600', 'text-slate-300');
            teamTabBtn.classList.remove('bg-blue-600', 'text-white');

            // Show/Hide elements
            individualFilters.classList.remove('hidden');
            individualView.classList.remove('hidden');
            individualView.classList.add('flex');
            teamView.classList.add('hidden');
            teamView.classList.remove('flex');

            renderWeekGrid(); // Adala view eka render karanna
        });

        teamTabBtn.addEventListener('click', () => {
            currentView = 'team';
            
            // Button styles
            teamTabBtn.classList.add('bg-blue-600', 'text-white');
            teamTabBtn.classList.remove('bg-slate-700', 'hover:bg-slate-600', 'text-slate-300');
            individualTabBtn.classList.add('bg-slate-700', 'hover:bg-slate-600', 'text-slate-300');
            individualTabBtn.classList.remove('bg-blue-600', 'text-white');
            
            // Show/Hide elements
            individualFilters.classList.add('hidden'); // Filters hide karanna
            individualView.classList.add('hidden');
            individualView.classList.remove('flex');
            teamView.classList.remove('hidden');
            teamView.classList.add('flex'); // Meka flex widiyata pennanna

            renderTeamGrid(); // Adala view eka render karanna
        });


        // === PODU WEEK NAVIGATION (WENAS KARAPU) ===
        prevWeekBtn.addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            if (currentView === 'individual') renderWeekGrid(); else renderTeamGrid();
        });
        nextWeekBtn.addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            if (currentView === 'individual') renderWeekGrid(); else renderTeamGrid();
        });
        todayWeekBtn.addEventListener('click', () => {
            currentWeekStart = getStartOfWeek(new Date());
            if (currentView === 'individual') renderWeekGrid(); else renderTeamGrid();
        });

        // Individual Staff Filters
        staffSelect.addEventListener('change', renderWeekGrid);
        function filterStaffDropdown() {
             const searchTerm = staffSearchInput.value.toLowerCase();
             const currentSelectedId = staffSelect.value;
             staffSelect.innerHTML = '';
             const defaultOption = document.createElement('option');
             defaultOption.value = "";
             defaultOption.textContent = "-- Select a Staff Member --";
             staffSelect.appendChild(defaultOption);
             const matchingStaff = [];
             allStaff.forEach(staff => {
                 if ((staff.name || '').toLowerCase().includes(searchTerm)) {
                     const option = document.createElement('option');
                     option.value = staff.id;
                     option.textContent = staff.name || 'Unnamed Staff';
                     staffSelect.appendChild(option);
                     matchingStaff.push(staff.id);
                 }
             });
             let newSelectedId = "";
             if (matchingStaff.includes(currentSelectedId)) {
                 newSelectedId = currentSelectedId;
             }
             else if (matchingStaff.length === 1) {
                 newSelectedId = matchingStaff[0];
             }
             staffSelect.value = newSelectedId;
             renderWeekGrid(); // Filter karama individual view eka render karanna
        }
        staffSearchInput.addEventListener('input', filterStaffDropdown);


        // === WORK MODAL LOGIC (WENASAK NA) ===
        const openWorkModal = async (docId = null, date = null) => {
            workForm.reset();
            document.getElementById('workDocId').value = docId || '';
            deleteWorkBtn.classList.add('hidden');
            customerDropdownWrapper.classList.add('hidden');
            customerItemDropdownWrapper.classList.add('hidden');
            const selectedStaffId = staffSelect.value;
            if (!selectedStaffId && !docId) {
                showToast("Please select a staff member first.", false); return;
            }
            if (docId) {
                workModalTitle.textContent = 'Edit Work';
                submitWorkBtnText.textContent = 'Update';
                try {
                    const docRef = doc(db, `users/${currentUserId}/staff_work`, docId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const work = docSnap.data();
                        const localWorkDate = work.date?.toDate();
                        document.getElementById('taskTitle').value = work.taskTitle || '';
                        document.getElementById('workCategory').value = work.workCategory || '';
                        document.getElementById('taskDate').value = getLocalDateString(localWorkDate);
                        document.getElementById('taskTime').value = getLocalTimeString(localWorkDate);
                        document.getElementById('taskDescription').value = work.description || '';
                        
                        // === අලුත් වෙනස්කම ===
                        document.getElementById('taskFixed').checked = work.isFixed || false; 
                        // ====================

                        deleteWorkBtn.classList.remove('hidden');
                        const category = work.workCategory;
                        const savedCustomerId = work.customerId;
                        const savedItemName = work.customerItemName;
                        if (category) {
                            loadCustomersForCategory(category);
                            setTimeout(() => {
                                if (savedCustomerId) {
                                    customerSelect.value = savedCustomerId;
                                    loadCustomerItems(savedCustomerId);
                                    setTimeout(() => {
                                         if (savedItemName) {
                                             customerItemSelect.value = savedItemName;
                                         }
                                    }, 150);
                                }
                            }, 150);
                        }
                    } else {
                         showToast("Work assignment not found.", false); return;
                    }
                } catch (err) {
                    showToast(`Error fetching work: ${err.message}`, false); console.error("Error fetching work:", err); return;
                }
            } else if (date) {
                workModalTitle.textContent = 'Add Work';
                submitWorkBtnText.textContent = 'Save';
                document.getElementById('taskDate').value = date;
            } else {
                 console.error("openWorkModal called incorrectly"); return;
            }
            workModal.classList.remove('hidden');
            setTimeout(() => workModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };
        const closeWorkModal = () => {
            workModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                workModal.classList.add('hidden');
                workForm.reset();
                customerDropdownWrapper.classList.add('hidden');
                customerItemDropdownWrapper.classList.add('hidden');
            }, 200);
        };
        closeWorkModalBtn.addEventListener('click', closeWorkModal);
        cancelWorkModalBtn.addEventListener('click', closeWorkModal);
        workModal.addEventListener('click', e => { if(e.target === workModal) closeWorkModal(); });
        workCategorySelect.addEventListener('change', e => {
            const selectedCategory = e.target.value;
            customerDropdownWrapper.classList.add('hidden');
            customerItemDropdownWrapper.classList.add('hidden');
            customerSelect.value = '';
            customerItemSelect.value = '';
            if (selectedCategory) {
                loadCustomersForCategory(selectedCategory);
            }
        });
        customerSelect.addEventListener('change', e => {
            const selectedCustomerId = e.target.value;
            customerItemDropdownWrapper.classList.add('hidden');
            customerItemSelect.value = '';
            if(selectedCustomerId) {
                loadCustomerItems(selectedCustomerId);
            }
        });

        // Form Submit
        workForm.addEventListener('submit', async e => {
            e.preventDefault();
            const docId = document.getElementById('workDocId').value;
            const selectedStaffId = staffSelect.value; // Modal eka open wenne individual view eken, nisa meka hari
            const selectedStaffOption = staffSelect.options[staffSelect.selectedIndex];
            const selectedStaffName = selectedStaffOption ? selectedStaffOption.text : 'Unknown Staff';
            if (!selectedStaffId) { showToast("No staff member selected.", false); return; }
            const taskTitle = document.getElementById('taskTitle').value.trim();
            const dateStr = document.getElementById('taskDate').value;
            const timeStr = document.getElementById('taskTime').value;
            if (!taskTitle || !dateStr || !timeStr) { showToast("Please fill in Title, Date, and Time.", false); return; }
            submitWorkBtn.disabled = true;
            submitWorkBtnText.classList.add('hidden');
            submitWorkSpinner.classList.remove('hidden');
            try {
                const fullDate = Timestamp.fromDate(new Date(`${dateStr}T${timeStr}`));
                const selectedWorkCategory = document.getElementById('workCategory').value;
                const selectedCustomerId = customerSelect.value;
                const selectedCustomerOption = customerSelect.options[customerSelect.selectedIndex];
                const selectedCustomerName = selectedCustomerId ? selectedCustomerOption.text : null;
                const selectedCustomerItemName = customerItemSelect.value;
                
                // === අලුත් වෙනස්කම ===
                const isFixed = document.getElementById('taskFixed').checked;
                // ====================

                const data = {
                    staffId: selectedStaffId,
                    staffName: selectedStaffName,
                    date: fullDate,
                    taskTitle: taskTitle,
                    workCategory: selectedWorkCategory,
                    description: document.getElementById('taskDescription').value.trim(),
                    customerId: selectedCustomerId || null,
                    customerName: selectedCustomerName,
                    customerItemName: selectedCustomerItemName || null,
                    
                    // === අලුත් වෙනස්කම ===
                    isFixed: isFixed 
                    // ====================
                };

                if (docId) {
                    await updateDoc(doc(db, `users/${currentUserId}/staff_work`, docId), data);
                    showToast('Work assignment updated!');
                } else {
                    await addDoc(collection(db, `users/${currentUserId}/staff_work`), data);
                    showToast('Work assigned successfully!');
                }
                closeWorkModal();
            } catch (err) {
                showToast(`Error saving assignment: ${err.message}`, false);
                console.error("Error saving work:", err);
            } finally {
                submitWorkBtn.disabled = false;
                submitWorkBtnText.classList.remove('hidden');
                submitWorkSpinner.classList.add('hidden');
            }
        });

        // Delete Button
        deleteWorkBtn.addEventListener('click', async () => {
            const docId = document.getElementById('workDocId').value;
            if (docId && confirm('Are you sure you want to delete this work assignment?')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUserId}/staff_work`, docId));
                    showToast('Work assignment deleted.');
                    closeWorkModal();
                } catch (err) {
                    showToast(`Error deleting assignment: ${err.message}`, false);
                    console.error("Error deleting work:", err);
                }
            }
        });

        // Toast Function
        const showToast = (message, isSuccess = true) => {
            toast.textContent = message;
            toast.className = `fixed bottom-10 right-10 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        };

        // === *** FIX එක *** ===
        // Script එකේ අග තිබ්බ lucide.createIcons() call එක මෙතනින් අයින් කළා.
        // ඒක onAuthStateChanged function එක ඇතුළට දැම්මා.
    </script>
</body>
</html>