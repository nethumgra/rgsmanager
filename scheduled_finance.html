<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduled Finance - RSG MANAGER</title>

    <link rel="icon" href="logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Row status */
        .scheduled-row {
             background-color: rgba(59, 130, 246, 0.1);
        }
        .scheduled-row:hover td {
             background-color: rgba(59, 130, 246, 0.2) !important;
        }
        .completed-row {
            opacity: 0.6;
        }
        .completed-row:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 font-sans">

    <div id="app-container" class="flex h-screen hidden">
        <aside class="w-64 bg-slate-800 p-6 flex-shrink-0 flex flex-col justify-between">
            <div>
                <div class="flex items-center gap-3 mb-10">
                    <div>
                        <img src="logo.png" alt="Logo" class="w-10 h-10 rounded-lg object-cover">
                    </div>
                    <h1 class="text-xl font-bold text-white">RSG MANAGER</h1>
                </div>
            <nav class="flex flex-col gap-2">
                   <a href="./index.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a>
                   <a href="./staff.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="users"></i><span>Staff Members</span></a>
                   <a href="./staff_schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>Staff Schedule</span></a>
                   <a href="./customers.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="contact"></i><span>Customers</span></a>
                   <a href="./properties.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="home"></i><span>Properties</span></a>
                   <a href="./income_expenses.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="dollar-sign"></i><span>Income/Expenses</span></a>
                   
                   <a href="./scheduled_finance.html" class="nav-link bg-slate-700 text-white flex items-center gap-3 px-4 py-2 rounded-lg transition"><i data-lucide="clock"></i><span>Scheduled Finance</span></a>
                   
                   <a href="./materials.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="boxes"></i><span>Materials Stock</span></a>
                   <a href="./vehicles.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="car"></i><span>Vehicles</span></a>
                   <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>Schedule</span></a>
                   <a href="./agreements.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-check-2"></i><span>Agreements</span></a>
                   <a href="./invoice.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-spreadsheet"></i><span>Invoices</span></a>
                   <a href="./app_access.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="key-round"></i><span>App Access</span></a>
                   <a href="./payslips.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="receipt"></i><span>Payslips</span></a>
                   <a href="./f24.html" class="nav-link bg-slate-700 text-white flex items-center gap-3 px-4 py-2 rounded-lg transition"><i data-lucide="file-text"></i><span>F24 Tax</span></a>
                   <a href="./agreement_generator.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-text"></i><span>Proposal Gen</span></a>
                </nav>
            </div>
            <div>
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-slate-400 mb-2">Filter By Year</h3>
                    <div class="relative" id="year-filter-dropdown">
                        <button id="selected-year-btn" class="flex items-center justify-between w-full text-sm font-medium text-blue-400 bg-blue-500/10 px-3 py-1.5 rounded-md hover:bg-blue-500/20">
                            <span id="selected-year-text">...</span>
                            <svg id="dropdown-icon" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="year-dropdown-list" class="hidden absolute bottom-full mb-1 w-full bg-slate-700 rounded-md shadow-lg max-h-60 overflow-y-auto z-10">
                            <div id="year-list-container" class="flex flex-col space-y-1 p-1">
                            </div>
                        </div>
                    </div>
                </div>
                <button id="signOutBtn" class="w-full flex items-center justify-center gap-3 px-4 py-2 mb-4 rounded-lg transition bg-slate-700 hover:bg-red-600 text-white">
                     <i data-lucide="log-out"></i><span>Sign Out</span>
                 </button>
                 <div class="text-xs text-slate-500">
                     <p>&copy; 2025 Property MS. All rights reserved.</p>
                     <p class="mt-1">User ID: <span id="userId" class="font-mono">Loading...</span></p>
                 </div>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto">
            <section id="page-finance" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Scheduled Income & Expenses</h2>
                    </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-slate-800 p-6 rounded-lg">
                        <h3 class="text-slate-400">Total Scheduled Income</h3>
                        <p id="totalIncome" class="text-3xl font-bold text-green-400 mt-2">€ 0.00</p>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-lg">
                        <h3 class="text-slate-400">Total Scheduled Expenses</h3>
                        <p id="totalExpenses" class="text-3xl font-bold text-red-400 mt-2">€ 0.00</p>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-lg">
                        <h3 class="text-slate-400">Scheduled Profit</h3>
                        <p id="totalProfit" class="text-3xl font-bold text-blue-400 mt-2">€ 0.00</p>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-lg p-4 mb-6 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                     <div>
                         <label for="filterType" class="block mb-2 text-sm font-medium">Filter by Type</label>
                         <select id="filterType" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                             <option value="">All Types</option>
                             <option value="Income">Income</option>
                             <option value="Expense">Expense</option>
                         </select>
                     </div>
                     <div>
                         <label for="filterCategory" class="block mb-2 text-sm font-medium">Filter by Category</label>
                         <input type="text" id="filterCategory" placeholder="e.g., Salary, Rent" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                     </div>
                    <div>
                         <label for="filterMonth" class="block mb-2 text-sm font-medium">Filter by Month</label>
                         <select id="filterMonth" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                             <option value="">All Months</option>
                             <option value="0">January</option>
                             <option value="1">February</option>
                             <option value="2">March</option>
                             <option value="3">April</option>
                             <option value="4">May</option>
                             <option value="5">June</option>
                             <option value="6">July</option>
                             <option value="7">August</option>
                             <option value="8">September</option>
                             <option value="9">October</option>
                             <option value="10">November</option>
                             <option value="11">December</option>
                         </select>
                     </div>
                    <div>
                        <button id="clearFiltersBtn" class="w-full bg-slate-600 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-slate-500 transition">Clear Filters</button>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-lg overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-700">
                            <tr>
                                <th class="p-4 font-semibold text-white">Date</th>
                                <th class="p-4 font-semibold text-white">Description</th>
                                <th class="p-4 font-semibold text-white">Category</th> <th class="p-4 font-semibold text-white">Payment Method</th>
                                <th class="p-4 font-semibold text-white">Status</th>
                                <th class="p-4 font-semibold text-white">Type</th>
                                <th class="p-4 font-semibold text-white">Amount (€)</th>
                                <th class="p-4 font-semibold text-white">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <tr><td colspan="8" class="text-center p-8 text-slate-400">Loading scheduled events...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCkKqLZFM4sm5jdbR1NVhhVy9IhUeDXOWc",
            authDomain: "rsgweb-5f36d.firebaseapp.com",
            projectId: "rsgweb-5f36d",
            storageBucket: "rsgweb-5f36d.firebasestorage.app", 
            messagingSenderId: "633023905515",
            appId: "1:633023905515:web:3b1ae3ebc44eefc59748ae",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Global Variables
        let currentUserId = null;
        let allScheduleEvents = []; // This will hold the raw data from Firestore
        let mappedScheduleEvents = []; // This will hold the data formatted for the table
        
        // Year Filter Variables
        const availableYears = [2026, 2025, 2024, 2023, 2022, 2021, 2020, 2019, 2018, 2017];
        
        // *** ME VENASA KALA: Default year is 2025 ***
        let selectedYear = 2025; 

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const signOutBtn = document.getElementById('signOutBtn');
        const userIdSpan = document.getElementById('userId');
        const toast = document.getElementById('toast');
        const transactionTableBody = document.getElementById('transactionTableBody');
        const filterType = document.getElementById('filterType');
        const filterMonth = document.getElementById('filterMonth'); // Changed from filterDate
        const filterCategory = document.getElementById('filterCategory');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');

        // Year Filter DOM Elements
        const selectedYearBtn = document.getElementById('selected-year-btn');
        const selectedYearText = document.getElementById('selected-year-text');
        const yearDropdownList = document.getElementById('year-dropdown-list');
        const yearListContainer = document.getElementById('year-list-container');
        const dropdownIcon = document.getElementById('dropdown-icon');

        // --- Auth ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdSpan.textContent = currentUserId.substring(0, 10) + '...';
                appContainer.classList.remove('hidden');
                listenForScheduleEvents(); 
                initializeYearFilter();
            } else {
                window.location.href = './index.html';
            }
        });

        signOutBtn.addEventListener('click', () => signOut(auth));

        // --- START: YEAR DROPDOWN LOGIC ---
        function initializeYearFilter() {
            selectedYearText.textContent = selectedYear;
            populateYearFilter();

            selectedYearBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                toggleYearDropdown();
            });

            yearListContainer.addEventListener('click', (e) => {
                e.preventDefault();
                if (e.target.tagName === 'A' || e.target.closest('A')) {
                    const year = parseInt((e.target.tagName === 'A' ? e.target : e.target.closest('A')).dataset.year);
                    if (year) {
                        selectYear(year);
                    }
                }
            });

            window.addEventListener('click', (event) => {
                if (!document.getElementById('year-filter-dropdown').contains(event.target)) {
                    yearDropdownList.classList.add('hidden');
                    if(dropdownIcon) dropdownIcon.classList.remove('rotate-180');
                }
            });
        }

        function toggleYearDropdown() {
            const isHidden = yearDropdownList.classList.contains('hidden');
            if (isHidden) {
                yearDropdownList.classList.remove('hidden');
                if(dropdownIcon) dropdownIcon.classList.add('rotate-180');
            } else {
                yearDropdownList.classList.add('hidden');
                if(dropdownIcon) dropdownIcon.classList.remove('rotate-180');
            }
        }

        function selectYear(year) {
            selectedYear = year;
            selectedYearText.textContent = year; 
            toggleYearDropdown();
            populateYearFilter();
            
            filterMonth.value = ""; // Reset month filter when year changes
            
            applyFilters(); 
            updateSummaryTotals(); // Update summary cards
        }

        function populateYearFilter() {
            yearListContainer.innerHTML = ''; 
            selectedYearText.textContent = selectedYear;
            
            availableYears.forEach(year => {
                // Add the current selected year to the top, but make it look different
                if (year === selectedYear) {
                    const span = document.createElement('span');
                    span.textContent = year;
                    span.className = "block text-sm font-medium text-white bg-blue-600 px-3 py-1.5 rounded-md"; // Highlight selected year
                    yearListContainer.appendChild(span);
                } else {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = year;
                    a.dataset.year = year;
                    a.className = "block text-sm font-medium text-slate-300 hover:bg-slate-600 hover:text-white px-3 py-1.5 rounded-md cursor-pointer";
                    yearListContainer.appendChild(a);
                }
            });
            
            // Sort list: selected year first, then descending for others
            Array.from(yearListContainer.children)
                .sort((a, b) => {
                    if (a.tagName === 'SPAN') return -1; // Keep selected year (SPAN) at top
                    if (b.tagName === 'SPAN') return 1;
                    return parseInt(b.dataset.year) - parseInt(a.dataset.year); // Sort others descending
                })
                .forEach(node => yearListContainer.appendChild(node));
        }
        // --- END: YEAR DROPDOWN LOGIC ---

        // --- Toast ---
        const showToast = (message, isSuccess = true) => {
            toast.textContent = message;
            toast.className = `fixed bottom-10 right-10 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        };

        // --- Table Render ---
        function renderTable(displayData) { 
            transactionTableBody.innerHTML = '';
            if (!displayData || displayData.length === 0) {
                transactionTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-slate-400">No scheduled finance events found matching criteria.</td></tr>`;
                return;
            }

            displayData.forEach(item => {
                const dateObj = item.date instanceof Timestamp ? item.date.toDate() : item.date;
                if (!dateObj) {
                    console.warn("Skipping item with invalid date:", item);
                    return;
                }
                const dateStr = dateObj.toLocaleDateString();
                const row = transactionTableBody.insertRow();
                const typeClass = item.type === 'Income' ? 'text-green-400' : 'text-red-400';
                
                // Status Tag & Row Class
                let statusTag = '';
                let rowClass = 'border-b border-slate-700 hover:bg-slate-700/50';
                if (item.status === 'Pending') {
                    statusTag = '<span class="bg-blue-600 text-blue-100 text-xs font-medium px-2 py-0.5 rounded-full">PENDING</span>';
                    rowClass += ' scheduled-row'; 
                } else if (item.status === 'Completed') {
                    statusTag = '<span class="bg-green-600 text-green-100 text-xs font-medium px-2 py-0.5 rounded-full">COMPLETED</span>';
                    rowClass += ' completed-row';
                }
                row.className = rowClass;

                // Actions are disabled
                const editTitle = "Cannot edit here. Go to Schedule page.";
                const deleteTitle = "Cannot delete here. Go to Schedule page.";
                
                row.innerHTML = `
                    <td class="p-4 align-top">${dateStr}</td>
                    <td class="p-4 align-top">${item.description || 'N/A'}</td>
                    <td class="p-4 align-top">${item.category || 'N/A'}</td>
                    <td class="p-4 align-top">${item.paymentMethod || 'N/A'}</td>
                    <td class="p-4 align-top">${statusTag}</td>
                    <td class="p-4 align-top font-semibold ${typeClass}">${item.type || 'N/A'}</td>
                    <td class="p-4 align-top">${(item.amount != null ? item.amount.toFixed(2) : '0.00')}</td>
                    <td class="p-4 align-top flex items-center gap-2">
                        <button class="text-blue-400 opacity-50 cursor-not-allowed" disabled title="${editTitle}"><i data-lucide="edit" class="w-5 h-5 pointer-events-none"></i></button>
                        <button class="text-red-400 opacity-50 cursor-not-allowed" disabled title="${deleteTitle}"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
                    </td>
                `;
            });
            lucide.createIcons();
        }

        // --- SCHEDULE EVENT LISTENER (Modified) ---
        function listenForScheduleEvents() {
            if (!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/schedule`), (snapshot) => {
                // Store raw data
                allScheduleEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Map the data into the format needed for the table
                // *** MODIFIED: Filter for Income/Expense AND no vehicleExpenseId ***
                mappedScheduleEvents = allScheduleEvents
                    .filter(e => (e.type === 'Income' || e.type === 'Expense') && !e.vehicleExpenseId) //
                    .map(e => ({
                        id: e.id, // Schedule Event ID
                        date: e.date instanceof Timestamp ? e.date.toDate() : e.date,
                        description: e.title || 'Scheduled Event', 
                        category: e.category || 'Scheduled',
                        paymentMethod: e.paymentMethod || 'N/A',
                        billUrl: null, // No bills for scheduled items
                        type: e.type, 
                        amount: e.amount || 0,
                        status: e.status || 'Pending', 
                        isScheduledEvent: true,
                        recurringId: e.recurringId || null,
                        vehicleExpenseId: e.vehicleExpenseId || null // Will be null here, but good to keep
                    }));

                applyFilters(); 
                updateSummaryTotals();
            }, (error) => {
                console.error("Error listening for schedule events:", error);
                showToast("Failed to load scheduled events data.", false);
            });
        }

        // --- FILTERS LOGIC (Modified for Month) ---
        function applyFilters() {
            const type = filterType.value;
            const month = filterMonth.value; // Changed from date
            const categoryInput = filterCategory.value.toLowerCase();

            // 1. Define the year filter
            const yearFilter = (item) => {
                if (!item.date) return false;
                const itemDate = item.date instanceof Timestamp ? item.date.toDate() : (item.date instanceof Date ? item.date : null);
                if (!itemDate) return false;
                return itemDate.getFullYear() === selectedYear;
            };

            // 2. Start with the pre-mapped, finance-only events, and filter by selected year
            let dataToFilter = mappedScheduleEvents.filter(yearFilter);

            // 3. Apply other filters
            if (type) {
                dataToFilter = dataToFilter.filter(t => t.type === type);
            }
            
            // 4. *** NEW: Filter by Month ***
            if (month !== "") { // Check if a month is selected
                const monthIndex = parseInt(month);
                dataToFilter = dataToFilter.filter(t => {
                    const itemDate = t.date instanceof Timestamp ? t.date.toDate() : t.date;
                    return itemDate && itemDate.getMonth() === monthIndex;
                });
            }
            
            if (categoryInput) {
                dataToFilter = dataToFilter.filter(t => t.category && t.category.toLowerCase().includes(categoryInput));
            }
            
            // 5. Sort and render
            dataToFilter.sort((a,b) => {
                const dateA = a.date instanceof Timestamp ? a.date.toDate() : a.date;
                const dateB = b.date instanceof Timestamp ? b.date.toDate() : b.date;
                return (dateB || 0) - (dateA || 0);
            });
            
            renderTable(dataToFilter); 
        }

        filterType.addEventListener('change', () => {
            applyFilters();
            updateSummaryTotals(); // Update totals when filter changes
        });
        filterMonth.addEventListener('change', () => {
            applyFilters();
            updateSummaryTotals(); // Update totals when filter changes
        });
        filterCategory.addEventListener('input', () => { // Changed to 'input' for instant search
            applyFilters();
            updateSummaryTotals(); // Update totals when filter changes
        });

        clearFiltersBtn.addEventListener('click', () => {
            filterType.value = '';
            filterMonth.value = '';
            filterCategory.value = '';
            applyFilters();
            updateSummaryTotals(); // Update totals when filters cleared
        });

        // --- SUMMARY (Modified for Month/Year) ---
        function updateSummaryTotals(){
            // 1. Get selected month
            const selectedMonth = filterMonth.value;
            const monthIndex = (selectedMonth !== "") ? parseInt(selectedMonth) : -1;
            
            // 2. Define the year filter
            const yearFilter = (item) => {
                if (!item.date) return false;
                const itemDate = item.date instanceof Timestamp ? item.date.toDate() : (item.date instanceof Date ? item.date : null);
                if (!itemDate) return false;
                return itemDate.getFullYear() === selectedYear;
            };
            
            // 3. Filter by year first
            let eventsToSummarize = mappedScheduleEvents.filter(yearFilter);
            
            let yearString = selectedYear.toString();
            
            // 4. If a month is selected, filter further and update title string
            if (monthIndex > -1) {
                eventsToSummarize = eventsToSummarize.filter(t => {
                    const itemDate = t.date instanceof Timestamp ? t.date.toDate() : t.date;
                    return itemDate && itemDate.getMonth() === monthIndex;
                });
                // Update yearString to show "Month/Year"
                const monthName = new Date(selectedYear, monthIndex).toLocaleString('default', { month: 'long' });
                yearString = `${monthName} ${selectedYear}`;
            }

            // 5. Update summary card titles
            document.querySelector('#totalIncome').previousElementSibling.textContent = `Total Scheduled Income (${yearString})`;
            document.querySelector('#totalExpenses').previousElementSibling.textContent = `Total Scheduled Expenses (${yearString})`;
            document.querySelector('#totalProfit').previousElementSibling.textContent = `Scheduled Profit (${yearString})`;

            // 6. Calculate totals for the filtered events
            const income = eventsToSummarize.filter(t => t.type === 'Income').reduce((sum, t) => sum + (t.amount || 0), 0);
            const expenses = eventsToSummarize.filter(t => t.type === 'Expense').reduce((sum, t) => sum + (t.amount || 0), 0);

            // 7. Display totals
            document.getElementById('totalIncome').textContent = `€ ${income.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('totalExpenses').textContent = `€ ${expenses.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('totalProfit').textContent = `€ ${(income-expenses).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        lucide.createIcons();
    </script>
</body>
</html>