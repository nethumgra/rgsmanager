<!DOCTYPE html>
<html lang="si" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Schedule - RSG MANAGER</title>

    <link rel="icon" href="logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: #e2e8f0; /* Border lines Light */
            gap: 1px; 
        }
        .dark .calendar-grid {
            background-color: #334155; /* Border lines Dark */
        }

        .calendar-day {
            min-height: 140px;
            background-color: #ffffff;
            transition: background-color 0.2s;
        }
        .dark .calendar-day {
            background-color: #1e293b;
        }
        
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; width: 100px; height: 4px;
            background: #cbd5e1; border-radius: 5px; outline: none;
        }
        .dark input[type=range] { background: #475569; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px;
            border-radius: 50%; background: #3b82f6; cursor: pointer; transition: background .15s ease-in-out;
        }
        input[type=range]::-webkit-slider-thumb:hover { background: #2563eb; }

        /* Color Radio */
        .color-radio {
            -webkit-appearance: none; appearance: none; width: 24px; height: 24px;
            border-radius: 50%; cursor: pointer; outline: none; transition: all 0.2s; border: 2px solid transparent;
        }
        .color-radio:checked { border-color: white; box-shadow: 0 0 0 2px #cbd5e1; }
        .dark .color-radio:checked { box-shadow: 0 0 0 2px #475569; }
        
        .modal-content { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-300 font-sans transition-colors duration-300">

    <div id="brightness-overlay" class="fixed inset-0 z-[100] pointer-events-none bg-black opacity-0 transition-opacity duration-0 mix-blend-multiply"></div>

    <div id="app-container" class="flex h-screen hidden">
        
        <aside class="w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 p-6 flex-shrink-0 flex flex-col justify-between z-10 shadow-sm transition-colors duration-300">
            <div>
                <div class="flex items-center gap-3 mb-10">
                    <div class="bg-blue-50 dark:bg-slate-700 p-1 rounded-lg transition-colors">
                        <img src="logo.png" alt="Logo" class="w-10 h-10 rounded-lg object-cover">
                    </div>
                    <h1 class="text-xl font-extrabold text-slate-900 dark:text-white tracking-tight">RSG MANAGER</h1>
                </div>
                
                <nav class="flex flex-col gap-1.5">
                   <a href="./index.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>Dashboard</span>
                   </a>
                   <a href="./staff.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="users" class="w-5 h-5"></i><span>Staff Members</span>
                   </a>
                   <a href="./staff_schedule.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="calendar" class="w-5 h-5"></i><span>Staff Schedule</span>
                   </a>
                   <a href="./customers.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="contact" class="w-5 h-5"></i><span>Customers</span>
                   </a>
                   <a href="./properties.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="home" class="w-5 h-5"></i><span>Properties</span>
                   </a>
                   <a href="./income_expenses.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="dollar-sign" class="w-5 h-5"></i><span>Income/Expenses</span>
                   </a>
                   
                   <div class="pt-4 mt-2 border-t border-slate-200 dark:border-slate-700">
                        <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tools</p>
                        <div class="space-y-1">
                            <a href="./scheduled_finance.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="clock" class="w-4 h-4"></i><span>Scheduled</span></a>
                            <a href="./materials.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="boxes" class="w-4 h-4"></i><span>Materials</span></a>
                            <a href="./vehicles.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="car" class="w-4 h-4"></i><span>Vehicles</span></a>
                            <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition bg-blue-50 dark:bg-slate-700 text-blue-700 dark:text-white font-bold shadow-sm"><i data-lucide="calendar-check" class="w-4 h-4"></i><span>Schedule</span></a>
                            <a href="./agreements.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="file-check-2" class="w-4 h-4"></i><span>Agreements</span></a>
                            <a href="./invoice.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i><span>Invoices</span></a>
                            <a href="./app_access.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="key-round" class="w-4 h-4"></i><span>App Access</span></a>
                            <a href="./payslips.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="receipt" class="w-4 h-4"></i><span>Payslips</span></a>
                            <a href="./f24.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="file-text" class="w-4 h-4"></i><span>F24 Tax</span></a>
                            <a href="./agreement_generator.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="file-edit" class="w-4 h-4"></i><span>Proposal Gen</span></a>
                        </div>
                   </div>
                </nav>
            </div>
            <div>
                <button id="signOutBtn" class="w-full flex items-center justify-center gap-3 px-4 py-2.5 mb-4 rounded-xl transition bg-slate-100 dark:bg-slate-700 hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-600 text-slate-700 dark:text-slate-300 font-bold group">
                    <i data-lucide="log-out" class="group-hover:text-red-600"></i><span>Sign Out</span>
                </button>
                <div class="text-xs text-slate-500 text-center">
                    <p>&copy; 2025 RSG Multiservice</p>
                    <p class="mt-1">UID: <span id="userId" class="font-mono text-slate-600 dark:text-slate-400">Loading...</span></p>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto flex flex-col">
            <section id="page-schedule" class="page max-w-[1600px] mx-auto w-full flex-1 flex flex-col">
                
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900 dark:text-white">General Schedule</h2>
                        <p class="text-slate-600 dark:text-slate-400 text-sm mt-1 font-medium">Manage general events, tasks, and view holidays.</p>
                    </div>
                    
                    <div class="flex items-center gap-3">
                         <div class="flex items-center gap-2 bg-white dark:bg-slate-800 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                             <i data-lucide="sun-dim" class="w-4 h-4 text-slate-500"></i>
                             <input type="range" id="brightness-slider" min="0" max="70" value="0">
                         </div>
                         <button id="theme-toggle" class="p-2.5 rounded-xl bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 shadow-sm border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                            <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i><i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                        </button>

                        <button id="addEventBtn" class="bg-slate-900 dark:bg-blue-600 text-white hover:bg-slate-800 dark:hover:bg-blue-500 px-5 py-2.5 rounded-xl text-sm font-bold transition flex items-center gap-2 shadow-lg">
                             <i data-lucide="plus" class="w-4 h-4"></i> Add Event
                        </button>
                    </div>
                </div>

                <div id="upcomingEvents" class="mb-8"></div>

                <div class="flex-1 flex flex-col bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden shadow-sm">
                    <div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                        <h3 id="monthYear" class="text-2xl font-bold text-slate-800 dark:text-white"></h3>
                        <div class="flex items-center gap-2">
                            <button id="prevMonth" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 transition"><i data-lucide="chevron-left"></i></button>
                            <button id="todayBtn" class="px-4 py-2 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-bold text-sm hover:bg-blue-200 dark:hover:bg-blue-900/50 transition">Today</button>
                            <button id="nextMonth" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 transition"><i data-lucide="chevron-right"></i></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-7 text-center font-bold text-xs uppercase text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
                        <div class="p-4">Sun</div><div class="p-4">Mon</div><div class="p-4">Tue</div><div class="p-4">Wed</div><div class="p-4">Thu</div><div class="p-4">Fri</div><div class="p-4">Sat</div>
                    </div>
                    
                    <div id="calendarGrid" class="calendar-grid flex-1 bg-slate-200 dark:bg-slate-700"></div>
                </div>

            </section>
        </main>
    </div>

    <div id="eventModal" class="fixed inset-0 bg-slate-900/50 dark:bg-slate-900/80 backdrop-blur-sm flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-2xl transform transition-all scale-95 opacity-0 shadow-2xl border border-slate-100 dark:border-slate-700" id="event-modal-content">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">
                <h3 id="eventModalTitle" class="text-2xl font-bold text-slate-900 dark:text-white">Add New Event</h3>
                <button id="closeEventModalBtn" class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="eventForm">
                <input type="hidden" id="eventDocId">
                
                <div class="relative mb-4">
                    <i data-lucide="type" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                    <input type="text" id="eventTitle" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 pl-10 focus:ring-2 focus:ring-blue-500 font-medium" placeholder="Event Title" required>
                </div>

                <div class="relative mb-4">
                     <i data-lucide="align-left" class="absolute left-3 top-3 text-slate-400 w-5 h-5"></i>
                    <textarea id="eventDescription" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 pl-10 focus:ring-2 focus:ring-blue-500 font-medium" rows="3" placeholder="Description / Notes..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                     <div>
                        <label for="eventType" class="block mb-1.5 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase">Event Type</label>
                        <select id="eventType" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-blue-500 font-medium">
                            <option value="General">General Event</option>
                            <option value="Income">Expected Income</option>
                            <option value="Expense">Expected Expense</option>
                        </select>
                    </div>
                    <div id="amountWrapper" class="hidden relative">
                         <label for="eventAmount" class="block mb-1.5 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase">Amount (€)</label>
                         <div class="relative">
                             <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">€</span>
                             <input type="number" id="eventAmount" step="0.01" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 pl-8 focus:ring-2 focus:ring-blue-500 font-medium" placeholder="e.g., 50.00">
                         </div>
                    </div>
                </div>

                 <div id="financeOptionsWrapper" class="hidden mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                    <div>
                        <label for="eventCategory" class="block mb-1.5 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase">Category</label>
                        <input type="text" id="eventCategory" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-sm" placeholder="e.g., Salary, Rent">
                    </div>
                     <div>
                        <label for="eventPaymentMethod" class="block mb-1.5 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase">Payment Method</label>
                        <select id="eventPaymentMethod" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-sm">
                            <option value="Cash">Cash</option>
                            <option value="Check">Check</option>
                            <option value="Bank Payment">Bank Payment</option>
                        </select>
                    </div>
                    <div id="incomeTypeWrapper" class="hidden col-span-2">
                        <label for="incomeType" class="block mb-1.5 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase">Recurrence</label>
                        <select id="incomeType" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-sm">
                            <option value="Variable">Variable (One-time)</option>
                            <option value="Fixed">Fixed (Monthly Recurring)</option>
                        </select>
                    </div>
                    <div id="expenseTypeWrapper" class="hidden col-span-2">
                        <label for="expenseType" class="block mb-1.5 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase">Recurrence</label>
                        <select id="expenseType" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-sm">
                            <option value="Variable">Variable (One-time)</option>
                            <option value="Fixed">Fixed (Monthly Recurring)</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="eventDate" class="block mb-1.5 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase">Date</label>
                        <input type="date" id="eventDate" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-blue-500 font-medium" required>
                    </div>
                     <div>
                        <label for="eventTime" class="block mb-1.5 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase">Time</label>
                        <input type="time" id="eventTime" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-blue-500 font-medium">
                    </div>
                </div>

                 <div class="mt-4">
                    <label class="block mb-2 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase">Color Tag</label>
                    <div id="eventColor" class="flex items-center gap-3">
                        <input type="radio" name="color" value="bg-blue-500" class="color-radio bg-blue-500" checked>
                        <input type="radio" name="color" value="bg-green-500" class="color-radio bg-green-500">
                        <input type="radio" name="color" value="bg-yellow-500" class="color-radio bg-yellow-500">
                        <input type="radio" name="color" value="bg-red-500" class="color-radio bg-red-500">
                        <input type="radio" name="color" value="bg-purple-500" class="color-radio bg-purple-500">
                    </div>
                </div>

                <div class="flex justify-between items-center mt-8 pt-4 border-t border-slate-100 dark:border-slate-700">
                     <div class="flex gap-2">
                        <button type="button" id="markCompletedBtn" class="px-4 py-2 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800 font-bold text-xs hidden items-center gap-2 hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition"><i data-lucide="check-circle" class="w-4 h-4"></i> Complete</button>
                        <button type="button" id="deleteEventBtn" class="px-4 py-2 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800 font-bold text-xs hidden hover:bg-red-100 dark:hover:bg-red-900/40 transition">Delete</button>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" id="cancelEventModalBtn" class="px-5 py-2.5 rounded-xl bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 text-slate-700 dark:text-white text-sm font-bold transition border border-slate-200 dark:border-slate-600">Cancel</button>
                        <button type="submit" id="submitEventBtn" class="px-6 py-2.5 rounded-xl bg-slate-900 dark:bg-blue-600 hover:bg-slate-800 dark:hover:bg-blue-500 text-white text-sm font-bold transition shadow-lg flex items-center">
                            <span id="submitEventBtnText">Save Event</span>
                            <div id="submitEventSpinner" class="loader ml-2 hidden" style="width:18px; height:18px;"></div>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 bg-green-500 text-white px-6 py-3 rounded-xl shadow-2xl transform translate-y-24 opacity-0 transition-all duration-500 font-medium flex items-center gap-2 z-[70]">
        <i data-lucide="check-circle" class="w-5 h-5"></i> <p>Toast message!</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc, updateDoc, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"; 
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
             apiKey: "AIzaSyCkKqLZFM4sm5jdbR1NVhhVy9IhUeDXOWc",
             authDomain: "rsgweb-5f36d.firebaseapp.com",
             projectId: "rsgweb-5f36d",
             storageBucket: "rsgweb-5f36d.firebasestorage.app",
             messagingSenderId: "633023905515",
             appId: "1:633023905515:web:3b1ae3ebc44eefc59748ae",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = null;
        let allEvents = [];
        let currentDate = new Date();
        let holidays = []; // Store fetched holidays

        // Theme & Brightness
        const themeToggleBtn = document.getElementById('theme-toggle');
        const brightnessSlider = document.getElementById('brightness-slider');
        const brightnessOverlay = document.getElementById('brightness-overlay');

        function initializeTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            const savedBrightness = localStorage.getItem('brightness') || 0;
            brightnessSlider.value = savedBrightness;
            brightnessOverlay.style.opacity = savedBrightness / 100;
        }
        initializeTheme();

        themeToggleBtn.addEventListener('click', () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.setItem('theme', 'light'); } 
            else { html.classList.add('dark'); localStorage.setItem('theme', 'dark'); }
        });
        brightnessSlider.addEventListener('input', (e) => {
            const val = e.target.value; brightnessOverlay.style.opacity = val / 100; localStorage.setItem('brightness', val);
        });

        // DOM
        const appContainer = document.getElementById('app-container');
        const signOutBtn = document.getElementById('signOutBtn');
        const userIdSpan = document.getElementById('userId');
        const toast = document.getElementById('toast');
        const calendarGrid = document.getElementById('calendarGrid');
        const monthYearEl = document.getElementById('monthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const todayBtn = document.getElementById('todayBtn');
        const upcomingEventsContainer = document.getElementById('upcomingEvents');
        
        // Modal
        const eventModal = document.getElementById('eventModal');
        const eventModalContent = document.getElementById('event-modal-content');
        const eventModalTitle = document.getElementById('eventModalTitle');
        const addEventBtn = document.getElementById('addEventBtn');
        const closeEventModalBtn = document.getElementById('closeEventModalBtn');
        const cancelEventModalBtn = document.getElementById('cancelEventModalBtn');
        const eventForm = document.getElementById('eventForm');
        const eventTypeSelect = document.getElementById('eventType');
        const amountWrapper = document.getElementById('amountWrapper');
        const financeOptionsWrapper = document.getElementById('financeOptionsWrapper');
        const incomeTypeWrapper = document.getElementById('incomeTypeWrapper');
        const incomeTypeSelect = document.getElementById('incomeType');
        const expenseTypeWrapper = document.getElementById('expenseTypeWrapper');
        const expenseTypeSelect = document.getElementById('expenseType');
        const markCompletedBtn = document.getElementById('markCompletedBtn');
        const deleteEventBtn = document.getElementById('deleteEventBtn');
        const submitEventBtn = document.getElementById('submitEventBtn');
        const submitEventBtnText = document.getElementById('submitEventBtnText');
        const submitEventSpinner = document.getElementById('submitEventSpinner');

        // Auth
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdSpan.textContent = currentUserId.substring(0, 10) + '...';
                appContainer.classList.remove('hidden');
                fetchHolidays(currentDate.getFullYear()); // Fetch holidays on load
                renderCalendar(); 
                listenForEvents();
            } else { window.location.href = './index.html'; }
        });
        signOutBtn.addEventListener('click', () => signOut(auth));

        // --- Holidays Logic ---
        async function fetchHolidays(year) {
            try {
                // Using Nager.Date API for Italian holidays (common for RSG Manager context)
                // Can change country code 'IT' if needed
                const response = await fetch(`https://date.nager.at/api/v3/publicholidays/${year}/IT`);
                if (response.ok) {
                    holidays = await response.json();
                    renderCalendar(); // Re-render calendar with holidays
                } else {
                    console.error("Failed to fetch holidays");
                }
            } catch (e) {
                console.error("Error fetching holidays:", e);
            }
        }

        // Calendar Logic
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearEl.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date(); today.setHours(0,0,0,0);

            // Empty slots
            for (let i = 0; i < firstDay; i++) {
                 const empty = document.createElement('div');
                 empty.className = 'calendar-day bg-slate-50 dark:bg-slate-800/50';
                 calendarGrid.innerHTML += `<div class="calendar-day bg-slate-50 dark:bg-slate-900/30"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0]; // YYYY-MM-DD
                const isToday = date.toDateString() === today.toDateString();
                const dayEl = document.createElement('div');
                
                // Check for holiday
                const holiday = holidays.find(h => h.date === dateString);
                
                // Day cell styling
                dayEl.className = `calendar-day p-2 overflow-y-auto transition-colors hover:bg-slate-50 dark:hover:bg-slate-800/80 ${isToday ? 'bg-blue-50/50 dark:bg-blue-900/10' : ''} ${holiday ? 'bg-red-50/50 dark:bg-red-900/10' : ''}`;
                
                let dayContent = `<div class="flex justify-between items-start mb-1">`;
                dayContent += `<div class="font-bold text-sm ${isToday ? 'text-blue-600 dark:text-blue-400' : 'text-slate-700 dark:text-slate-400'}">${day}</div>`;
                if(holiday) {
                    dayContent += `<div class="text-[10px] bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-300 px-1.5 py-0.5 rounded font-medium max-w-[70%] truncate" title="${holiday.localName}">${holiday.localName}</div>`;
                }
                dayContent += `</div><div id="events-${day}" class="space-y-1"></div>`;
                
                dayEl.innerHTML = dayContent;
                calendarGrid.appendChild(dayEl);
            }
            renderEvents();
        }

        prevMonthBtn.addEventListener('click', () => { 
            const oldYear = currentDate.getFullYear();
            currentDate.setMonth(currentDate.getMonth() - 1); 
            if(currentDate.getFullYear() !== oldYear) fetchHolidays(currentDate.getFullYear());
            renderCalendar(); 
        });
        nextMonthBtn.addEventListener('click', () => { 
            const oldYear = currentDate.getFullYear();
            currentDate.setMonth(currentDate.getMonth() + 1); 
            if(currentDate.getFullYear() !== oldYear) fetchHolidays(currentDate.getFullYear());
            renderCalendar(); 
        });
        todayBtn.addEventListener('click', () => { 
            const oldYear = currentDate.getFullYear();
            currentDate = new Date(); 
            if(currentDate.getFullYear() !== oldYear) fetchHolidays(currentDate.getFullYear());
            renderCalendar(); 
        });

        function renderEvents() {
            allEvents.sort((a,b) => a.date.toDate() - b.date.toDate());
            document.querySelectorAll('[id^="events-"]').forEach(el => el.innerHTML = '');
            const year = currentDate.getFullYear(); const month = currentDate.getMonth(); const timeZone = 'Europe/Rome';

            const monthEvents = allEvents.filter(e => {
                if (!e.date || !e.date.toDate) return false;
                const eventDateItaly = new Date(e.date.toDate().toLocaleString('en-US', { timeZone }));
                return eventDateItaly.getFullYear() === year && eventDateItaly.getMonth() === month;
            });

            monthEvents.forEach(event => {
                const eventDateItaly = new Date(event.date.toDate().toLocaleString('en-US', { timeZone }));
                const day = eventDateItaly.getDate();
                const eventsContainer = document.getElementById(`events-${day}`);

                if(eventsContainer){
                    const eventEl = document.createElement('div');
                    let completedClass = event.status === 'Completed' ? 'opacity-60 grayscale' : '';
                    
                    eventEl.className = `p-1.5 rounded text-white text-xs shadow-sm cursor-pointer hover:opacity-90 transition ${event.color || 'bg-blue-500'} ${completedClass}`;
                    
                    const timeString = event.date.toDate().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', timeZone, hour12: false });

                    eventEl.innerHTML = `
                        <div data-id="${event.id}" class="event-header flex items-center gap-1 truncate">
                            ${event.status === 'Completed' ? `<i data-lucide="check" class="w-3 h-3"></i>` : ''}
                            <span class="font-bold opacity-90">${timeString}</span>
                            <span class="truncate">${event.title}</span>
                        </div>
                    `;
                    eventEl.addEventListener('click', () => openEventModal(event.id));
                    eventsContainer.appendChild(eventEl);
                }
            });
            lucide.createIcons();
        }

        function listenForEvents() {
            if(!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/schedule`), snapshot => {
                allEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCalendar(); checkForUpcomingEvents();
            });
        }

        // Upcoming Events
        function checkForUpcomingEvents() {
            upcomingEventsContainer.innerHTML = '';
            const now = new Date(); const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const sevenDaysFromNow = new Date(todayStart); sevenDaysFromNow.setDate(todayStart.getDate() + 7);
            const timeZone = 'Europe/Rome';

            const upcoming = allEvents.filter(event => {
                if (!event.date || !event.date.toDate) return false;
                const eventDate = event.date.toDate();
                return event.status !== 'Completed' && eventDate >= todayStart && eventDate < sevenDaysFromNow;
            }).sort((a,b) => a.date.toDate() - b.date.toDate());

            if(upcoming.length > 0) {
                 upcomingEventsContainer.innerHTML = `<h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2"><i data-lucide="calendar-days" class="w-5 h-5 text-blue-500"></i> Upcoming (Next 7 Days)</h3>`;
                 const list = document.createElement('div');
                 list.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
                 upcoming.forEach(event => {
                     const eventDate = event.date.toDate();
                     const displayDateStr = eventDate.toLocaleDateString('it-IT', { timeZone, month:'short', day:'numeric' });
                     const displayTimeStr = eventDate.toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit', timeZone, hour12: false});
                     const alertEl = document.createElement('div');
                     
                     // Clean Card Design
                     alertEl.className = 'bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-4 rounded-xl flex items-start gap-4 cursor-pointer hover:shadow-md transition-shadow group';
                     alertEl.dataset.id = event.id;
                     const iconColor = event.type === 'Income' ? 'text-green-500' : event.type === 'Expense' ? 'text-red-500' : 'text-blue-500';
                     const iconBg = event.type === 'Income' ? 'bg-green-50 dark:bg-green-900/20' : event.type === 'Expense' ? 'bg-red-50 dark:bg-red-900/20' : 'bg-blue-50 dark:bg-blue-900/20';
                     const icon = event.vehicleExpenseId ? 'car' : 'bell';

                     alertEl.innerHTML = `
                        <div class="p-2 rounded-lg ${iconBg} ${iconColor}"><i data-lucide="${icon}" class="w-5 h-5"></i></div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-slate-800 dark:text-white truncate group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">${event.title}</h4>
                            <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 mt-1">
                                <span>${displayDateStr}</span> <span class="w-1 h-1 rounded-full bg-slate-300 dark:bg-slate-600"></span> <span>${displayTimeStr}</span>
                            </div>
                            ${event.type !== 'General' ? `<p class="font-bold text-slate-900 dark:text-slate-200 text-sm mt-2">€ ${(event.amount || 0).toLocaleString('it-IT', { minimumFractionDigits: 2 })}</p>` : ''}
                        </div>
                     `;
                     alertEl.addEventListener('click', () => openEventModal(event.id));
                     list.appendChild(alertEl);
                 });
                 upcomingEventsContainer.appendChild(list);
                 lucide.createIcons();
            }
        }

        // Modal Logic
        const openEventModal = (id = null) => {
            document.querySelectorAll('#eventForm input, #eventForm textarea, #eventForm select').forEach(el => el.disabled = false);
            submitEventBtn.style.display = 'flex'; deleteEventBtn.classList.remove('hidden'); markCompletedBtn.classList.add('hidden');
            const timeZone = 'Europe/Rome';
            if (id) {
                const event = allEvents.find(e => e.id === id);
                if(event) {
                    const d = event.date.toDate();
                    const YYYY = d.getFullYear();
                    const MM = String(d.getMonth() + 1).padStart(2, '0');
                    const DD = String(d.getDate()).padStart(2, '0');
                    const HH = String(d.getHours()).padStart(2, '0');
                    const MIN = String(d.getMinutes()).padStart(2, '0');
                    
                    eventModalTitle.textContent = 'Edit Event'; submitEventBtnText.textContent = 'Update Event';
                    document.getElementById('eventDocId').value = id;
                    document.getElementById('eventTitle').value = event.title;
                    document.getElementById('eventDescription').value = event.description || '';
                    document.getElementById('eventDate').value = `${YYYY}-${MM}-${DD}`;
                    document.getElementById('eventTime').value = `${HH}:${MIN}`;
                    
                    if(document.querySelector(`input[name="color"][value="${event.color}"]`)) document.querySelector(`input[name="color"][value="${event.color}"]`).checked = true;
                    
                    document.getElementById('eventType').value = event.type || 'General';
                    document.getElementById('eventAmount').value = event.amount || '';
                    document.getElementById('eventCategory').value = event.category || '';
                    document.getElementById('eventPaymentMethod').value = event.paymentMethod || 'Cash';
                    if(event.type === 'Expense') expenseTypeSelect.value = event.expenseType || 'Variable';
                    if(event.type === 'Income') incomeTypeSelect.value = event.incomeType || 'Variable';
                    
                    eventTypeSelect.dispatchEvent(new Event('change'));
                    
                    if ((event.type !== 'General' || event.vehicleExpenseId) && event.status !== 'Completed') {
                        markCompletedBtn.classList.remove('hidden'); markCompletedBtn.style.display = 'flex';
                    }
                    if (event.vehicleExpenseId) {
                         eventModalTitle.textContent = 'Linked Vehicle Event';
                         document.querySelectorAll('#eventForm input, #eventForm textarea, #eventForm select').forEach(el => el.disabled = true);
                         submitEventBtn.style.display = 'none'; deleteEventBtn.classList.add('hidden');
                    }
                }
            } else {
                eventModalTitle.textContent = 'Add New Event'; submitEventBtnText.textContent = 'Save Event';
                document.getElementById('eventDate').valueAsDate = new Date();
                const now = new Date();
                document.getElementById('eventTime').value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                document.querySelector(`input[name="color"]`).checked = true;
                deleteEventBtn.classList.add('hidden'); markCompletedBtn.classList.add('hidden');
                eventTypeSelect.value = 'General'; eventTypeSelect.dispatchEvent(new Event('change'));
            }
            eventModal.classList.remove('hidden'); setTimeout(() => eventModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };

        const closeEventModal = () => {
            eventModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                eventModal.classList.add('hidden'); eventForm.reset(); document.getElementById('eventDocId').value = '';
                amountWrapper.classList.add('hidden'); financeOptionsWrapper.classList.add('hidden');
                incomeTypeWrapper.classList.add('hidden'); expenseTypeWrapper.classList.add('hidden');
                document.querySelectorAll('#eventForm input, #eventForm textarea, #eventForm select').forEach(el => el.disabled = false);
                submitEventBtn.style.display = 'flex';
            }, 200);
        };
        addEventBtn.addEventListener('click', () => openEventModal());
        closeEventModalBtn.addEventListener('click', closeEventModal);
        cancelEventModalBtn.addEventListener('click', closeEventModal);
        eventModal.addEventListener('click', e => { if(e.target === eventModal) closeEventModal(); });

        eventTypeSelect.addEventListener('change', () => {
            const isFinance = eventTypeSelect.value === 'Income' || eventTypeSelect.value === 'Expense';
            financeOptionsWrapper.classList.toggle('hidden', !isFinance); amountWrapper.classList.toggle('hidden', !isFinance);
            incomeTypeWrapper.classList.toggle('hidden', eventTypeSelect.value !== 'Income');
            expenseTypeWrapper.classList.toggle('hidden', eventTypeSelect.value !== 'Expense');
        });

        // Submit Logic
        eventForm.addEventListener('submit', async e => {
            e.preventDefault();
            const docId = document.getElementById('eventDocId').value;
            submitEventBtn.disabled = true; submitEventBtnText.classList.add('hidden'); submitEventSpinner.classList.remove('hidden');

            try {
                const localDate = new Date(`${document.getElementById('eventDate').value}T${document.getElementById('eventTime').value}`);
                const data = {
                    title: document.getElementById('eventTitle').value,
                    description: document.getElementById('eventDescription').value,
                    date: Timestamp.fromDate(localDate),
                    color: document.querySelector('input[name="color"]:checked').value,
                    type: document.getElementById('eventType').value,
                    amount: parseFloat(document.getElementById('eventAmount').value) || 0,
                    category: document.getElementById('eventCategory').value,
                    paymentMethod: document.getElementById('eventPaymentMethod').value,
                };
                if (data.type === 'Income') data.incomeType = incomeTypeSelect.value;
                if (data.type === 'Expense') data.expenseType = expenseTypeSelect.value;
                if (data.type === 'General') { data.amount = 0; data.category = ''; data.paymentMethod = ''; }

                if(docId) {
                    const old = allEvents.find(e => e.id === docId); if(old) data.status = old.status || 'Pending';
                    await updateDoc(doc(db, `users/${currentUserId}/schedule`, docId), data); showToast('Event updated!');
                } else {
                    data.status = 'Pending';
                    const recType = data.type === 'Income' ? data.incomeType : data.expenseType;
                    if (data.type !== 'General' && recType === 'Fixed') {
                        const rid = crypto.randomUUID(); const batch = writeBatch(db);
                        for(let i=0; i < 12; i++) {
                            const fDate = new Date(localDate); fDate.setMonth(localDate.getMonth() + i);
                            batch.set(doc(collection(db, `users/${currentUserId}/schedule`)), {...data, date: Timestamp.fromDate(fDate), recurringId: rid});
                        }
                        await batch.commit(); showToast('Recurring event added!');
                    } else { await addDoc(collection(db, `users/${currentUserId}/schedule`), data); showToast('Event added!'); }
                }
                closeEventModal();
            } catch (err) { showToast("Error saving.", false); console.error(err); }
            finally { submitEventBtn.disabled = false; submitEventBtnText.classList.remove('hidden'); submitEventSpinner.classList.add('hidden'); }
        });

        // Delete & Complete Logic
        deleteEventBtn.addEventListener('click', async () => {
            const docId = document.getElementById('eventDocId').value; const evt = allEvents.find(e => e.id === docId);
            if (!evt) return;
            if (evt.recurringId && confirm('Delete all future recurring events?')) {
                 try {
                    const batch = writeBatch(db);
                    const futures = allEvents.filter(e => e.recurringId === evt.recurringId && e.date.toDate() >= evt.date.toDate());
                    futures.forEach(e => batch.delete(doc(db, `users/${currentUserId}/schedule`, e.id)));
                    await batch.commit(); showToast('Recurring events deleted.'); closeEventModal();
                } catch(e){ console.error(e); }
            } else if (confirm('Delete this event?')) {
                 try { await deleteDoc(doc(db, `users/${currentUserId}/schedule`, docId)); showToast('Deleted.'); closeEventModal(); } catch(e){ console.error(e); }
            }
        });

        markCompletedBtn.addEventListener('click', async () => {
             const docId = document.getElementById('eventDocId').value; const evt = allEvents.find(e => e.id === docId);
             if(!evt) return; markCompletedBtn.disabled = true;
             try {
                 const batch = writeBatch(db);
                 const transData = { date: evt.date, description: `Scheduled: ${evt.title}`, category: evt.category||'Scheduled', type: evt.type, amount: evt.amount||0, paymentMethod: evt.paymentMethod||'Cash' };
                 batch.set(doc(collection(db, `users/${currentUserId}/transactions`)), transData);
                 batch.update(doc(db, `users/${currentUserId}/schedule`, docId), { status: 'Completed' });
                 if(evt.vehicleExpenseId) {
                     batch.update(doc(db, `users/${currentUserId}/vehicle_expenses`, evt.vehicleExpenseId), { isFuturePayment: false });
                 }
                 await batch.commit(); showToast('Completed & Transaction added!'); closeEventModal();
             } catch(e) { console.error(e); showToast("Error.", false); }
        });

        const showToast = (message, isSuccess = true) => {
            toast.querySelector('p').textContent = message;
            toast.className = `fixed bottom-8 right-8 text-white px-6 py-3 rounded-xl shadow-2xl transform transition-all duration-500 font-medium flex items-center gap-2 z-[70] ${isSuccess ? 'bg-green-600' : 'bg-red-600'}`;
            toast.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-24', 'opacity-0'), 3000);
        };

        lucide.createIcons();
    </script>
</body>
</html>