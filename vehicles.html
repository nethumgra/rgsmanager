<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicles - RSG MANAGER</title>

    <link rel="icon" href="logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-input-label {
            display: inline-block;
            padding: 10px 16px;
            font-size: 14px;
            background-color: #3b82f6;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .file-input-label:hover { background-color: #2563eb; }
        .file-input { display: none; }
        .modal-content { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        
        /* */
        /* Future payment highlight kiranna */
        .future-payment-row {
            background-color: rgba(202, 138, 4, 0.1); /* bg-yellow-900/50 */
            border-left: 4px solid #ca8a04; /* border-yellow-500 */
        }
        .future-payment-row:hover {
             background-color: rgba(202, 138, 4, 0.2) !important;
        }

    </style>
</head>
<body class="bg-slate-900 text-slate-300 font-sans">

    <div id="app-container" class="flex h-screen hidden">
        <aside class="w-64 bg-slate-800 p-6 flex-shrink-0 flex flex-col justify-between">
            <div>
               <div class="flex items-center gap-3 mb-10">
    
    <div>
        <img src="logo.png" alt="Logo" class="w-10 h-10 rounded-lg object-cover">
    </div>
    <h1 class="text-xl font-bold text-white">RSG MANAGER</h1>
</div>    <nav class="flex flex-col gap-2">
                   <a href="./index.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a>
                   <a href="./staff.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="users"></i><span>Staff Members</span></a>
                   <a href="./staff_schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>Staff Schedule</span></a>
                   <a href="./customers.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="contact"></i><span>Customers</span></a>
                   <a href="./properties.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="home"></i><span>Properties</span></a>
                   <a href="./income_expenses.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="dollar-sign"></i><span>Income/Expenses</span></a>
                   <a href="./materials.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="boxes"></i><span>Materials Stock</span></a>
                   <a href="./vehicles.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="car"></i><span>Vehicles</span></a>
                   <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="calendar"></i><span>Schedule</span></a>
                   <a href="./agreements.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-check-2"></i><span>Agreements</span></a>
                   <a href="./invoices.html" class="nav-link bg-slate-700 text-white flex items-center gap-3 px-4 py-2 rounded-lg transition"><i data-lucide="file-spreadsheet"></i><span>Invoices</span></a>
                   <a href="./app_access.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="key-round"></i><span>App Access</span></a>
                   <a href="./payslips.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="receipt"></i><span>Payslips</span></a>
                   <a href="./agreement_generator.html" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition hover:bg-slate-700 hover:text-white"><i data-lucide="file-text"></i><span>Proposal Gen</span></a>
                </nav>
            </div>
            <div>
                 <button id="signOutBtn" class="w-full flex items-center justify-center gap-3 px-4 py-2 mb-4 rounded-lg transition bg-slate-700 hover:bg-red-600 text-white">
                     <i data-lucide="log-out"></i><span>Sign Out</span>
                 </button>
                 <div class="text-xs text-slate-500">
                     <p>&copy; 2025 RSG MANAGER ADMIN. All rights reserved.Developed By Mathizz</p>
                     <p class="mt-1">User ID: <span id="userId" class="font-mono">Loading...</span></p>
                 </div>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto">
            <section id="page-vehicles" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Vehicle Management</h2>
                    <div class="flex items-center gap-4">
                         <div class="bg-slate-800 p-3 rounded-lg text-center">
                             <h3 class="text-sm text-slate-400">Total Vehicle Expenses</h3>
                             <p id="totalVehicleExpensesDisplay" class="text-xl font-bold text-red-400 mt-1">€ 0</p>
                         </div>
                        <button id="addVehicleBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center gap-2 h-full">
                            <i data-lucide="plus"></i> Add New Vehicle
                        </button>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-lg p-4 mb-6 flex items-end gap-4">
                     <div class="flex-1">
                         <label for="searchByNumber" class="block mb-2 text-sm font-medium">Search by Vehicle Number</label>
                         <input type="text" id="searchByNumber" placeholder="Enter vehicle number..." class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                     </div>
                     <div class="flex-1">
                         <label for="filterType" class="block mb-2 text-sm font-medium">Filter by Type</label>
                         <select id="filterType" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5">
                             <option value="">All Types</option>
                             <option value="Van">Van</option>
                             <option value="Car">Car</option>
                             <option value="Lorry">Lorry</option>
                             <option value="Motorbike">Motorbike</option>
                             <option value="Other">Other</option>
                         </select>
                     </div>
                     <div>
                         <button id="clearFiltersBtn" class="bg-slate-600 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-slate-500 transition">Clear</button>
                     </div>
                </div>

                <div class="bg-slate-800 rounded-lg overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-700">
                            <tr>
                                <th class="p-4 font-semibold text-white">Photo</th>
                                <th class="p-4 font-semibold text-white">Vehicle Number</th>
                                <th class="p-4 font-semibold text-white">Model</th>
                                <th class="p-4 font-semibold text-white">Type</th>
                                <th class="p-4 font-semibold text-white">Total Expenses</th>
                                <th class="p-4 font-semibold text-white">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vehicleTableBody">
                            <tr><td colspan="6" class="text-center p-8 text-slate-400">Loading vehicle data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="vehicleModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-2xl transform transition-all modal-content scale-95 opacity-0" id="vehicle-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="vehicleModalTitle" class="text-2xl font-bold text-white">Add New Vehicle</h3>
                <button id="closeVehicleModalBtn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <form id="vehicleForm">
                <input type="hidden" id="vehicleDocId">
                <div class="flex items-center gap-6 mb-6">
                    <div>
                        <label class="block mb-2 text-sm font-medium">Vehicle Photo</label>
                        <img id="vehiclePhotoPreview" src="https://placehold.co/100x100/334155/94a3b8?text=Photo" class="w-24 h-24 rounded-lg object-cover mb-2" alt="Preview">
                        <label for="vehiclePhotoFile" class="file-input-label">Choose Photo</label>
                        <input type="file" id="vehiclePhotoFile" class="file-input" accept="image/*">
                    </div>
                    <div class="flex-1">
                         <div class="mb-4">
                             <label for="vehicleNumber" class="block mb-2 text-sm font-medium">Vehicle Number</label>
                             <input type="text" id="vehicleNumber" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5" required>
                         </div>
                        <div class="mb-4">
                            <label for="vehicleModel" class="block mb-2 text-sm font-medium">Model</label>
                            <input type="text" id="vehicleModel" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5" required>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="vehicleType" class="block mb-2 text-sm font-medium">Vehicle Type</label>
                    <select id="vehicleType" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-2.5" required>
                        <option value="" disabled selected>Select a type</option>
                        <option value="Van">Van</option>
                        <option value="Car">Car</option>
                        <option value="Lorry">Lorry</option>
                        <option value="Motorbike">Motorbike</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancelVehicleModalBtn" class="px-6 py-2 rounded-lg bg-slate-600 hover:bg-slate-700">Cancel</button>
                    <button type="submit" id="submitVehicleBtn" class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold flex items-center">
                        <span id="submitVehicleBtnText">Save Vehicle</span>
                        <div id="submitVehicleSpinner" class="loader w-5 h-5 ml-2 hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="expenseModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-lg transform transition-all modal-content scale-95 opacity-0" id="expense-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="expenseModalTitle" class="text-2xl font-bold text-white">Add Expense</h3>
                <button id="closeExpenseModalBtn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <form id="expenseForm">
                <input type="hidden" id="expenseVehicleId">
                <input type="hidden" id="expenseDocId">
                <div class="mb-4">
                    <label for="expenseType" class="block mb-2 text-sm font-medium">Expense Type</label>
                    <select id="expenseType" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                        <option value="Repair">Repair</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Service">Service</option>
                        <option value="Fuel">Fuel</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="expenseDate" class="block mb-2 text-sm font-medium">Date</label>
                    <input type="date" id="expenseDate" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                </div>
                 <div class="mb-4">
                    <label for="expenseDescription" class="block mb-2 text-sm font-medium">Description</label>
                    <input type="text" id="expenseDescription" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                </div>
                <div class="mb-4">
                    <label for="expenseAmount" class="block mb-2 text-sm font-medium">Amount (€)</label>
                    <input type="number" step="0.01" min="0" id="expenseAmount" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2.5" required>
                </div>
                <div class="mb-4">
                    <label for="expenseBillFile" class="block mb-2 text-sm font-medium">Upload Bill/Receipt</label>
                    <label for="expenseBillFile" class="file-input-label">Choose File</label>
                    <input type="file" id="expenseBillFile" class="file-input" accept="image/*">
                    <span id="expenseBillFileName" class="ml-4 text-slate-400 text-sm">No file chosen</span>
                    <a href="#" id="expenseExistingBillLink" target="_blank" class="text-blue-400 text-sm ml-4 hidden hover:underline">View Existing Bill</a>
                </div>
                
                <div class="mb-4 flex items-center gap-3 bg-slate-700/50 p-3 rounded-lg">
                    <input type="checkbox" id="isFuturePayment" class="w-5 h-5 bg-slate-700 border-slate-600 rounded text-blue-500 focus:ring-blue-500">
                    <label for="isFuturePayment" class="text-sm font-medium select-none cursor-pointer">This is a future/scheduled payment
                         <span id="futurePaymentText" class="block text-xs text-slate-400">(Won't be added to main expenses until its date)</span>
                    </label>
                </div>
                
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancelExpenseModalBtn" class="px-6 py-2 rounded-lg bg-slate-600 hover:bg-slate-700">Cancel</button>
                    <button type="submit" id="submitExpenseBtn" class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold flex items-center">
                        <span id="submitExpenseBtnText">Save Expense</span>
                        <div id="submitExpenseSpinner" class="loader w-5 h-5 ml-2 hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="logModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-slate-800 rounded-lg p-8 w-full max-w-4xl transform transition-all modal-content scale-95 opacity-0" id="log-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="logModalTitle" class="text-2xl font-bold text-white">Expense Log</h3>
                <button id="closeLogModalBtn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div class="max-h-[60vh] overflow-y-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-700 sticky top-0">
                        <tr>
                            <th class="p-4 font-semibold text-white">Date</th>
                            <th class="p-4 font-semibold text-white">Type</th>
                            <th class="p-4 font-semibold text-white">Description</th>
                            <th class="p-4 font-semibold text-white">Bill</th>
                            <th class="p-4 font-semibold text-white">Amount (€)</th>
                            <th class="p-4 font-semibold text-white">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="billViewModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-[60]">
        <div class="bg-slate-800 rounded-lg p-4 w-full max-w-3xl max-h-[90vh] flex flex-col transform transition-all scale-95 opacity-0" id="bill-view-modal-content">
             <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl font-bold text-white">Bill Viewer</h3>
                 <button id="closeBillViewModalBtn" class="text-slate-400 hover:text-white text-3xl">&times;</button>
             </div>
             <div class="flex-1 overflow-auto">
                 <img id="billImagePreview" src="" class="max-w-full h-auto mx-auto" alt="Bill Preview">
             </div>
         </div>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc, updateDoc, query, where, getDocs, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
             apiKey: "AIzaSyCkKqLZFM4sm5jdbR1NVhhVy9IhUeDXOWc",
            authDomain: "rsgweb-5f36d.firebaseapp.com",
            projectId: "rsgweb-5f36d",
            storageBucket: "rsgweb-5f36d.firebasestorage.app",
            messagingSenderId: "633023905515",
            appId: "1:633023905515:web:3b1ae3ebc44eefc59748ae",
        };
        
        const IMGBB_API_KEY = "9960ed5927a4c5187a7b6dd2db60ecff";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = null;
        let allVehicles = [];
        let allExpenses = []; // Holds vehicle_expenses

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const signOutBtn = document.getElementById('signOutBtn');
        const userIdSpan = document.getElementById('userId');
        const toast = document.getElementById('toast');
        const vehicleTableBody = document.getElementById('vehicleTableBody');
        const searchByNumber = document.getElementById('searchByNumber');
        const filterType = document.getElementById('filterType');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const totalVehicleExpensesDisplay = document.getElementById('totalVehicleExpensesDisplay'); 
        
        // Vehicle Modal
        const vehicleModal = document.getElementById('vehicleModal');
        const vehicleModalContent = document.getElementById('vehicle-modal-content');
        const vehicleModalTitle = document.getElementById('vehicleModalTitle');
        const addVehicleBtn = document.getElementById('addVehicleBtn');
        const closeVehicleModalBtn = document.getElementById('closeVehicleModalBtn');
        const cancelVehicleModalBtn = document.getElementById('cancelVehicleModalBtn');
        const vehicleForm = document.getElementById('vehicleForm');
        const submitVehicleBtn = document.getElementById('submitVehicleBtn');
        const submitVehicleBtnText = document.getElementById('submitVehicleBtnText');
        const submitVehicleSpinner = document.getElementById('submitVehicleSpinner');
        const vehiclePhotoInput = document.getElementById('vehiclePhotoFile');
        const vehiclePhotoPreview = document.getElementById('vehiclePhotoPreview');

        // Expense Modal
        const expenseModal = document.getElementById('expenseModal');
        const expenseModalContent = document.getElementById('expense-modal-content');
        const expenseModalTitle = document.getElementById('expenseModalTitle');
        const closeExpenseModalBtn = document.getElementById('closeExpenseModalBtn');
        const cancelExpenseModalBtn = document.getElementById('cancelExpenseModalBtn');
        const expenseForm = document.getElementById('expenseForm');
        const expenseTypeSelect = document.getElementById('expenseType'); // === ALUTH ===
        const futurePaymentText = document.getElementById('futurePaymentText'); // === ALUTH ===
        const submitExpenseBtn = document.getElementById('submitExpenseBtn');
        const submitExpenseBtnText = document.getElementById('submitExpenseBtnText');
        const submitExpenseSpinner = document.getElementById('submitExpenseSpinner');
        const expenseBillFileInput = document.getElementById('expenseBillFile'); 
        const expenseBillFileNameSpan = document.getElementById('expenseBillFileName'); 
        const expenseExistingBillLink = document.getElementById('expenseExistingBillLink');
        const isFuturePaymentCheckbox = document.getElementById('isFuturePayment');
        
        // Log Modal
        const logModal = document.getElementById('logModal');
        const logModalContent = document.getElementById('log-modal-content');
        const logModalTitle = document.getElementById('logModalTitle');
        const closeLogModalBtn = document.getElementById('closeLogModalBtn');
        const logTableBody = document.getElementById('logTableBody');

        // Bill Viewer Modal
        const billViewModal = document.getElementById('billViewModal');
        const billViewModalContent = document.getElementById('bill-view-modal-content');
        const closeBillViewModalBtn = document.getElementById('closeBillViewModalBtn');
        const billImagePreview = document.getElementById('billImagePreview');

        // --- Auth ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdSpan.textContent = currentUserId.substring(0, 10) + '...';
                appContainer.classList.remove('hidden');
                listenForVehicles();
                listenForExpenses(); 
            } else {
                window.location.href = './index.html';
            }
        });
        
        signOutBtn.addEventListener('click', () => signOut(auth));

        // --- Toast & File Upload ---
        const showToast = (message, isSuccess = true) => {
            toast.textContent = message;
            toast.className = `fixed bottom-10 right-10 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        };
        
        const uploadFile = async (file) => {
            if (!file) return null;
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`Upload failed: ${response.statusText}`);
                const result = await response.json();
                if (result.success) return result.data.url;
                throw new Error(result.error?.message || 'Unknown upload error');
            } catch (error) {
                console.error('Error uploading file:', error);
                showToast(`File upload failed: ${error.message}`, false);
                return null;
            }
        };

        // --- Data Listeners ---
        function listenForVehicles() {
            if(!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/vehicles`), snapshot => {
                allVehicles = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                applyFiltersAndRender();
            }, error => {
                console.error("Error listening for vehicles:", error);
                showToast("Error loading vehicle data.", false);
            });
        }
        
        async function listenForExpenses() {
             if(!currentUserId) return;
             onSnapshot(collection(db, `users/${currentUserId}/vehicle_expenses`), async (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                await processDueExpenses(); 
                applyFiltersAndRender();
                updateTotalExpensesDisplay(); 
             }, error => {
                 console.error("Error listening for vehicle expenses:", error);
                 showToast("Error loading vehicle expense data.", false);
             });
        }
        
        async function processDueExpenses() {
            if (!allVehicles.length) return; 

            const now = new Date();
            const dueExpenses = allExpenses.filter(e => e.isFuturePayment && e.date?.toDate() <= now);

            if (dueExpenses.length === 0) return; 

            console.log(`Processing ${dueExpenses.length} due vehicle expenses...`);
            
            try {
                const batch = writeBatch(db);
                const transactionsCol = collection(db, `users/${currentUserId}/transactions`);
                let processedCount = 0;

                for (const ex of dueExpenses) {
                    const vehicle = allVehicles.find(v => v.id === ex.vehicleId);
                    const vehicleNumber = vehicle ? vehicle.number : 'Unknown Vehicle';

                    const mainTransactionData = {
                          date: ex.date,
                          description: `Vehicle Expense: ${vehicleNumber} - ${ex.description}`,
                          category: "Vehicle",
                          type: "Expense",
                          amount: ex.amount,
                          paymentMethod: "N/A",
                          vehicleExpenseId: ex.id 
                    };
                    if (ex.billUrl) {
                        mainTransactionData.billUrl = ex.billUrl; 
                    }

                    const newTransactionRef = doc(transactionsCol); 
                    batch.set(newTransactionRef, mainTransactionData);

                    const vehicleExpenseRef = doc(db, `users/${currentUserId}/vehicle_expenses`, ex.id);
                    batch.update(vehicleExpenseRef, { isFuturePayment: false });
                    
                    if (ex.scheduleEventId) {
                        const scheduleRef = doc(db, `users/${currentUserId}/schedule`, ex.scheduleEventId);
                        batch.update(scheduleRef, { status: 'Completed' });
                    }

                    processedCount++;
                }

                await batch.commit(); 
                if (processedCount > 0) {
                     showToast(`Successfully processed ${processedCount} due vehicle payment(s)!`, true);
                }
            } catch (error) {
                 console.error("Error processing due expenses:", error);
                 showToast("Error processing due payments.", false);
            }
        }
        
        function updateTotalExpensesDisplay() {
            const total = allExpenses
                .filter(e => !e.isFuturePayment) 
                .reduce((sum, e) => sum + (e.amount || 0), 0);
            totalVehicleExpensesDisplay.textContent = `€ ${total.toLocaleString()}`;
        }

        // --- Main Table Render & Filter ---
        function applyFiltersAndRender() {
            const searchTerm = searchByNumber.value.toLowerCase();
            const type = filterType.value;
            
            let filteredVehicles = allVehicles;
            if (searchTerm) {
                filteredVehicles = filteredVehicles.filter(v => v.number && v.number.toLowerCase().includes(searchTerm));
            }
            if (type) {
                filteredVehicles = filteredVehicles.filter(v => v.type === type);
            }
            renderVehicleTable(filteredVehicles);
        }
        
        function renderVehicleTable(vehicleList) {
            vehicleTableBody.innerHTML = '';
            if (!vehicleList || vehicleList.length === 0) { 
                vehicleTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-400">No vehicles found matching criteria.</td></tr>`;
                return;
            }
            
            vehicleList.forEach(vehicle => {
                const vehicleExpenses = vehicle && vehicle.id 
                    ? allExpenses.filter(e => e.vehicleId === vehicle.id && !e.isFuturePayment) 
                    : [];
                const totalSpent = vehicleExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                
                const row = vehicleTableBody.insertRow();
                row.className = "border-b border-slate-700 hover:bg-slate-700/50 align-middle";
                row.innerHTML = `
                    <td class="p-2"><img src="${vehicle.photoUrl || 'https://placehold.co/40x40/334155/94a3b8?text=?'}" class="w-10 h-10 rounded-md object-cover"></td>
                    <td class="p-4 font-mono">${vehicle.number || 'N/A'}</td>
                    <td class="p-4">${vehicle.model || 'N/A'}</td>
                    <td class="p-4">${vehicle.type || 'N/A'}</td>
                    <td class="p-4 font-semibold text-red-400">€ ${totalSpent.toLocaleString()}</td>
                    <td class="p-4 flex items-center gap-2">
                       <button data-id="${vehicle.id}" class="edit-vehicle-btn text-blue-400 hover:text-blue-300" title="Edit Vehicle"><i data-lucide="edit" class="w-5 h-5 pointer-events-none"></i></button>
                       <button data-id="${vehicle.id}" class="delete-vehicle-btn text-red-400 hover:text-red-300" title="Delete Vehicle"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
                       <button data-id="${vehicle.id}" data-name="${vehicle.number || 'N/A'}" class="view-log-btn text-green-400 hover:text-green-300" title="View Expense Log"><i data-lucide="list" class="w-5 h-5 pointer-events-none"></i></button>
                       <button data-id="${vehicle.id}" data-name="${vehicle.number || 'N/A'}" class="add-expense-btn bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded-md" title="Add Expense">Add Expense</button>
                    </td>
                `;
            });
            lucide.createIcons();
        }
        
        searchByNumber.addEventListener('input', applyFiltersAndRender);
        filterType.addEventListener('change', applyFiltersAndRender);
        clearFiltersBtn.addEventListener('click', () => {
            searchByNumber.value = '';
            filterType.value = '';
            applyFiltersAndRender();
        });

        // --- Vehicle Modal (Add/Edit) ---
        vehiclePhotoInput.addEventListener('change', () => {
            const file = vehiclePhotoInput.files[0];
            if (file) {
                vehiclePhotoPreview.src = URL.createObjectURL(file);
            }
        });

        const openVehicleModal = async (docId = null) => {
            vehicleForm.reset();
            vehiclePhotoPreview.src = 'https://placehold.co/100x100/334155/94a3b8?text=Photo';
            document.getElementById('vehicleDocId').value = docId || '';

            if (docId) {
                vehicleModalTitle.textContent = 'Edit Vehicle';
                submitVehicleBtnText.textContent = 'Update';
                 try {
                     const docRef = doc(db, `users/${currentUserId}/vehicles`, docId);
                     const docSnap = await getDoc(docRef);
                     if (docSnap.exists()) {
                         const v = docSnap.data();
                         document.getElementById('vehicleNumber').value = v.number || '';
                         document.getElementById('vehicleModel').value = v.model || '';
                         document.getElementById('vehicleType').value = v.type || '';
                         if(v.photoUrl) vehiclePhotoPreview.src = v.photoUrl;
                     } else {
                         showToast("Vehicle not found.", false);
                         return; 
                     }
                 } catch (error) {
                     console.error("Error fetching vehicle for edit:", error);
                     showToast("Error loading vehicle data.", false);
                     return;
                 }
            } else {
                vehicleModalTitle.textContent = 'Add New Vehicle';
                submitVehicleBtnText.textContent = 'Save Vehicle';
            }
            vehicleModal.classList.remove('hidden');
            setTimeout(() => vehicleModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };
        
        const closeVehicleModal = () => {
            vehicleModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => vehicleModal.classList.add('hidden'), 200);
        };
        
        addVehicleBtn.addEventListener('click', () => openVehicleModal());
        closeVehicleModalBtn.addEventListener('click', closeVehicleModal);
        cancelVehicleModalBtn.addEventListener('click', closeVehicleModal);
        vehicleModal.addEventListener('click', (e) => { if(e.target === vehicleModal) closeVehicleModal(); });

        vehicleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUserId) return;
            
            submitVehicleBtn.disabled = true;
            submitVehicleBtnText.classList.add('hidden');
            submitVehicleSpinner.classList.remove('hidden');
            
            try {
                const docId = document.getElementById('vehicleDocId').value;
                const data = {
                    number: document.getElementById('vehicleNumber').value.trim(),
                    model: document.getElementById('vehicleModel').value.trim(),
                    type: document.getElementById('vehicleType').value
                };

                if (!data.number || !data.model || !data.type) {
                     showToast("Please fill all required vehicle details.", false);
                     throw new Error("Missing vehicle details");
                }
                
                const photoFile = vehiclePhotoInput.files[0];
                let existingPhotoUrl = null;
                 if (docId) { 
                     const docSnap = await getDoc(doc(db, `users/${currentUserId}/vehicles`, docId));
                     if (docSnap.exists()) existingPhotoUrl = docSnap.data().photoUrl;
                 }

                if (photoFile) {
                    const photoUrl = await uploadFile(photoFile);
                    if(photoUrl) data.photoUrl = photoUrl;
                     else throw new Error("Photo upload failed"); 
                } else if (docId && existingPhotoUrl) {
                     data.photoUrl = existingPhotoUrl; 
                 } else {
                     delete data.photoUrl; 
                 }

                
                if (docId) {
                    await updateDoc(doc(db, `users/${currentUserId}/vehicles`, docId), data);
                    showToast('Vehicle updated!');
                } else {
                    data.createdAt = new Date();
                    await addDoc(collection(db, `users/${currentUserId}/vehicles`), data);
                    showToast('Vehicle added!');
                }
                closeVehicleModal();
            } catch (error) {
                 if (error.message !== "Missing vehicle details" && error.message !== "Photo upload failed") {
                     showToast(`Error: ${error.message}`, false);
                 }
                console.error("Error saving vehicle:", error);
            } finally {
                submitVehicleBtn.disabled = false;
                submitVehicleBtnText.classList.remove('hidden');
                submitVehicleSpinner.classList.add('hidden');
            }
        });
        
        // --- Expense Modal (Add/Edit) ---
        
        // === ALUTH FUNCTION EKA (Expense Type change weddi text eka wenas karanna) ===
        function updateFuturePaymentText() {
            if (expenseTypeSelect.value === 'Insurance') {
                futurePaymentText.textContent = "(This will create a YEARLY recurring event in the schedule)";
            } else {
                futurePaymentText.textContent = "(Won't be added to main expenses until its date)";
            }
        }
        expenseTypeSelect.addEventListener('change', updateFuturePaymentText);
        isFuturePaymentCheckbox.addEventListener('change', updateFuturePaymentText);
        // === END ALUTH FUNCTION ===


        expenseBillFileInput.addEventListener('change', () => { 
            expenseBillFileNameSpan.textContent = expenseBillFileInput.files[0]?.name || 'No file chosen'; 
            expenseExistingBillLink.classList.add('hidden'); 
            expenseExistingBillLink.href = '#'; 
        });
        
        const openExpenseModal = async (vehicleId, vehicleName, expenseDocId = null) => {
            expenseForm.reset();
            expenseBillFileNameSpan.textContent = 'No file chosen'; 
            expenseExistingBillLink.classList.add('hidden'); 
            expenseExistingBillLink.href = '#'; 
            document.getElementById('expenseVehicleId').value = vehicleId;
            document.getElementById('expenseDocId').value = expenseDocId || '';
            isFuturePaymentCheckbox.checked = false; 
            
            if (expenseDocId) {
                expenseModalTitle.textContent = `Edit Expense for ${vehicleName}`;
                submitExpenseBtnText.textContent = 'Update';
                 try {
                     const docRef = doc(db, `users/${currentUserId}/vehicle_expenses`, expenseDocId);
                     const docSnap = await getDoc(docRef);
                     if (docSnap.exists()) {
                         const ex = docSnap.data();
                         document.getElementById('expenseType').value = ex.type || 'Other';
                         document.getElementById('expenseDate').value = ex.date?.toDate()?.toISOString()?.split('T')[0] || '';
                         document.getElementById('expenseDescription').value = ex.description || '';
                         document.getElementById('expenseAmount').value = ex.amount || 0;
                         isFuturePaymentCheckbox.checked = ex.isFuturePayment || false; 
                         
                         if (ex.billUrl) {
                             expenseBillFileNameSpan.textContent = 'Bill previously uploaded.'; 
                             expenseExistingBillLink.href = ex.billUrl; 
                             expenseExistingBillLink.classList.remove('hidden'); 
                         }
                     } else {
                         showToast("Expense not found.", false);
                         return;
                     }
                 } catch (error) {
                     console.error("Error fetching expense for edit:", error);
                     showToast("Error loading expense data.", false);
                     return;
                 }
            } else {
                expenseModalTitle.textContent = `Add Expense for ${vehicleName}`;
                submitExpenseBtnText.textContent = 'Save Expense';
                document.getElementById('expenseDate').valueAsDate = new Date();
            }
            
            updateFuturePaymentText(); // === ALUTH === Modal open karaddi text eka update karanna
            expenseModal.classList.remove('hidden');
            setTimeout(() => expenseModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };
        
        const closeExpenseModal = () => {
            expenseModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => expenseModal.classList.add('hidden'), 200);
        };
        
        closeExpenseModalBtn.addEventListener('click', closeExpenseModal);
        cancelExpenseModalBtn.addEventListener('click', closeExpenseModal);
        expenseModal.addEventListener('click', (e) => { if(e.target === expenseModal) closeExpenseModal(); });

        // === *** EXPENSE SUBMIT LOGIC SAMPURNENMA WENAS KALA (YEARLY RECURRING) *** ===
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUserId) return;
            
            submitExpenseBtn.disabled = true;
            submitExpenseBtnText.classList.add('hidden');
            submitExpenseSpinner.classList.remove('hidden');
            
            const docId = document.getElementById('expenseDocId').value; // vehicle_expense doc id
            const vehicleId = document.getElementById('expenseVehicleId').value;
            const expenseDate = document.getElementById('expenseDate').value;
            const expenseAmount = parseFloat(document.getElementById('expenseAmount').value);
            const expenseType = document.getElementById('expenseType').value;
            const expenseDescription = document.getElementById('expenseDescription').value.trim();
            const billFile = expenseBillFileInput.files[0];
            const isFuture = isFuturePaymentCheckbox.checked;

             if (!vehicleId || !expenseDate || isNaN(expenseAmount) || expenseAmount < 0 || !expenseType || !expenseDescription) {
                 showToast("Please fill all required expense fields with valid values.", false);
                 submitExpenseBtn.disabled = false;
                 submitExpenseBtnText.classList.remove('hidden');
                 submitExpenseSpinner.classList.add('hidden');
                 return;
             }

            try {
                const vehicle = allVehicles.find(v => v.id === vehicleId);
                const vehicleNumber = vehicle ? vehicle.number : 'Unknown Vehicle';
                const batch = writeBatch(db);

                // --- LOGIC 1: ALUTH, FUTURE, INSURANCE (YEARLY RECURRING) ---
                if (!docId && isFuture && expenseType === 'Insurance') {
                    const recurringId = crypto.randomUUID();
                    const baseDate = new Date(expenseDate);
                    let uploadedBillUrl = null;

                    // Bill eka upload karanne palaweni entry ekata witharai
                    if (billFile) {
                        uploadedBillUrl = await uploadFile(billFile);
                        if (!uploadedBillUrl) throw new Error("Bill upload failed");
                    }

                    for (let i = 0; i < 10; i++) { // Awurudu 10kata add karanna
                        const eventDate = new Date(baseDate);
                        eventDate.setFullYear(baseDate.getFullYear() + i);

                        const newVehicleExpenseRef = doc(collection(db, `users/${currentUserId}/vehicle_expenses`));
                        const newScheduleRef = doc(collection(db, `users/${currentUserId}/schedule`));

                        // 1. Vehicle Expense Data
                        const vehicleExpenseData = {
                            vehicleId: vehicleId,
                            type: expenseType,
                            date: Timestamp.fromDate(eventDate),
                            description: expenseDescription,
                            amount: expenseAmount,
                            isFuturePayment: true,
                            scheduleEventId: newScheduleRef.id,
                            recurringId: recurringId
                        };
                        if (i === 0 && uploadedBillUrl) {
                            vehicleExpenseData.billUrl = uploadedBillUrl; // Add bill only to the first one
                        }

                        // 2. Schedule Event Data
                        const scheduleEventData = {
                            title: `Insurance: ${vehicleNumber}`,
                            description: expenseDescription,
                            date: Timestamp.fromDate(eventDate),
                            color: 'bg-red-500',
                            type: 'Expense',
                            amount: expenseAmount,
                            category: 'Vehicle Insurance',
                            status: 'Pending',
                            vehicleExpenseId: newVehicleExpenseRef.id,
                            recurringId: recurringId
                        };

                        // 3. Batch ekata add karanna
                        batch.set(newVehicleExpenseRef, vehicleExpenseData);
                        batch.set(newScheduleRef, scheduleEventData);
                    }
                    
                    await batch.commit();
                    showToast('Yearly insurance scheduled for 10 years!');
                
                } else {
                    // --- LOGIC 2: ANITH OKKOMA (EDITING or NORMAL ADD) ---
                    
                    // 1. Prepare data
                    const vehicleExpenseData = {
                        vehicleId: vehicleId,
                        type: expenseType,
                        date: Timestamp.fromDate(new Date(expenseDate)),
                        description: expenseDescription,
                        amount: expenseAmount,
                        isFuturePayment: isFuture
                    };
                    
                    // 2. Bill Handle
                    let existingVehicleExpenseUrl = null;
                    let existingScheduleEventId = null; 
                    if (docId) { 
                        const docSnap = await getDoc(doc(db, `users/${currentUserId}/vehicle_expenses`, docId));
                        if (docSnap.exists()) {
                            existingVehicleExpenseUrl = docSnap.data().billUrl;
                            existingScheduleEventId = docSnap.data().scheduleEventId; 
                            vehicleExpenseData.recurringId = docSnap.data().recurringId || null; // recurringId eka thiyaganna
                        }
                    }

                    if (billFile) {
                        const billUrl = await uploadFile(billFile);
                        if (billUrl) {
                            vehicleExpenseData.billUrl = billUrl;
                        } else {
                            throw new Error("Bill upload failed");
                        }
                    } else if (docId && existingVehicleExpenseUrl) {
                        vehicleExpenseData.billUrl = existingVehicleExpenseUrl;
                    } else {
                        delete vehicleExpenseData.billUrl;
                    }
                    
                    // 4. Refs
                    const vehicleExpenseRef = docId 
                        ? doc(db, `users/${currentUserId}/vehicle_expenses`, docId)
                        : doc(collection(db, `users/${currentUserId}/vehicle_expenses`));

                    // 5. Sync Logic (Schedule & Transactions)
                    const transQuery = query(collection(db, `users/${currentUserId}/transactions`), where("vehicleExpenseId", "==", vehicleExpenseRef.id));
                    const transactionSnapshot = await getDocs(transQuery);

                    if (isFuture && expenseType === 'Insurance') {
                        // --- CASE A: Scheduled Insurance ---
                        const scheduleEventData = {
                            title: `Insurance: ${vehicleNumber}`,
                            description: expenseDescription,
                            date: vehicleExpenseData.date,
                            color: 'bg-red-500', 
                            type: 'Expense',
                            amount: vehicleExpenseData.amount,
                            category: 'Vehicle Insurance',
                            status: 'Pending',
                            vehicleExpenseId: vehicleExpenseRef.id,
                            recurringId: vehicleExpenseData.recurringId || null
                        };

                        if (existingScheduleEventId) {
                            const scheduleRef = doc(db, `users/${currentUserId}/schedule`, existingScheduleEventId);
                            batch.update(scheduleRef, scheduleEventData);
                            vehicleExpenseData.scheduleEventId = existingScheduleEventId; 
                        } else {
                            // Me block eka wenna baha aluth logic ekedi, eth fallback ekak widihata thiyagamu
                            const newScheduleRef = doc(collection(db, `users/${currentUserId}/schedule`));
                            batch.set(newScheduleRef, scheduleEventData);
                            vehicleExpenseData.scheduleEventId = newScheduleRef.id; 
                        }
                        transactionSnapshot.forEach(doc => { batch.delete(doc.ref); });

                    } else {
                        // --- CASE B: NOT a Scheduled Insurance ---
                        if (existingScheduleEventId) {
                            const scheduleRef = doc(db, `users/${currentUserId}/schedule`, existingScheduleEventId);
                            batch.delete(scheduleRef);
                            delete vehicleExpenseData.scheduleEventId; 
                        }

                        if (!isFuture) {
                            // Normal expense -> Add/Update transaction
                            const mainTransactionData = {
                                date: vehicleExpenseData.date,
                                description: `Vehicle Expense: ${vehicleNumber} - ${expenseDescription}`,
                                category: "Vehicle",
                                type: "Expense",
                                amount: vehicleExpenseData.amount,
                                paymentMethod: "N/A", 
                                vehicleExpenseId: vehicleExpenseRef.id,
                                billUrl: vehicleExpenseData.billUrl || null
                            };
                            if (!mainTransactionData.billUrl) delete mainTransactionData.billUrl;
                            
                            if (!transactionSnapshot.empty) {
                                batch.update(transactionSnapshot.docs[0].ref, mainTransactionData);
                            } else {
                                const newTransactionRef = doc(collection(db, `users/${currentUserId}/transactions`));
                                batch.set(newTransactionRef, mainTransactionData);
                            }
                        } else {
                            // Future but not insurance -> Delete transaction
                            transactionSnapshot.forEach(doc => { batch.delete(doc.ref); });
                        }
                    }
                    
                    // 6. Save Vehicle Expense
                    if (docId) {
                        batch.update(vehicleExpenseRef, vehicleExpenseData);
                        showToast('Expense updated in all logs!');
                    } else {
                        batch.set(vehicleExpenseRef, vehicleExpenseData);
                        showToast('Expense added to all logs!');
                    }
                    
                    // 7. Commit Batch
                    await batch.commit();
                }

                closeExpenseModal();
                
            } catch (error) {
                 if (error.message !== "Bill upload failed") {
                     showToast(`Error: ${error.message}`, false);
                 }
                console.error("Error saving expense:", error);
            } finally {
                submitExpenseBtn.disabled = false;
                submitExpenseBtnText.classList.remove('hidden');
                submitExpenseSpinner.classList.add('hidden');
            }
        });
        
        // --- View Log Modal (Per Vehicle) ---
        const openLogModal = (vehicleId, vehicleName) => {
            logModalTitle.textContent = `Expense Log for ${vehicleName}`;
            logTableBody.innerHTML = '';
            
            const vehicleExpenses = allExpenses
                .filter(e => e.vehicleId === vehicleId)
                .sort((a,b) => (b.date?.toDate() || 0) - (a.date?.toDate() || 0)); 
            
            if (vehicleExpenses.length === 0) {
                logTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-400">No expenses found for this vehicle.</td></tr>`;
            } else {
                vehicleExpenses.forEach(ex => {
                    const row = logTableBody.insertRow();
                    
                    const billHTML = ex.billUrl ? `<button data-url="${ex.billUrl}" class="view-bill-btn bg-slate-600 hover:bg-slate-500 text-white text-xs px-2 py-1 rounded-md">View Bill</button>` : '<span class="text-slate-500">N/A</span>';
                    
                    const typeClass = ex.type === 'Insurance' ? 'font-bold' : '';
                    // === VENAS KALA (Recurring tag) ===
                    const insuranceTag = ex.recurringId ? '<span class="ml-2 bg-yellow-600 text-yellow-100 text-xs font-medium px-2 py-0.5 rounded-full">RECURRING</span>' : (ex.type === 'Insurance' ? '<span class="ml-2 bg-yellow-600 text-yellow-100 text-xs font-medium px-2 py-0.5 rounded-full">INS</span>' : '');
                    const dateString = ex.date && ex.date.toDate ? ex.date.toDate().toLocaleDateString() : 'Invalid Date';

                    const isStillFuture = ex.isFuturePayment && ex.date.toDate() > new Date();
                    const futureRowClass = isStillFuture ? 'future-payment-row' : '';
                    const futureTag = isStillFuture ? '<span class="ml-2 bg-blue-600 text-blue-100 text-xs font-medium px-2 py-0.5 rounded-full">SCHEDULED</span>' : '';
                    
                    row.className = `border-b border-slate-700 hover:bg-slate-700/50 ${futureRowClass}`;

                    row.innerHTML = `
                        <td class="p-4">${dateString} ${futureTag}</td>
                        <td class="p-4 ${typeClass}">${ex.type || 'N/A'} ${insuranceTag}</td>
                        <td class="p-4">${ex.description || 'N/A'}</td>
                        <td class="p-4">${billHTML}</td>
                        <td class="p-4">${(ex.amount || 0).toLocaleString()}</td>
                        <td class="p-4 flex gap-2">
                            <button data-id="${ex.id}" data-vid="${vehicleId}" data-vname="${vehicleName}" class="edit-expense-btn text-blue-400 hover:text-blue-300"><i data-lucide="edit" class="w-5 h-5 pointer-events-none"></i></button>
                            <button data-id="${ex.id}" class="delete-expense-btn text-red-400 hover:text-red-300"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
                        </td>
                    `;
                });
            }
            logModal.classList.remove('hidden');
            setTimeout(() => logModalContent.classList.remove('scale-95', 'opacity-0'), 10);
            lucide.createIcons();
        };

        const closeLogModal = () => {
            logModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => logModal.classList.add('hidden'), 200);
        };
        closeLogModalBtn.addEventListener('click', closeLogModal);


        // --- Bill Viewer Modal ---
        const openBillViewModal = (url) => {
            if (!url) return; 
            billImagePreview.src = url;
            billViewModal.classList.remove('hidden');
            setTimeout(() => billViewModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };
        const closeBillViewModal = () => {
            billViewModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                billViewModal.classList.add('hidden');
                billImagePreview.src = '';
            }, 200);
        };
        closeBillViewModalBtn.addEventListener('click', closeBillViewModal);
        billViewModal.addEventListener('click', (e) => { if (e.target === billViewModal) closeBillViewModal(); });

        // --- Event Delegation for Tables ---
        vehicleTableBody.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-vehicle-btn');
            if (editBtn) openVehicleModal(editBtn.dataset.id);
            
            const deleteBtn = e.target.closest('.delete-vehicle-btn');
            if (deleteBtn) deleteVehicle(deleteBtn.dataset.id);
            
            const logBtn = e.target.closest('.view-log-btn');
            if (logBtn) openLogModal(logBtn.dataset.id, logBtn.dataset.name);
            
            const expenseBtn = e.target.closest('.add-expense-btn');
            if (expenseBtn) openExpenseModal(expenseBtn.dataset.id, expenseBtn.dataset.name);
        });
        
        logTableBody.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-expense-btn');
            if (editBtn) {
                openExpenseModal(editBtn.dataset.vid, editBtn.dataset.vname, editBtn.dataset.id);
            }
            const deleteBtn = e.target.closest('.delete-expense-btn');
            if (deleteBtn) deleteExpense(deleteBtn.dataset.id);

            const billBtn = e.target.closest('.view-bill-btn');
            if(billBtn) openBillViewModal(billBtn.dataset.url);
        });
        
        // --- Delete Functions ---
        async function deleteVehicle(docId) {
             if (!docId) return; 
             if (confirm('Are you sure you want to delete this vehicle? This will also delete ALL its expenses from ALL logs (Expenses, Transactions, and Schedule)!')) {
                 try {
                     const batch = writeBatch(db); 
                     const qExpenses = query(collection(db, `users/${currentUserId}/vehicle_expenses`), where("vehicleId", "==", docId));
                     const expenseSnapshot = await getDocs(qExpenses);
                     const expenseIds = [];
                     
                     expenseSnapshot.forEach(doc => {
                         const expenseData = doc.data();
                         if (expenseData.scheduleEventId) {
                             batch.delete(doc(db, `users/${currentUserId}/schedule`, expenseData.scheduleEventId));
                         }
                         expenseIds.push(doc.id);
                         batch.delete(doc.ref); 
                     });

                     if (expenseIds.length > 0) {
                         const qTransactions = query(collection(db, `users/${currentUserId}/transactions`), where("vehicleExpenseId", "in", expenseIds));
                         const transactionSnapshot = await getDocs(qTransactions);
                         transactionSnapshot.forEach(doc => {
                             batch.delete(doc.ref); 
                         });
                     }
                     batch.delete(doc(db, `users/${currentUserId}/vehicles`, docId));
                     
                     await batch.commit(); 
                     showToast('Vehicle and all associated records deleted from all logs.');
                 } catch (error) {
                     showToast(`Error: ${error.message}`, false);
                     console.error("Error deleting vehicle and expenses:", error);
                 }
             }
        }
        
        // === *** DELETE EXPENSE LOGIC EKA SAMPURNENMA WENAS KALA (RECURRING) *** ===
        async function deleteExpense(docId) { // docId is from vehicle_expenses
             if (!docId) return; 
             
             try {
                const vehicleExpenseRef = doc(db, `users/${currentUserId}/vehicle_expenses`, docId);
                const vehicleExpenseSnap = await getDoc(vehicleExpenseRef);
                if (!vehicleExpenseSnap.exists()) {
                    showToast("Expense not found.", false);
                    return;
                }
                const vehicleExpenseData = vehicleExpenseSnap.data();
                const recurringId = vehicleExpenseData.recurringId;
                
                let deleteFuture = false;
                let deleteOne = false;

                if (recurringId) {
                    if (confirm('This is a RECURRING expense. Do you want to delete ALL future entries as well? \n\n (Press OK for all, Cancel to delete only this one.)')) {
                        deleteFuture = true;
                    } else if (confirm('Delete ONLY this single entry?')) {
                        deleteOne = true;
                    } else {
                        return; // User cancelled everything
                    }
                } else {
                     if (confirm('Are you sure you want to delete this expense entry from all logs (Expenses, Transactions, and Schedule)?')) {
                         deleteOne = true;
                     } else {
                         return; // User cancelled
                     }
                }

                const batch = writeBatch(db);

                if (deleteFuture) {
                    // --- LOGIC 1: Delete all future recurring ---
                    const qExpenses = query(collection(db, `users/${currentUserId}/vehicle_expenses`), 
                        where("recurringId", "==", recurringId), 
                        where("date", ">=", vehicleExpenseData.date) // This one and all future
                    );
                    const expenseSnapshot = await getDocs(qExpenses);
                    
                    for (const expenseDoc of expenseSnapshot.docs) {
                        const exData = expenseDoc.data();
                        // Delete schedule event
                        if (exData.scheduleEventId) {
                            batch.delete(doc(db, `users/${currentUserId}/schedule`, exData.scheduleEventId));
                        }
                        // Delete transaction (if any)
                        const qTrans = query(collection(db, `users/${currentUserId}/transactions`), where("vehicleExpenseId", "==", expenseDoc.id));
                        const transSnapshot = await getDocs(qTrans);
                        transSnapshot.forEach(tDoc => batch.delete(tDoc.ref));
                        // Delete vehicle expense
                        batch.delete(expenseDoc.ref);
                    }
                    await batch.commit();
                    showToast('All future recurring expenses deleted.');

                } else if (deleteOne) {
                    // --- LOGIC 2: Delete only this single entry ---
                    const q = query(collection(db, `users/${currentUserId}/transactions`), where("vehicleExpenseId", "==", docId));
                    const transactionSnapshot = await getDocs(q);
                    transactionSnapshot.forEach(transactionDoc => {
                        batch.delete(transactionDoc.ref);
                    });

                    if (vehicleExpenseData.scheduleEventId) {
                        const scheduleRef = doc(db, `users/${currentUserId}/schedule`, vehicleExpenseData.scheduleEventId);
                        batch.delete(scheduleRef);
                    }
                    batch.delete(vehicleExpenseRef);
                    
                    await batch.commit(); 
                    showToast('Single expense entry deleted from all logs.');
                }
                
                // Refresh log modal if it's open
                if (!logModal.classList.contains('hidden')) {
                    const logVehicleId = vehicleExpenseData.vehicleId;
                    if(logVehicleId) {
                        const vehicleRef = doc(db, `users/${currentUserId}/vehicles`, logVehicleId);
                        const vehicleSnap = await getDoc(vehicleRef);
                        const vehicleName = vehicleSnap.exists() ? vehicleSnap.data().number : 'Vehicle';
                        openLogModal(logVehicleId, vehicleName); // Refresh modal
                    } else {
                        closeLogModal(); 
                    }
                }

             } catch (error) {
                 showToast(`Error deleting expense: ${error.message}`, false);
                 console.error("Error deleting expense:", error);
             }
        }
        
        lucide.createIcons();
    </script>
</body>
</html>