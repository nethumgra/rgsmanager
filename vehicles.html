<!DOCTYPE html>
<html lang="si" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicles - RSG MANAGER</title>

    <link rel="icon" href="logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .file-input-label {
            display: inline-flex; align-items: center; padding: 8px 16px; font-size: 13px; font-weight: 500;
            background-color: #3b82f6; color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s;
        }
        .file-input-label:hover { background-color: #2563eb; transform: translateY(-1px); }
        .file-input { display: none; }

        tr.hover-row:hover td { background-color: #f1f5f9; } /* Light mode hover darker */
        .dark tr.hover-row:hover td { background-color: #1e293b; }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100px;
            height: 4px;
            background: #cbd5e1;
            border-radius: 5px;
            outline: none;
        }
        .dark input[type=range] { background: #475569; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            transition: background .15s ease-in-out;
        }
        input[type=range]::-webkit-slider-thumb:hover { background: #2563eb; }

        /* Future payment highlight */
        .future-payment-row {
            background-color: rgba(234, 179, 8, 0.1); /* amber-500/10 */
            border-left: 4px solid #eab308; /* amber-500 */
        }
        .dark .future-payment-row {
            background-color: rgba(202, 138, 4, 0.15);
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-300 font-sans transition-colors duration-300">

    <div id="brightness-overlay" class="fixed inset-0 z-[100] pointer-events-none bg-black opacity-0 transition-opacity duration-0 mix-blend-multiply"></div>

    <div id="app-container" class="flex h-screen hidden">
        
        <aside class="w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 p-6 flex-shrink-0 flex flex-col justify-between z-10 shadow-sm transition-colors duration-300">
            <div>
                <div class="flex items-center gap-3 mb-10">
                    <div class="bg-blue-50 dark:bg-slate-700 p-1 rounded-lg transition-colors">
                        <img src="logo.png" alt="Logo" class="w-10 h-10 rounded-lg object-cover">
                    </div>
                    <h1 class="text-xl font-extrabold text-slate-900 dark:text-white tracking-tight">RSG MANAGER</h1>
                </div>
                
                <nav class="flex flex-col gap-1.5">
                   <a href="./index.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>Dashboard</span>
                   </a>
                   <a href="./staff.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="users" class="w-5 h-5"></i><span>Staff Members</span>
                   </a>
                   <a href="./staff_schedule.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="calendar" class="w-5 h-5"></i><span>Staff Schedule</span>
                   </a>
                   <a href="./customers.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="contact" class="w-5 h-5"></i><span>Customers</span>
                   </a>
                   <a href="./properties.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="home" class="w-5 h-5"></i><span>Properties</span>
                   </a>
                   <a href="./income_expenses.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium">
                       <i data-lucide="dollar-sign" class="w-5 h-5"></i><span>Income/Expenses</span>
                   </a>
                   
                   <div class="pt-4 mt-2 border-t border-slate-200 dark:border-slate-700">
                        <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tools</p>
                        <div class="space-y-1">
                            <a href="./scheduled_finance.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="clock" class="w-4 h-4"></i><span>Scheduled</span></a>
                            <a href="./materials.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="boxes" class="w-4 h-4"></i><span>Materials</span></a>
                            <a href="./vehicles.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition bg-blue-50 dark:bg-slate-700 text-blue-700 dark:text-white font-bold shadow-sm"><i data-lucide="car" class="w-4 h-4"></i><span>Vehicles</span></a>
                            <a href="./schedule.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="calendar-check" class="w-4 h-4"></i><span>Schedule</span></a>
                            <a href="./agreements.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="file-check-2" class="w-4 h-4"></i><span>Agreements</span></a>
                            <a href="./invoice.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i><span>Invoices</span></a>
                            <a href="./app_access.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="key-round" class="w-4 h-4"></i><span>App Access</span></a>
                            <a href="./payslips.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="receipt" class="w-4 h-4"></i><span>Payslips</span></a>
                            <a href="./f24.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="file-text" class="w-4 h-4"></i><span>F24 Tax</span></a>
                            <a href="./agreement_generator.html" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-xl transition text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-slate-200 font-medium"><i data-lucide="file-edit" class="w-4 h-4"></i><span>Proposal Gen</span></a>
                        </div>
                   </div>
                </nav>
            </div>
            <div>
                <button id="signOutBtn" class="w-full flex items-center justify-center gap-3 px-4 py-2.5 mb-4 rounded-xl transition bg-slate-100 dark:bg-slate-700 hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-600 text-slate-700 dark:text-slate-300 font-bold group">
                    <i data-lucide="log-out" class="group-hover:text-red-600"></i><span>Sign Out</span>
                </button>
                <div class="text-xs text-slate-500 text-center">
                    <p>&copy; 2025 RSG Multiservice</p>
                    <p class="mt-1">UID: <span id="userId" class="font-mono text-slate-600 dark:text-slate-400">Loading...</span></p>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto flex flex-col">
            <section id="page-vehicles" class="page max-w-7xl mx-auto w-full">
                
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                    <div>
                        <div class="flex items-center gap-3">
                             <h2 class="text-3xl font-bold text-slate-900 dark:text-white">Vehicle Management</h2>
                        </div>
                        <p class="text-slate-600 dark:text-slate-400 text-sm mt-1 font-medium">Manage fleet, expenses, and scheduled maintenance.</p>
                    </div>
                    
                    <div class="flex items-center gap-3">
                         <div class="bg-white dark:bg-slate-800 px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col items-end">
                             <span class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase">Total Expenses</span>
                             <span id="totalVehicleExpensesDisplay" class="text-lg font-extrabold text-red-600 dark:text-red-400">€ 0</span>
                         </div>

                         <div class="flex items-center gap-2 bg-white dark:bg-slate-800 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                             <i data-lucide="sun-dim" class="w-4 h-4 text-slate-500"></i>
                             <input type="range" id="brightness-slider" min="0" max="70" value="0" title="Adjust Brightness (Dimmer)">
                         </div>

                         <button id="theme-toggle" class="p-2.5 rounded-xl bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 shadow-sm border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                            <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                            <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                        </button>

                        <button id="addVehicleBtn" class="bg-slate-900 dark:bg-blue-600 text-white hover:bg-slate-800 dark:hover:bg-blue-500 px-5 py-2.5 rounded-xl text-sm font-bold transition flex items-center gap-2 shadow-lg shadow-slate-900/20 dark:shadow-blue-900/20">
                             <i data-lucide="plus" class="w-4 h-4"></i> Add Vehicle
                        </button>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-1 mb-6 flex items-center justify-between shadow-sm">
                     <div class="flex items-center flex-1 gap-2 p-1">
                         <div class="relative flex-1 max-w-md">
                              <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"></i>
                              <input type="text" id="searchByNumber" placeholder="Search by vehicle number..." class="w-full bg-transparent border-none text-slate-800 dark:text-white text-sm pl-10 pr-3 py-2 focus:ring-0 placeholder-slate-400 font-medium">
                         </div>
                         <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-2"></div>
                         
                         <select id="filterType" class="bg-transparent border-none text-slate-700 dark:text-slate-300 text-sm font-medium focus:ring-0 cursor-pointer hover:text-slate-900 dark:hover:text-white transition">
                             <option value="">All Types</option>
                             <option value="Van">Van</option>
                             <option value="Car">Car</option>
                             <option value="Lorry">Lorry</option>
                             <option value="Motorbike">Motorbike</option>
                             <option value="Other">Other</option>
                         </select>
                     </div>
                     <button id="clearFiltersBtn" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-200 text-xs font-bold px-4 transition">
                         Clear
                     </button>
                </div>

                <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-100 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700">
                                <tr>
                                    <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Photo</th>
                                    <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Vehicle Number</th>
                                    <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Model</th>
                                    <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Type</th>
                                    <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Total Expenses</th>
                                    <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehicleTableBody" class="divide-y divide-slate-100 dark:divide-slate-700">
                                <tr><td colspan="6" class="text-center p-12 text-slate-500 font-medium">Loading vehicle data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="vehicleModal" class="fixed inset-0 bg-slate-900/50 dark:bg-slate-900/80 backdrop-blur-sm flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-2xl transform transition-all scale-95 opacity-0 shadow-2xl border border-slate-100 dark:border-slate-700" id="vehicle-modal-content">
            <div class="flex justify-between items-center mb-8">
                <h3 id="vehicleModalTitle" class="text-2xl font-bold text-slate-900 dark:text-white">Add New Vehicle</h3>
                <button id="closeVehicleModalBtn" class="text-slate-500 hover:text-slate-700 dark:hover:text-white transition bg-slate-100 dark:bg-slate-700 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="vehicleForm">
                <input type="hidden" id="vehicleDocId">
                
                <div class="flex flex-col md:flex-row gap-8 mb-8">
                    <div class="flex flex-col items-center space-y-3">
                         <img id="vehiclePhotoPreview" src="https://placehold.co/100x100/f1f5f9/64748b?text=Photo" class="w-32 h-32 rounded-xl object-cover border-4 border-white dark:border-slate-700 shadow-md" alt="Preview">
                         <label for="vehiclePhotoFile" class="text-xs text-blue-600 dark:text-blue-400 hover:underline cursor-pointer font-bold">Change Photo</label>
                         <input type="file" id="vehiclePhotoFile" class="file-input" accept="image/*">
                    </div>
                    
                    <div class="flex-1 space-y-5">
                         <div>
                             <label for="vehicleNumber" class="block mb-1.5 text-xs font-bold text-slate-700 dark:text-slate-400 uppercase">Vehicle Number</label>
                             <input type="text" id="vehicleNumber" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-medium" required>
                         </div>
                         <div>
                            <label for="vehicleModel" class="block mb-1.5 text-xs font-bold text-slate-700 dark:text-slate-400 uppercase">Model</label>
                            <input type="text" id="vehicleModel" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-medium" required>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <label for="vehicleType" class="block mb-1.5 text-xs font-bold text-slate-700 dark:text-slate-400 uppercase">Vehicle Type</label>
                    <select id="vehicleType" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-medium" required>
                        <option value="" disabled selected>Select a type</option>
                        <option value="Van">Van</option>
                        <option value="Car">Car</option>
                        <option value="Lorry">Lorry</option>
                        <option value="Motorbike">Motorbike</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="flex justify-end gap-3 pt-6 border-t border-slate-100 dark:border-slate-700">
                    <button type="button" id="cancelVehicleModalBtn" class="px-5 py-2.5 rounded-xl bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 text-slate-700 dark:text-white text-sm font-bold transition border border-slate-200 dark:border-slate-600">Cancel</button>
                    <button type="submit" id="submitVehicleBtn" class="px-6 py-2.5 rounded-xl bg-slate-900 dark:bg-blue-600 hover:bg-slate-800 dark:hover:bg-blue-500 text-white text-sm font-bold transition shadow-lg flex items-center">
                        <span id="submitVehicleBtnText">Save Vehicle</span>
                        <div id="submitVehicleSpinner" class="loader ml-2 hidden" style="width: 18px; height: 18px; border-width: 2px;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="expenseModal" class="fixed inset-0 bg-slate-900/50 dark:bg-slate-900/80 backdrop-blur-sm flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-lg transform transition-all scale-95 opacity-0 shadow-2xl border border-slate-100 dark:border-slate-700" id="expense-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="expenseModalTitle" class="text-2xl font-bold text-slate-900 dark:text-white">Add Expense</h3>
                <button id="closeExpenseModalBtn" class="text-slate-500 hover:text-slate-700 dark:hover:text-white transition bg-slate-100 dark:bg-slate-700 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="expenseForm">
                <input type="hidden" id="expenseVehicleId">
                <input type="hidden" id="expenseDocId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                    <div>
                        <label for="expenseType" class="block mb-1.5 text-xs font-bold text-slate-700 dark:text-slate-400 uppercase">Expense Type</label>
                        <select id="expenseType" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-medium" required>
                            <option value="Repair">Repair</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Service">Service</option>
                            <option value="Fuel">Fuel</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="expenseDate" class="block mb-1.5 text-xs font-bold text-slate-700 dark:text-slate-400 uppercase">Date</label>
                        <input type="date" id="expenseDate" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-medium" required>
                    </div>
                </div>

                <div class="mb-5">
                    <label for="expenseDescription" class="block mb-1.5 text-xs font-bold text-slate-700 dark:text-slate-400 uppercase">Description</label>
                    <input type="text" id="expenseDescription" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-medium" required>
                </div>

                <div class="mb-5">
                    <label for="expenseAmount" class="block mb-1.5 text-xs font-bold text-slate-700 dark:text-slate-400 uppercase">Amount (€)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">€</span>
                        <input type="number" step="0.01" min="0" id="expenseAmount" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-slate-900 dark:text-white rounded-xl pl-8 pr-3 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-medium" required>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="expenseBillFile" class="block mb-1.5 text-xs font-bold text-slate-700 dark:text-slate-400 uppercase">Upload Bill/Receipt</label>
                    <div class="flex items-center gap-3">
                        <label for="expenseBillFile" class="file-input-label text-xs py-2 px-4 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 cursor-pointer rounded-lg border border-slate-200 dark:border-slate-600 transition">Choose File</label>
                        <input type="file" id="expenseBillFile" class="file-input" accept="image/*">
                        <span id="expenseBillFileName" class="text-slate-500 dark:text-slate-400 text-xs truncate max-w-[200px] font-medium">No file chosen</span>
                    </div>
                    <a href="#" id="expenseExistingBillLink" target="_blank" class="text-blue-500 dark:text-blue-400 text-xs mt-2 block hidden hover:underline flex items-center gap-1 font-bold"><i data-lucide="link" class="w-3 h-3"></i> View Existing Bill</a>
                </div>

                <div class="mb-8">
                    <label class="flex items-start gap-3 p-4 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-blue-400 dark:hover:border-blue-500 transition">
                        <input type="checkbox" id="isFuturePayment" class="w-5 h-5 text-blue-600 bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded focus:ring-blue-500 mt-0.5">
                        <div>
                             <span class="block text-sm font-bold text-slate-800 dark:text-white">This is a future/scheduled payment</span>
                             <span id="futurePaymentText" class="block text-xs text-slate-500 dark:text-slate-400 mt-1 font-medium">(Won't be added to main expenses until its date)</span>
                        </div>
                    </label>
                </div>

                <div class="flex justify-end gap-3 border-t border-slate-100 dark:border-slate-700 pt-6">
                    <button type="button" id="cancelExpenseModalBtn" class="px-5 py-2.5 rounded-xl bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 text-slate-700 dark:text-white text-sm font-bold transition border border-slate-200 dark:border-slate-600">Cancel</button>
                    <button type="submit" id="submitExpenseBtn" class="px-6 py-2.5 rounded-xl bg-slate-900 dark:bg-blue-600 hover:bg-slate-800 dark:hover:bg-blue-500 text-white text-sm font-bold transition shadow-lg flex items-center">
                        <span id="submitExpenseBtnText">Save Expense</span>
                        <div id="submitExpenseSpinner" class="loader ml-2 hidden" style="width: 18px; height: 18px; border-width: 2px;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="logModal" class="fixed inset-0 bg-slate-900/50 dark:bg-slate-900/80 backdrop-blur-sm flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-4xl transform transition-all scale-95 opacity-0 shadow-2xl border border-slate-100 dark:border-slate-700" id="log-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="logModalTitle" class="text-2xl font-bold text-slate-900 dark:text-white">Expense Log</h3>
                <button id="closeLogModalBtn" class="text-slate-500 hover:text-slate-700 dark:hover:text-white transition bg-slate-100 dark:bg-slate-700 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="max-h-[60vh] overflow-y-auto rounded-xl border border-slate-200 dark:border-slate-700">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-100 dark:bg-slate-900/50 sticky top-0">
                        <tr>
                            <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Date</th>
                            <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Type</th>
                            <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Description</th>
                            <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Bill</th>
                            <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Amount (€)</th>
                            <th class="p-4 text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody" class="divide-y divide-slate-100 dark:divide-slate-700">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="billViewModal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm flex items-center justify-center hidden z-[60] p-4">
         <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-3xl max-h-[90vh] flex flex-col transform transition-all scale-95 opacity-0 shadow-2xl border border-slate-200 dark:border-slate-700" id="bill-view-modal-content">
             <div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 rounded-t-2xl">
                 <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2"><i data-lucide="receipt" class="w-5 h-5 text-blue-500"></i> Bill Viewer</h3>
                 <button id="closeBillViewModalBtn" class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition bg-slate-100 dark:bg-slate-700 p-1 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
             </div>
             <div class="flex-1 overflow-auto flex items-center justify-center bg-slate-50 dark:bg-slate-900/50 rounded-b-2xl p-4">
                 <img id="billImagePreview" src="" class="max-w-full h-auto rounded-lg shadow-lg" alt="Bill Preview">
             </div>
         </div>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 bg-green-500 text-white px-6 py-3 rounded-xl shadow-2xl transform translate-y-24 opacity-0 transition-all duration-500 font-medium flex items-center gap-2 z-[70]">
         <i data-lucide="check-circle" class="w-5 h-5"></i> <p>Toast message!</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc, updateDoc, query, where, getDocs, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
             apiKey: "AIzaSyCkKqLZFM4sm5jdbR1NVhhVy9IhUeDXOWc",
            authDomain: "rsgweb-5f36d.firebaseapp.com",
            projectId: "rsgweb-5f36d",
            storageBucket: "rsgweb-5f36d.firebasestorage.app",
            messagingSenderId: "633023905515",
            appId: "1:633023905515:web:3b1ae3ebc44eefc59748ae",
        };
        
        const IMGBB_API_KEY = "9960ed5927a4c5187a7b6dd2db60ecff";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = null;
        let allVehicles = [];
        let allExpenses = []; // Holds vehicle_expenses

        // Theme & Brightness Logic (From other files)
        const themeToggleBtn = document.getElementById('theme-toggle');
        const brightnessSlider = document.getElementById('brightness-slider');
        const brightnessOverlay = document.getElementById('brightness-overlay');

        function initializeTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            const savedBrightness = localStorage.getItem('brightness') || 0;
            brightnessSlider.value = savedBrightness;
            brightnessOverlay.style.opacity = savedBrightness / 100;
        }
        initializeTheme();

        themeToggleBtn.addEventListener('click', () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        });
        
        brightnessSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            brightnessOverlay.style.opacity = val / 100;
            localStorage.setItem('brightness', val);
        });


        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const signOutBtn = document.getElementById('signOutBtn');
        const userIdSpan = document.getElementById('userId');
        const toast = document.getElementById('toast');
        const vehicleTableBody = document.getElementById('vehicleTableBody');
        const searchByNumber = document.getElementById('searchByNumber');
        const filterType = document.getElementById('filterType');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const totalVehicleExpensesDisplay = document.getElementById('totalVehicleExpensesDisplay'); 
        
        // Vehicle Modal
        const vehicleModal = document.getElementById('vehicleModal');
        const vehicleModalContent = document.getElementById('vehicle-modal-content');
        const vehicleModalTitle = document.getElementById('vehicleModalTitle');
        const addVehicleBtn = document.getElementById('addVehicleBtn');
        const closeVehicleModalBtn = document.getElementById('closeVehicleModalBtn');
        const cancelVehicleModalBtn = document.getElementById('cancelVehicleModalBtn');
        const vehicleForm = document.getElementById('vehicleForm');
        const submitVehicleBtn = document.getElementById('submitVehicleBtn');
        const submitVehicleBtnText = document.getElementById('submitVehicleBtnText');
        const submitVehicleSpinner = document.getElementById('submitVehicleSpinner');
        const vehiclePhotoInput = document.getElementById('vehiclePhotoFile');
        const vehiclePhotoPreview = document.getElementById('vehiclePhotoPreview');

        // Expense Modal
        const expenseModal = document.getElementById('expenseModal');
        const expenseModalContent = document.getElementById('expense-modal-content');
        const expenseModalTitle = document.getElementById('expenseModalTitle');
        const closeExpenseModalBtn = document.getElementById('closeExpenseModalBtn');
        const cancelExpenseModalBtn = document.getElementById('cancelExpenseModalBtn');
        const expenseForm = document.getElementById('expenseForm');
        const expenseTypeSelect = document.getElementById('expenseType'); 
        const futurePaymentText = document.getElementById('futurePaymentText'); 
        const submitExpenseBtn = document.getElementById('submitExpenseBtn');
        const submitExpenseBtnText = document.getElementById('submitExpenseBtnText');
        const submitExpenseSpinner = document.getElementById('submitExpenseSpinner');
        const expenseBillFileInput = document.getElementById('expenseBillFile'); 
        const expenseBillFileNameSpan = document.getElementById('expenseBillFileName'); 
        const expenseExistingBillLink = document.getElementById('expenseExistingBillLink');
        const isFuturePaymentCheckbox = document.getElementById('isFuturePayment');
        
        // Log Modal
        const logModal = document.getElementById('logModal');
        const logModalContent = document.getElementById('log-modal-content');
        const logModalTitle = document.getElementById('logModalTitle');
        const closeLogModalBtn = document.getElementById('closeLogModalBtn');
        const logTableBody = document.getElementById('logTableBody');

        // Bill Viewer Modal
        const billViewModal = document.getElementById('billViewModal');
        const billViewModalContent = document.getElementById('bill-view-modal-content');
        const closeBillViewModalBtn = document.getElementById('closeBillViewModalBtn');
        const billImagePreview = document.getElementById('billImagePreview');

        // --- Auth ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdSpan.textContent = currentUserId.substring(0, 10) + '...';
                appContainer.classList.remove('hidden');
                lucide.createIcons(); // Icons render karanna
                listenForVehicles();
                listenForExpenses(); 
            } else {
                window.location.href = './index.html';
            }
        });
        
        signOutBtn.addEventListener('click', () => signOut(auth));

        // --- Toast & File Upload ---
        const showToast = (message, isSuccess = true) => {
            toast.querySelector('p').textContent = message;
            toast.className = `fixed bottom-8 right-8 text-white px-6 py-3 rounded-xl shadow-2xl transform transition-all duration-500 font-medium flex items-center gap-2 z-[70] ${isSuccess ? 'bg-green-600' : 'bg-red-600'}`;
            toast.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-24', 'opacity-0'), 3000);
        };
        
        const uploadFile = async (file) => {
            if (!file) return null;
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`Upload failed: ${response.statusText}`);
                const result = await response.json();
                if (result.success) return result.data.url;
                throw new Error(result.error?.message || 'Unknown upload error');
            } catch (error) {
                console.error('Error uploading file:', error);
                showToast(`File upload failed: ${error.message}`, false);
                return null;
            }
        };

        // === *** ALUTH HELPER FUNCTION *** ===
        // Array ekak 'in' query limit ekata (30) anuwa kadana function eka
        function chunkArray(arr, size) {
            const chunks = [];
            for (let i = 0; i < arr.length; i += size) {
                chunks.push(arr.slice(i, i + size));
            }
            return chunks;
        }
        // ==================================

        // --- Data Listeners ---
        function listenForVehicles() {
            if(!currentUserId) return;
            onSnapshot(collection(db, `users/${currentUserId}/vehicles`), snapshot => {
                allVehicles = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                applyFiltersAndRender();
            }, error => {
                console.error("Error listening for vehicles:", error);
                showToast("Error loading vehicle data.", false);
            });
        }
        
        async function listenForExpenses() {
             if(!currentUserId) return;
             onSnapshot(collection(db, `users/${currentUserId}/vehicle_expenses`), async (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                await processDueExpenses(); 
                applyFiltersAndRender();
                updateTotalExpensesDisplay(); 
             }, error => {
                 console.error("Error listening for vehicle expenses:", error);
                 showToast("Error loading vehicle expense data.", false);
             });
        }
        
        async function processDueExpenses() {
            if (!allVehicles.length) return; 

            const now = new Date();
            const dueExpenses = allExpenses.filter(e => e.isFuturePayment && e.date?.toDate() <= now);

            if (dueExpenses.length === 0) return; 

            console.log(`Processing ${dueExpenses.length} due vehicle expenses...`);
            
            try {
                const batch = writeBatch(db);
                const transactionsCol = collection(db, `users/${currentUserId}/transactions`);
                let processedCount = 0;

                for (const ex of dueExpenses) {
                    const vehicle = allVehicles.find(v => v.id === ex.vehicleId);
                    const vehicleNumber = vehicle ? vehicle.number : 'Unknown Vehicle';

                    const mainTransactionData = {
                         date: ex.date,
                         description: `Vehicle Expense: ${vehicleNumber} - ${ex.description}`,
                         category: "Vehicle",
                         type: "Expense",
                         amount: ex.amount,
                         paymentMethod: "N/A",
                         vehicleExpenseId: ex.id 
                    };
                    if (ex.billUrl) {
                        mainTransactionData.billUrl = ex.billUrl; 
                    }

                    const newTransactionRef = doc(transactionsCol); 
                    batch.set(newTransactionRef, mainTransactionData);

                    const vehicleExpenseRef = doc(db, `users/${currentUserId}/vehicle_expenses`, ex.id);
                    batch.update(vehicleExpenseRef, { isFuturePayment: false });
                    
                    if (ex.scheduleEventId) {
                         const scheduleRef = doc(db, `users/${currentUserId}/schedule`, ex.scheduleEventId);
                         batch.update(scheduleRef, { status: 'Completed' });
                    }

                    processedCount++;
                }

                await batch.commit(); 
                if (processedCount > 0) {
                     showToast(`Successfully processed ${processedCount} due vehicle payment(s)!`, true);
                }
            } catch (error) {
                 console.error("Error processing due expenses:", error);
                 showToast("Error processing due payments.", false);
            }
        }
        
        function updateTotalExpensesDisplay() {
            const total = allExpenses
                .filter(e => !e.isFuturePayment) 
                .reduce((sum, e) => sum + (e.amount || 0), 0);
            totalVehicleExpensesDisplay.textContent = `€ ${total.toLocaleString()}`;
        }

        // --- Main Table Render & Filter ---
        function applyFiltersAndRender() {
            const searchTerm = searchByNumber.value.toLowerCase();
            const type = filterType.value;
            
            let filteredVehicles = allVehicles;
            if (searchTerm) {
                filteredVehicles = filteredVehicles.filter(v => v.number && v.number.toLowerCase().includes(searchTerm));
            }
            if (type) {
                filteredVehicles = filteredVehicles.filter(v => v.type === type);
            }
            renderVehicleTable(filteredVehicles);
        }
        
        function renderVehicleTable(vehicleList) {
            vehicleTableBody.innerHTML = '';
            if (!vehicleList || vehicleList.length === 0) { 
                vehicleTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-12 text-slate-500 font-medium italic">No vehicles found matching criteria.</td></tr>`;
                return;
            }
            
            vehicleList.forEach(vehicle => {
                const vehicleExpenses = vehicle && vehicle.id 
                    ? allExpenses.filter(e => e.vehicleId === vehicle.id && !e.isFuturePayment) 
                    : [];
                const totalSpent = vehicleExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                
                const row = vehicleTableBody.insertRow();
                row.className = "hover-row border-b border-slate-100 dark:border-slate-700/50 align-middle transition-colors duration-150 group";
                row.innerHTML = `
                    <td class="p-4"><img src="${vehicle.photoUrl || 'https://placehold.co/40x40/f1f5f9/64748b?text=?'}" class="w-10 h-10 rounded-full object-cover ring-2 ring-white dark:ring-slate-700 shadow-sm"></td>
                    <td class="p-4 font-bold text-slate-800 dark:text-white font-mono text-sm">${vehicle.number || 'N/A'}</td>
                    <td class="p-4 text-slate-600 dark:text-slate-400 font-medium text-sm">${vehicle.model || 'N/A'}</td>
                    <td class="p-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700">${vehicle.type || 'N/A'}</span></td>
                    <td class="p-4 font-extrabold text-red-600 dark:text-red-400 text-sm">€ ${totalSpent.toLocaleString()}</td>
                    <td class="p-4 text-right">
                        <div class="flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                           <button data-id="${vehicle.id}" class="edit-vehicle-btn p-2 rounded-lg text-slate-500 hover:text-blue-600 hover:bg-blue-50 dark:text-slate-400 dark:hover:bg-blue-900/20 transition" title="Edit"><i data-lucide="edit" class="w-4 h-4"></i></button>
                           <button data-id="${vehicle.id}" class="delete-vehicle-btn p-2 rounded-lg text-slate-500 hover:text-red-600 hover:bg-red-50 dark:text-slate-400 dark:hover:bg-red-900/20 transition" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                           <button data-id="${vehicle.id}" data-name="${vehicle.number || 'N/A'}" class="view-log-btn p-2 rounded-lg text-slate-500 hover:text-green-600 hover:bg-green-50 dark:text-slate-400 dark:hover:bg-green-900/20 transition" title="Log"><i data-lucide="list" class="w-4 h-4"></i></button>
                           <button data-id="${vehicle.id}" data-name="${vehicle.number || 'N/A'}" class="add-expense-btn bg-slate-900 dark:bg-blue-600 hover:bg-slate-800 dark:hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded-lg font-bold transition ml-1 shadow-sm" title="Add Expense">Add Expense</button>
                        </div>
                    </td>
                `;
            });
            lucide.createIcons();
        }
        
        searchByNumber.addEventListener('input', applyFiltersAndRender);
        filterType.addEventListener('change', applyFiltersAndRender);
        clearFiltersBtn.addEventListener('click', () => {
            searchByNumber.value = '';
            filterType.value = '';
            applyFiltersAndRender();
        });

        // --- Vehicle Modal (Add/Edit) ---
        vehiclePhotoInput.addEventListener('change', () => {
            const file = vehiclePhotoInput.files[0];
            if (file) {
                vehiclePhotoPreview.src = URL.createObjectURL(file);
            }
        });

        const openVehicleModal = async (docId = null) => {
            vehicleForm.reset();
            vehiclePhotoPreview.src = 'https://placehold.co/100x100/f1f5f9/64748b?text=Photo';
            document.getElementById('vehicleDocId').value = docId || '';

            if (docId) {
                vehicleModalTitle.textContent = 'Edit Vehicle';
                submitVehicleBtnText.textContent = 'Update Vehicle';
                 try {
                     const docRef = doc(db, `users/${currentUserId}/vehicles`, docId);
                     const docSnap = await getDoc(docRef);
                     if (docSnap.exists()) {
                         const v = docSnap.data();
                         document.getElementById('vehicleNumber').value = v.number || '';
                         document.getElementById('vehicleModel').value = v.model || '';
                         document.getElementById('vehicleType').value = v.type || '';
                         if(v.photoUrl) vehiclePhotoPreview.src = v.photoUrl;
                     } else {
                         showToast("Vehicle not found.", false);
                         return; 
                     }
                 } catch (error) {
                     console.error("Error fetching vehicle for edit:", error);
                     showToast("Error loading vehicle data.", false);
                     return;
                 }
            } else {
                vehicleModalTitle.textContent = 'Add New Vehicle';
                submitVehicleBtnText.textContent = 'Save Vehicle';
            }
            vehicleModal.classList.remove('hidden');
            setTimeout(() => vehicleModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };
        
        const closeVehicleModal = () => {
            vehicleModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => vehicleModal.classList.add('hidden'), 200);
        };
        
        addVehicleBtn.addEventListener('click', () => openVehicleModal());
        closeVehicleModalBtn.addEventListener('click', closeVehicleModal);
        cancelVehicleModalBtn.addEventListener('click', closeVehicleModal);
        vehicleModal.addEventListener('click', (e) => { if(e.target === vehicleModal) closeVehicleModal(); });

        vehicleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUserId) return;
            
            submitVehicleBtn.disabled = true;
            submitVehicleBtnText.classList.add('hidden');
            submitVehicleSpinner.classList.remove('hidden');
            
            try {
                const docId = document.getElementById('vehicleDocId').value;
                const data = {
                    number: document.getElementById('vehicleNumber').value.trim(),
                    model: document.getElementById('vehicleModel').value.trim(),
                    type: document.getElementById('vehicleType').value
                };

                if (!data.number || !data.model || !data.type) {
                     showToast("Please fill all required vehicle details.", false);
                     throw new Error("Missing vehicle details");
                }
                
                const photoFile = vehiclePhotoInput.files[0];
                let existingPhotoUrl = null;
                 if (docId) { 
                     const docSnap = await getDoc(doc(db, `users/${currentUserId}/vehicles`, docId));
                     if (docSnap.exists()) existingPhotoUrl = docSnap.data().photoUrl;
                 }

                if (photoFile) {
                    const photoUrl = await uploadFile(photoFile);
                    if(photoUrl) data.photoUrl = photoUrl;
                     else throw new Error("Photo upload failed"); 
                } else if (docId && existingPhotoUrl) {
                     data.photoUrl = existingPhotoUrl; 
                 } else {
                     delete data.photoUrl; 
                 }

                
                if (docId) {
                    await updateDoc(doc(db, `users/${currentUserId}/vehicles`, docId), data);
                    showToast('Vehicle updated!');
                } else {
                    data.createdAt = new Date();
                    await addDoc(collection(db, `users/${currentUserId}/vehicles`), data);
                    showToast('Vehicle added!');
                }
                closeVehicleModal();
            } catch (error) {
                 if (error.message !== "Missing vehicle details" && error.message !== "Photo upload failed") {
                     showToast(`Error: ${error.message}`, false);
                 }
                console.error("Error saving vehicle:", error);
            } finally {
                submitVehicleBtn.disabled = false;
                submitVehicleBtnText.classList.remove('hidden');
                submitVehicleSpinner.classList.add('hidden');
            }
        });
        
        // --- Expense Modal (Add/Edit) ---
        
        // === ALUTH FUNCTION EKA (Expense Type change weddi text eka wenas karanna) ===
        function updateFuturePaymentText() {
            if (expenseTypeSelect.value === 'Insurance') {
                futurePaymentText.textContent = "(This will create a YEARLY recurring event in the schedule)";
            } else {
                futurePaymentText.textContent = "(Won't be added to main expenses until its date)";
            }
        }
        expenseTypeSelect.addEventListener('change', updateFuturePaymentText);
        isFuturePaymentCheckbox.addEventListener('change', updateFuturePaymentText);
        // === END ALUTH FUNCTION ===


        expenseBillFileInput.addEventListener('change', () => { 
            expenseBillFileNameSpan.textContent = expenseBillFileInput.files[0]?.name || 'No file chosen'; 
            expenseExistingBillLink.classList.add('hidden'); 
            expenseExistingBillLink.href = '#'; 
        });
        
        const openExpenseModal = async (vehicleId, vehicleName, expenseDocId = null) => {
            expenseForm.reset();
            expenseBillFileNameSpan.textContent = 'No file chosen'; 
            expenseExistingBillLink.classList.add('hidden'); 
            expenseExistingBillLink.href = '#'; 
            document.getElementById('expenseVehicleId').value = vehicleId;
            document.getElementById('expenseDocId').value = expenseDocId || '';
            isFuturePaymentCheckbox.checked = false; 
            
            if (expenseDocId) {
                expenseModalTitle.textContent = `Edit Expense for ${vehicleName}`;
                submitExpenseBtnText.textContent = 'Update Expense';
                 try {
                     const docRef = doc(db, `users/${currentUserId}/vehicle_expenses`, expenseDocId);
                     const docSnap = await getDoc(docRef);
                     if (docSnap.exists()) {
                         const ex = docSnap.data();
                         document.getElementById('expenseType').value = ex.type || 'Other';
                         document.getElementById('expenseDate').value = ex.date?.toDate()?.toISOString()?.split('T')[0] || '';
                         document.getElementById('expenseDescription').value = ex.description || '';
                         document.getElementById('expenseAmount').value = ex.amount || 0;
                         isFuturePaymentCheckbox.checked = ex.isFuturePayment || false; 
                         
                         if (ex.billUrl) {
                             expenseBillFileNameSpan.textContent = 'Bill previously uploaded.'; 
                             expenseExistingBillLink.href = ex.billUrl; 
                             expenseExistingBillLink.classList.remove('hidden'); 
                         }
                     } else {
                         showToast("Expense not found.", false);
                         return;
                     }
                 } catch (error) {
                     console.error("Error fetching expense for edit:", error);
                     showToast("Error loading expense data.", false);
                     return;
                 }
            } else {
                expenseModalTitle.textContent = `Add Expense for ${vehicleName}`;
                submitExpenseBtnText.textContent = 'Save Expense';
                document.getElementById('expenseDate').valueAsDate = new Date();
            }
            
            updateFuturePaymentText(); // === ALUTH === Modal open karaddi text eka update karanna
            expenseModal.classList.remove('hidden');
            setTimeout(() => expenseModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };
        
        const closeExpenseModal = () => {
            expenseModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => expenseModal.classList.add('hidden'), 200);
        };
        
        closeExpenseModalBtn.addEventListener('click', closeExpenseModal);
        cancelExpenseModalBtn.addEventListener('click', closeExpenseModal);
        expenseModal.addEventListener('click', (e) => { if(e.target === expenseModal) closeExpenseModal(); });

        // === *** EXPENSE SUBMIT LOGIC SAMPURNENMA WENAS KALA (YEARLY RECURRING) *** ===
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUserId) return;
            
            submitExpenseBtn.disabled = true;
            submitExpenseBtnText.classList.add('hidden');
            submitExpenseSpinner.classList.remove('hidden');
            
            const docId = document.getElementById('expenseDocId').value; // vehicle_expense doc id
            const vehicleId = document.getElementById('expenseVehicleId').value;
            const expenseDate = document.getElementById('expenseDate').value;
            const expenseAmount = parseFloat(document.getElementById('expenseAmount').value);
            const expenseType = document.getElementById('expenseType').value;
            const expenseDescription = document.getElementById('expenseDescription').value.trim();
            const billFile = expenseBillFileInput.files[0];
            const isFuture = isFuturePaymentCheckbox.checked;

             if (!vehicleId || !expenseDate || isNaN(expenseAmount) || expenseAmount < 0 || !expenseType || !expenseDescription) {
                 showToast("Please fill all required expense fields with valid values.", false);
                 submitExpenseBtn.disabled = false;
                 submitExpenseBtnText.classList.remove('hidden');
                 submitExpenseSpinner.classList.add('hidden');
                 return;
             }

            try {
                const vehicle = allVehicles.find(v => v.id === vehicleId);
                const vehicleNumber = vehicle ? vehicle.number : 'Unknown Vehicle';
                const batch = writeBatch(db);

                // --- LOGIC 1: ALUTH, FUTURE, INSURANCE (YEARLY RECURRING) ---
                if (!docId && isFuture && expenseType === 'Insurance') {
                    const recurringId = crypto.randomUUID();
                    const baseDate = new Date(expenseDate);
                    let uploadedBillUrl = null;

                    // Bill eka upload karanne palaweni entry ekata witharai
                    if (billFile) {
                        uploadedBillUrl = await uploadFile(billFile);
                        if (!uploadedBillUrl) throw new Error("Bill upload failed");
                    }

                    for (let i = 0; i < 10; i++) { // Awurudu 10kata add karanna
                        const eventDate = new Date(baseDate);
                        eventDate.setFullYear(baseDate.getFullYear() + i);

                        const newVehicleExpenseRef = doc(collection(db, `users/${currentUserId}/vehicle_expenses`));
                        const newScheduleRef = doc(collection(db, `users/${currentUserId}/schedule`));

                        // 1. Vehicle Expense Data
                        const vehicleExpenseData = {
                            vehicleId: vehicleId,
                            type: expenseType,
                            date: Timestamp.fromDate(eventDate),
                            description: expenseDescription,
                            amount: expenseAmount,
                            isFuturePayment: true,
                            scheduleEventId: newScheduleRef.id,
                            recurringId: recurringId
                        };
                        if (i === 0 && uploadedBillUrl) {
                            vehicleExpenseData.billUrl = uploadedBillUrl; // Add bill only to the first one
                        }

                        // 2. Schedule Event Data
                        const scheduleEventData = {
                            title: `Insurance: ${vehicleNumber}`,
                            description: expenseDescription,
                            date: Timestamp.fromDate(eventDate),
                            color: 'bg-red-500',
                            type: 'Expense',
                            amount: expenseAmount,
                            category: 'Vehicle Insurance',
                            status: 'Pending',
                            vehicleExpenseId: newVehicleExpenseRef.id,
                            recurringId: recurringId
                        };

                        // 3. Batch ekata add karanna
                        batch.set(newVehicleExpenseRef, vehicleExpenseData);
                        batch.set(newScheduleRef, scheduleEventData);
                    }
                    
                    await batch.commit();
                    showToast('Yearly insurance scheduled for 10 years!');
                
                } else {
                    // --- LOGIC 2: ANITH OKKOMA (EDITING or NORMAL ADD) ---
                    
                    // 1. Prepare data
                    const vehicleExpenseData = {
                        vehicleId: vehicleId,
                        type: expenseType,
                        date: Timestamp.fromDate(new Date(expenseDate)),
                        description: expenseDescription,
                        amount: expenseAmount,
                        isFuturePayment: isFuture
                    };
                    
                    // 2. Bill Handle
                    let existingVehicleExpenseUrl = null;
                    let existingScheduleEventId = null; 
                    if (docId) { 
                        const docSnap = await getDoc(doc(db, `users/${currentUserId}/vehicle_expenses`, docId));
                        if (docSnap.exists()) {
                            existingVehicleExpenseUrl = docSnap.data().billUrl;
                            existingScheduleEventId = docSnap.data().scheduleEventId; 
                            vehicleExpenseData.recurringId = docSnap.data().recurringId || null; // recurringId eka thiyaganna
                        }
                    }

                    if (billFile) {
                        const billUrl = await uploadFile(billFile);
                        if (billUrl) {
                            vehicleExpenseData.billUrl = billUrl;
                        } else {
                            throw new Error("Bill upload failed");
                        }
                    } else if (docId && existingVehicleExpenseUrl) {
                        vehicleExpenseData.billUrl = existingVehicleExpenseUrl;
                    } else {
                        delete vehicleExpenseData.billUrl;
                    }
                    
                    // 4. Refs
                    const vehicleExpenseRef = docId 
                        ? doc(db, `users/${currentUserId}/vehicle_expenses`, docId)
                        : doc(collection(db, `users/${currentUserId}/vehicle_expenses`));

                    // 5. Sync Logic (Schedule & Transactions)
                    const transQuery = query(collection(db, `users/${currentUserId}/transactions`), where("vehicleExpenseId", "==", vehicleExpenseRef.id));
                    const transactionSnapshot = await getDocs(transQuery);

                    if (isFuture && expenseType === 'Insurance') {
                        // --- CASE A: Scheduled Insurance ---
                        const scheduleEventData = {
                            title: `Insurance: ${vehicleNumber}`,
                            description: expenseDescription,
                            date: vehicleExpenseData.date,
                            color: 'bg-red-500', 
                            type: 'Expense',
                            amount: vehicleExpenseData.amount,
                            category: 'Vehicle Insurance',
                            status: 'Pending',
                            vehicleExpenseId: vehicleExpenseRef.id,
                            recurringId: vehicleExpenseData.recurringId || null
                        };

                        if (existingScheduleEventId) {
                            const scheduleRef = doc(db, `users/${currentUserId}/schedule`, existingScheduleEventId);
                            batch.update(scheduleRef, scheduleEventData);
                            vehicleExpenseData.scheduleEventId = existingScheduleEventId; 
                        } else {
                            // Me block eka wenna baha aluth logic ekedi, eth fallback ekak widihata thiyagamu
                            const newScheduleRef = doc(collection(db, `users/${currentUserId}/schedule`));
                            batch.set(newScheduleRef, scheduleEventData);
                            vehicleExpenseData.scheduleEventId = newScheduleRef.id; 
                        }
                        transactionSnapshot.forEach(doc => { batch.delete(doc.ref); });

                    } else {
                        // --- CASE B: NOT a Scheduled Insurance ---
                        if (existingScheduleEventId) {
                            const scheduleRef = doc(db, `users/${currentUserId}/schedule`, existingScheduleEventId);
                            batch.delete(scheduleRef);
                            delete vehicleExpenseData.scheduleEventId; 
                        }

                        if (!isFuture) {
                            // Normal expense -> Add/Update transaction
                            const mainTransactionData = {
                                date: vehicleExpenseData.date,
                                description: `Vehicle Expense: ${vehicleNumber} - ${expenseDescription}`,
                                category: "Vehicle",
                                type: "Expense",
                                amount: vehicleExpenseData.amount,
                                paymentMethod: "N/A", 
                                vehicleExpenseId: vehicleExpenseRef.id,
                                billUrl: vehicleExpenseData.billUrl || null
                            };
                            if (!mainTransactionData.billUrl) delete mainTransactionData.billUrl;
                            
                            if (!transactionSnapshot.empty) {
                                batch.update(transactionSnapshot.docs[0].ref, mainTransactionData);
                            } else {
                                const newTransactionRef = doc(collection(db, `users/${currentUserId}/transactions`));
                                batch.set(newTransactionRef, mainTransactionData);
                            }
                        } else {
                            // Future but not insurance -> Delete transaction
                            transactionSnapshot.forEach(doc => { batch.delete(doc.ref); });
                        }
                    }
                    
                    // 6. Save Vehicle Expense
                    if (docId) {
                        batch.update(vehicleExpenseRef, vehicleExpenseData);
                        showToast('Expense updated in all logs!');
                    } else {
                        batch.set(vehicleExpenseRef, vehicleExpenseData);
                        showToast('Expense added to all logs!');
                    }
                    
                    // 7. Commit Batch
                    await batch.commit();
                }

                closeExpenseModal();
                
            } catch (error) {
                 if (error.message !== "Bill upload failed") {
                     showToast(`Error: ${error.message}`, false);
                 }
                console.error("Error saving expense:", error);
            } finally {
                submitExpenseBtn.disabled = false;
                submitExpenseBtnText.classList.remove('hidden');
                submitExpenseSpinner.classList.add('hidden');
            }
        });
        
        // --- View Log Modal (Per Vehicle) ---
        const openLogModal = (vehicleId, vehicleName) => {
            logModalTitle.textContent = `Expense Log for ${vehicleName}`;
            logTableBody.innerHTML = '';
            
            const vehicleExpenses = allExpenses
                .filter(e => e.vehicleId === vehicleId)
                .sort((a,b) => (b.date?.toDate() || 0) - (a.date?.toDate() || 0)); 
            
            if (vehicleExpenses.length === 0) {
                logTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-12 text-slate-500 dark:text-slate-400 italic">No expenses found for this vehicle.</td></tr>`;
            } else {
                vehicleExpenses.forEach(ex => {
                    const row = logTableBody.insertRow();
                    
                    const billHTML = ex.billUrl ? `<button data-url="${ex.billUrl}" class="view-bill-btn bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-blue-600 dark:text-blue-400 text-xs font-bold px-2.5 py-1 rounded-md transition">View Bill</button>` : '<span class="text-slate-400 text-xs italic">None</span>';
                    
                    const typeClass = ex.type === 'Insurance' ? 'font-bold text-blue-600 dark:text-blue-400' : 'text-slate-600 dark:text-slate-300';
                    // === VENAS KALA (Recurring tag) ===
                    const insuranceTag = ex.recurringId ? '<span class="ml-2 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-500 border border-yellow-200 dark:border-yellow-800 text-[10px] font-bold px-1.5 py-0.5 rounded">RECURRING</span>' : (ex.type === 'Insurance' ? '<span class="ml-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 border border-blue-200 dark:border-blue-800 text-[10px] font-bold px-1.5 py-0.5 rounded">INS</span>' : '');
                    const dateString = ex.date && ex.date.toDate ? ex.date.toDate().toLocaleDateString() : 'Invalid Date';

                    const isStillFuture = ex.isFuturePayment && ex.date?.toDate() > new Date(); // Added optional chaining
                    const futureRowClass = isStillFuture ? 'future-payment-row' : '';
                    const futureTag = isStillFuture ? '<span class="ml-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 border border-purple-200 dark:border-purple-800 text-[10px] font-bold px-1.5 py-0.5 rounded">SCHEDULED</span>' : '';
                    
                    row.className = `border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition ${futureRowClass}`;

                    row.innerHTML = `
                        <td class="p-4 text-slate-700 dark:text-slate-300 text-sm font-medium">${dateString} ${futureTag}</td>
                        <td class="p-4 text-sm ${typeClass}">${ex.type || 'N/A'} ${insuranceTag}</td>
                        <td class="p-4 text-slate-600 dark:text-slate-400 text-sm">${ex.description || 'N/A'}</td>
                        <td class="p-4">${billHTML}</td>
                        <td class="p-4 font-bold text-slate-800 dark:text-white text-sm">€ ${(ex.amount || 0).toLocaleString()}</td>
                        <td class="p-4 flex gap-2">
                            <button data-id="${ex.id}" data-vid="${vehicleId}" data-vname="${vehicleName}" class="edit-expense-btn text-slate-400 hover:text-blue-500 transition p-1"><i data-lucide="edit" class="w-4 h-4"></i></button>
                            <button data-id="${ex.id}" class="delete-expense-btn text-slate-400 hover:text-red-500 transition p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    `;
                });
            }
            logModal.classList.remove('hidden');
            setTimeout(() => logModalContent.classList.remove('scale-95', 'opacity-0'), 10);
            lucide.createIcons();
        };

        const closeLogModal = () => {
            logModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => logModal.classList.add('hidden'), 200);
        };
        closeLogModalBtn.addEventListener('click', closeLogModal);


        // --- Bill Viewer Modal ---
        const openBillViewModal = (url) => {
            if (!url) return; 
            billImagePreview.src = url;
            billViewModal.classList.remove('hidden');
            setTimeout(() => billViewModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        };
        const closeBillViewModal = () => {
            billViewModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                billViewModal.classList.add('hidden');
                billImagePreview.src = '';
            }, 200);
        };
        closeBillViewModalBtn.addEventListener('click', closeBillViewModal);
        billViewModal.addEventListener('click', (e) => { if (e.target === billViewModal) closeBillViewModal(); });

        // --- Event Delegation for Tables ---
        vehicleTableBody.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-vehicle-btn');
            if (editBtn) openVehicleModal(editBtn.dataset.id);
            
            const deleteBtn = e.target.closest('.delete-vehicle-btn');
            if (deleteBtn) deleteVehicle(deleteBtn.dataset.id);
            
            const logBtn = e.target.closest('.view-log-btn');
            if (logBtn) openLogModal(logBtn.dataset.id, logBtn.dataset.name);
            
            const expenseBtn = e.target.closest('.add-expense-btn');
            if (expenseBtn) openExpenseModal(expenseBtn.dataset.id, expenseBtn.dataset.name);
        });
        
        logTableBody.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-expense-btn');
            if (editBtn) {
                openExpenseModal(editBtn.dataset.vid, editBtn.dataset.vname, editBtn.dataset.id);
            }
            const deleteBtn = e.target.closest('.delete-expense-btn');
            if (deleteBtn) deleteExpense(deleteBtn.dataset.id);

            const billBtn = e.target.closest('.view-bill-btn');
            if(billBtn) openBillViewModal(billBtn.dataset.url);
        });
        
        // --- Delete Functions ---
        
        // === *** DELETE VEHICLE FUNCTION EKA HADUWA *** ===
        async function deleteVehicle(docId) {
             if (!docId) return; 
             if (confirm('Are you sure you want to delete this vehicle? This will also delete ALL its expenses from ALL logs (Expenses, Transactions, and Schedule)!')) {
                 try {
                     const batch = writeBatch(db); 
                     
                     // 1. Vehicle ekata adala expenses serama ganna
                     const qExpenses = query(collection(db, `users/${currentUserId}/vehicle_expenses`), where("vehicleId", "==", docId));
                     const expenseSnapshot = await getDocs(qExpenses);
                     const expenseIds = [];
                     
                     // 2. E ekk ekk expense ekak haraha gihin eke schedule eka delete karanna
                     // --- RENAME loop variable ---
                     expenseSnapshot.forEach(expenseDoc => { // Renamed from 'doc' to 'expenseDoc'
                         const expenseData = expenseDoc.data();
                         
                         if (expenseData && expenseData.scheduleEventId) {
                            // Now the imported 'doc' function is definitely used
                             batch.delete(doc(db, `users/${currentUserId}/schedule`, expenseData.scheduleEventId));
                         }
                         expenseIds.push(expenseDoc.id); // expense ID eka array ekata da ganna
                         batch.delete(expenseDoc.ref); // expense eka delete karanna batch ekata danna
                     });

                     // 3. Transactions delete kirima (Chunking method eken)
                     if (expenseIds.length > 0) {
                        // Firebase 'in' query eke limit eka 30.
                        // E nisa expenseIds kiyana serama tika 30 gane kadala queries karanna.
                        const idChunks = chunkArray(expenseIds, 30);
                        
                        // Ek ek 'chunk' ekak haraha gihin query karanna
                        for (const chunk of idChunks) {
                            const qTransactions = query(collection(db, `users/${currentUserId}/transactions`), where("vehicleExpenseId", "in", chunk));
                            const transactionSnapshot = await getDocs(qTransactions); // me query eka await karanna ona
                            // --- RENAME loop variable ---
                            transactionSnapshot.forEach(transDoc => { // Renamed from 'doc' to 'transDoc'
                                batch.delete(transDoc.ref); 
                            });
                        }
                     }
                     
                     // 4. Anthimata vehicle eka delete karanna
                     batch.delete(doc(db, `users/${currentUserId}/vehicles`, docId));
                     
                     // 5. Serama delete tika ekapara commit karanna
                     await batch.commit(); 
                     showToast('Vehicle and all associated records deleted from all logs.');
                 } catch (error) {
                     showToast(`Error: ${error.message}`, false);
                     console.error("Error deleting vehicle and expenses:", error);
                 }
             }
        }
        
        // === *** DELETE EXPENSE LOGIC EKA SAMPURNENMA WENAS KALA (RECURRING) *** ===
        async function deleteExpense(docId) { // docId is from vehicle_expenses
             if (!docId) return; 
             
             try {
                const vehicleExpenseRef = doc(db, `users/${currentUserId}/vehicle_expenses`, docId);
                const vehicleExpenseSnap = await getDoc(vehicleExpenseRef);
                if (!vehicleExpenseSnap.exists()) {
                    showToast("Expense not found.", false);
                    return;
                }
                const vehicleExpenseData = vehicleExpenseSnap.data();
                const recurringId = vehicleExpenseData.recurringId;
                
                let deleteFuture = false;
                let deleteOne = false;

                if (recurringId) {
                    if (confirm('This is a RECURRING expense. Do you want to delete ALL future entries as well? \n\n (Press OK for all, Cancel to delete only this one.)')) {
                        deleteFuture = true;
                    } else if (confirm('Delete ONLY this single entry?')) {
                        deleteOne = true;
                    } else {
                        return; // User cancelled everything
                    }
                } else {
                     if (confirm('Are you sure you want to delete this expense entry from all logs (Expenses, Transactions, and Schedule)?')) {
                        deleteOne = true;
                    } else {
                        return; // User cancelled
                    }
                }

                const batch = writeBatch(db);

                if (deleteFuture) {
                    // --- LOGIC 1: Delete all future recurring ---
                    const qExpenses = query(collection(db, `users/${currentUserId}/vehicle_expenses`), 
                        where("recurringId", "==", recurringId), 
                        where("date", ">=", vehicleExpenseData.date) // This one and all future
                    );
                    const expenseSnapshot = await getDocs(qExpenses);
                    
                    for (const expenseDoc of expenseSnapshot.docs) {
                        const exData = expenseDoc.data();
                        // Delete schedule event
                        if (exData && exData.scheduleEventId) { 
                            batch.delete(doc(db, `users/${currentUserId}/schedule`, exData.scheduleEventId));
                        }
                        // Delete transaction (if any)
                        const qTrans = query(collection(db, `users/${currentUserId}/transactions`), where("vehicleExpenseId", "==", expenseDoc.id));
                        const transSnapshot = await getDocs(qTrans);
                        // --- RENAME loop variable ---
                        transSnapshot.forEach(tDoc => batch.delete(tDoc.ref));
                        // Delete vehicle expense
                        batch.delete(expenseDoc.ref);
                    }
                    await batch.commit();
                    showToast('All future recurring expenses deleted.');

                } else if (deleteOne) {
                    // --- LOGIC 2: Delete only this single entry ---
                    const q = query(collection(db, `users/${currentUserId}/transactions`), where("vehicleExpenseId", "==", docId));
                    const transactionSnapshot = await getDocs(q);
                    // --- RENAME loop variable ---
                    transactionSnapshot.forEach(transactionDoc => {
                        batch.delete(transactionDoc.ref);
                    });

                    if (vehicleExpenseData && vehicleExpenseData.scheduleEventId) { 
                        const scheduleRef = doc(db, `users/${currentUserId}/schedule`, vehicleExpenseData.scheduleEventId);
                        batch.delete(scheduleRef);
                    }
                    batch.delete(vehicleExpenseRef);
                    
                    await batch.commit(); 
                    showToast('Single expense entry deleted from all logs.');
                }
                
                // Refresh log modal if it's open
                if (!logModal.classList.contains('hidden')) {
                    const logVehicleId = vehicleExpenseData.vehicleId;
                    if(logVehicleId) {
                        const vehicleRef = doc(db, `users/${currentUserId}/vehicles`, logVehicleId);
                        const vehicleSnap = await getDoc(vehicleRef);
                        const vehicleName = vehicleSnap.exists() ? vehicleSnap.data().number : 'Vehicle';
                        openLogModal(logVehicleId, vehicleName); // Refresh modal
                    } else {
                        closeLogModal(); 
                    }
                }

             } catch (error) {
                 showToast(`Error deleting expense: ${error.message}`, false);
                 console.error("Error deleting expense:", error);
             }
        }
    </script>
</body>
</html>